# 文档规范

## 文档类型

| 类型 | 目录 | 用途 |
|------|------|------|
| PRD | `docs/prd/` | 产品需求文档 |
| 设计文档 | `docs/design/` | 技术设计文档 |
| API 文档 | `docs/api/` | 接口文档 |
| 部署文档 | `docs/deployment/` | 部署指南 |
| 变更日志 | `docs/changelog/` | 版本记录 |

## PRD 文档模板

### 文件命名
```
v{版本号}-{功能名称}.md
例: v1.0-mvp.md, v1.1-data-analysis.md
```

### PRD 模板
```markdown
# PRD: {功能名称}

## 文档信息
| 项目 | 内容 |
|------|------|
| 版本 | v1.0 |
| 作者 | 产品经理姓名 |
| 创建日期 | 2025-01-20 |
| 状态 | 草稿/评审中/已确认/已发布 |

## 修订历史
| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| 0.1 | 2025-01-20 | PM | 初稿 |

---

## 1. 背景与目标

### 1.1 背景
描述为什么需要这个功能，解决什么问题。

### 1.2 目标
- 业务目标
- 用户目标
- 技术目标

### 1.3 成功指标
| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| DAU | - | 1000 |
| 转化率 | - | 10% |

---

## 2. 用户故事

### 2.1 目标用户
描述目标用户画像。

### 2.2 用户故事
**作为** [用户角色]
**我希望** [功能描述]
**以便于** [获得价值]

示例:
- 作为运动员，我希望查看我的历史成绩，以便于了解自己的进步趋势
- 作为运动员，我希望获得 AI 分析建议，以便于优化训练计划

---

## 3. 功能需求

### 3.1 功能列表
| 功能ID | 功能名称 | 优先级 | 状态 |
|--------|----------|--------|------|
| F001 | 运动员搜索 | P0 | 待开发 |
| F002 | 成绩查看 | P0 | 待开发 |
| F003 | AI分析 | P1 | 待开发 |

### 3.2 详细需求

#### F001: 运动员搜索
**描述**: 用户可以通过姓名搜索运动员

**输入**:
- 搜索关键词（必填，1-50字符）

**输出**:
- 运动员列表（姓名、国籍、最佳成绩）

**业务规则**:
1. 支持模糊匹配
2. 最多返回20条结果
3. 按最佳成绩排序

**UI/UX 要求**:
- 搜索框在页面顶部
- 支持实时搜索（防抖300ms）
- 无结果时显示空状态

---

## 4. 非功能需求

### 4.1 性能要求
- 页面加载时间 < 2s
- API 响应时间 < 500ms
- 支持 1000 并发用户

### 4.2 安全要求
- 用户认证
- 数据加密传输

### 4.3 兼容性
- 微信小程序基础库 >= 2.0
- 支持 iOS 10+ / Android 5+

---

## 5. 原型与设计

### 5.1 页面流程
[流程图或链接]

### 5.2 原型图
[Figma/Sketch 链接]

---

## 6. 排期与里程碑

| 阶段 | 时间 | 产出 |
|------|------|------|
| 设计评审 | 2025-01-25 | 设计稿确认 |
| 开发 | 2025-01-26 ~ 02-05 | 功能完成 |
| 测试 | 2025-02-06 ~ 02-10 | 测试通过 |
| 发布 | 2025-02-11 | 上线 |

---

## 7. 风险与依赖

### 7.1 风险
| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 第三方 API 不稳定 | 中 | 增加缓存和降级方案 |

### 7.2 依赖
- 依赖后端 API 开发完成
- 依赖 UI 设计稿

---

## 8. 附录

### 8.1 术语表
| 术语 | 说明 |
|------|------|
| HYROX | 功能性健身比赛 |

### 8.2 参考资料
- [链接1]
- [链接2]
```

## 设计文档模板

```markdown
# 技术设计: {功能名称}

## 文档信息
| 项目 | 内容 |
|------|------|
| 版本 | v1.0 |
| 作者 | 开发者姓名 |
| 创建日期 | 2025-01-20 |
| 关联PRD | v1.0-mvp.md |

## 修订历史
| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|

---

## 1. 概述

### 1.1 背景
简述需求背景和设计目的。

### 1.2 目标
- 设计目标1
- 设计目标2

### 1.3 范围
明确本设计包含和不包含的内容。

---

## 2. 系统架构

### 2.1 整体架构
```
[架构图]
```

### 2.2 模块说明
| 模块 | 职责 | 技术栈 |
|------|------|--------|
| API 层 | 接收请求，参数验证 | FastAPI |
| Service 层 | 业务逻辑处理 | Python |
| Agent 层 | AI 分析能力 | LangChain |

---

## 3. 详细设计

### 3.1 数据模型

#### 3.1.1 ER 图
```
[ER 图]
```

#### 3.1.2 表结构
```sql
CREATE TABLE athletes (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    ...
);
```

### 3.2 接口设计

#### GET /api/v1/athletes

**请求参数**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | int | 否 | 页码 |

**响应示例**
```json
{
    "code": 0,
    "data": []
}
```

### 3.3 流程设计

```
[流程图]
```

---

## 4. 技术方案

### 4.1 方案选型
| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| 方案A | ... | ... | ✅ 采用 |
| 方案B | ... | ... | ❌ 放弃 |

### 4.2 关键实现
```python
# 核心代码示例
```

---

## 5. 非功能设计

### 5.1 性能设计
- 缓存策略
- 并发处理

### 5.2 安全设计
- 认证方式
- 数据加密

### 5.3 监控设计
- 日志记录
- 指标监控

---

## 6. 测试计划

### 6.1 单元测试
| 模块 | 覆盖率目标 |
|------|-----------|
| Service | 80% |

### 6.2 集成测试
- 测试场景1
- 测试场景2

---

## 7. 部署计划

### 7.1 部署步骤
1. 数据库迁移
2. 部署服务
3. 验证

### 7.2 回滚方案
- 回滚步骤

---

## 8. 附录
- 参考资料
```

## CHANGELOG 格式

### 文件: CHANGELOG.md
```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- 待发布的新功能

### Changed
- 待发布的变更

### Fixed
- 待发布的修复

---

## [1.1.0] - 2025-02-01

### Added
- 新增 AI 数据分析功能
- 新增运动员对比功能
- 新增成绩趋势图表

### Changed
- 优化搜索性能
- 更新 UI 设计

### Fixed
- 修复分页显示错误
- 修复时间格式化问题

### Security
- 更新依赖修复安全漏洞

---

## [1.0.0] - 2025-01-15

### Added
- 初始版本发布
- 运动员搜索功能
- 比赛成绩查看
- 微信小程序端
```

### 变更类型说明
| 类型 | 说明 |
|------|------|
| Added | 新增功能 |
| Changed | 功能变更 |
| Deprecated | 即将移除的功能 |
| Removed | 已移除的功能 |
| Fixed | Bug 修复 |
| Security | 安全相关修复 |

## Sprint 记录模板

### 文件: docs/changelog/sprint-01.md
```markdown
# Sprint 01 记录

## Sprint 信息
| 项目 | 内容 |
|------|------|
| 周期 | 2025-01-13 ~ 2025-01-24 |
| 目标 | 完成 MVP 核心功能 |
| 状态 | 进行中 |

## 目标与完成情况

### Sprint 目标
1. [x] 搭建项目基础架构
2. [x] 实现数据获取模块
3. [ ] 完成运动员搜索 API
4. [ ] 完成小程序首页

### 完成情况
| 目标 | 状态 | 完成度 |
|------|------|--------|
| 基础架构 | ✅ 完成 | 100% |
| 数据获取 | ✅ 完成 | 100% |
| 搜索 API | 🔄 进行中 | 60% |
| 小程序首页 | ⏳ 待开始 | 0% |

## 完成的任务

### 后端
- [x] FastAPI 项目初始化
- [x] 数据库模型设计
- [x] 数据获取服务实现

### 前端
- [x] 小程序项目初始化
- [x] 公共组件开发

## 未完成任务

| 任务 | 原因 | 处理 |
|------|------|------|
| 搜索 API | 需求变更 | 移至下个 Sprint |

## 问题与阻碍

| 问题 | 影响 | 解决方案 |
|------|------|----------|
| API 限流 | 数据获取受限 | 增加缓存 |

## 经验总结

### 做得好的
- 架构设计清晰
- 代码审查及时

### 待改进的
- 需求评审需要更充分
- 测试覆盖率需要提高

## 下个 Sprint 计划

### 目标
1. 完成搜索功能
2. 实现 AI 分析基础版
3. 完成小程序核心页面

### 任务列表
- [ ] 搜索 API 优化
- [ ] Agent 基础框架
- [ ] 小程序搜索页
```

## 代码注释规范

### Python Docstring
```python
def get_athlete_stats(
    athlete_id: int,
    season: int | None = None,
    include_details: bool = False,
) -> AthleteStats:
    """
    获取运动员统计数据
    
    根据运动员 ID 获取其比赛统计信息，可选择特定赛季和详情级别。
    
    Args:
        athlete_id: 运动员唯一标识
        season: 赛季编号 (1-8)，不传则统计所有赛季
        include_details: 是否包含各站点详细数据
    
    Returns:
        AthleteStats: 运动员统计数据对象，包含:
            - total_races: 总参赛次数
            - best_time: 最佳成绩
            - avg_time: 平均成绩
            - station_stats: 各站点统计（当 include_details=True）
    
    Raises:
        NotFoundError: 当运动员不存在时
        ValidationError: 当赛季参数无效时
    
    Examples:
        >>> stats = get_athlete_stats(123)
        >>> print(stats.best_time)
        65.5
        
        >>> stats = get_athlete_stats(123, season=7, include_details=True)
        >>> print(stats.station_stats['skierg'])
        4.2
    
    Notes:
        - 成绩单位为分钟
        - 统计数据每小时更新一次
    """
    pass
```

### 类注释
```python
class AnalysisAgent:
    """
    数据分析 Agent
    
    基于 LangChain 构建的 HYROX 数据分析智能体，能够：
    - 分析运动员历史成绩
    - 识别优势和劣势站点
    - 生成训练建议
    
    Attributes:
        llm: 语言模型实例
        tools: 可用工具列表
        memory: 对话记忆
    
    Examples:
        >>> agent = AnalysisAgent()
        >>> result = await agent.run("分析张伟的成绩")
        >>> print(result.output)
    
    See Also:
        - ReportAgent: 报告生成 Agent
        - VisualizationAgent: 可视化 Agent
    """
    pass
```

### 行内注释
```python
def calculate_progress(results: list[RaceResult]) -> float:
    """计算进步幅度"""
    if len(results) < 2:
        return 0.0
    
    # 按日期排序，最新的在前
    sorted_results = sorted(results, key=lambda x: x.date, reverse=True)
    
    # 取最近3场和最早3场的平均值对比
    # 使用3场平均值可以减少单场异常值的影响
    recent_avg = sum(r.total_time for r in sorted_results[:3]) / min(3, len(sorted_results))
    early_avg = sum(r.total_time for r in sorted_results[-3:]) / min(3, len(sorted_results))
    
    # 进步率 = (早期 - 最近) / 早期 * 100
    # 正值表示进步，负值表示退步
    progress = (early_avg - recent_avg) / early_avg * 100
    
    return round(progress, 2)
```

## README 模板

```markdown
# HyroxAgent

HYROX 运动数据分析平台，提供智能数据分析和训练建议。

## 功能特性

- 🔍 **运动员搜索** - 全球运动员数据查询
- 📊 **成绩分析** - 历史成绩趋势分析
- 🤖 **AI 建议** - 智能训练建议生成
- 📱 **小程序** - 微信小程序便捷访问

## 技术栈

- **后端**: Python 3.11, FastAPI, LangChain
- **数据库**: PostgreSQL, Redis
- **前端**: 微信小程序
- **部署**: Docker, 阿里云

## 快速开始

### 环境要求
- Python 3.11+
- PostgreSQL 15+
- Redis 7+

### 安装步骤

1. 克隆仓库
```bash
git clone https://github.com/your-org/hyroxagent.git
cd hyroxagent
```

2. 安装依赖
```bash
cd backend
pip install -r requirements.txt
```

3. 配置环境变量
```bash
cp .env.example .env
# 编辑 .env 填入配置
```

4. 启动服务
```bash
uvicorn app.main:app --reload
```

## 项目结构

```
HyroxAgent/
├── backend/          # 后端服务
├── miniprogram/      # 微信小程序
├── docs/             # 文档
├── deploy/           # 部署配置
└── ...
```

## 开发指南

参见 [开发文档](docs/CONTRIBUTING.md)

## API 文档

- 开发环境: http://localhost:8000/api/docs
- 生产环境: https://api.hyroxagent.com/api/docs

## 贡献

欢迎提交 Issue 和 Pull Request。

## 许可证

MIT License
```

## API 文档规范

### OpenAPI 注释
```python
from fastapi import APIRouter, Query, Path
from pydantic import BaseModel, Field

router = APIRouter()

class AthleteResponse(BaseModel):
    """运动员响应模型"""
    id: int = Field(..., description="运动员ID")
    name: str = Field(..., description="姓名")
    nationality: str = Field(..., description="国籍代码")
    
    class Config:
        json_schema_extra = {
            "example": {
                "id": 1,
                "name": "张伟",
                "nationality": "CHN"
            }
        }

@router.get(
    "/athletes/{athlete_id}",
    response_model=AthleteResponse,
    summary="获取运动员详情",
    description="""
    根据运动员 ID 获取详细信息。
    
    返回信息包括：
    - 基本信息（姓名、国籍等）
    - 比赛统计（参赛次数、最佳成绩等）
    """,
    responses={
        200: {
            "description": "成功获取运动员信息",
            "content": {
                "application/json": {
                    "example": {
                        "code": 0,
                        "data": {"id": 1, "name": "张伟"}
                    }
                }
            }
        },
        404: {
            "description": "运动员不存在"
        }
    },
    tags=["运动员"],
)
async def get_athlete(
    athlete_id: int = Path(..., description="运动员ID", example=123),
):
    """获取运动员详情"""
    pass
```
