# v2.0 本地开发操作手册

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v2.0 |
| 对应 PRD | [v2.0-frontend](../prd/v2.0-frontend.md) |
| 创建日期 | 2026-01-20 |
| 适用环境 | Windows / macOS / Linux |

---

## 1. 环境要求

### 1.1 必需软件

| 软件 | 最低版本 | 推荐版本 | 说明 |
|------|----------|----------|------|
| Python | 3.10 | 3.11+ | 后端运行时 |
| Node.js | 18.0 | 20.0+ | 前端运行时 |
| npm | 9.0 | 10.0+ | 包管理器 |
| Git | 2.30 | 最新 | 版本控制 |

### 1.2 验证安装

```bash
# 验证 Python
python --version
# 期望输出: Python 3.10.x 或更高

# 验证 Node.js
node --version
# 期望输出: v18.x.x 或更高

# 验证 npm
npm --version
# 期望输出: 9.x.x 或更高
```

---

## 2. 项目结构

```
HyroxAgent/
├── backend/                    # 后端代码
│   ├── app/
│   │   ├── main.py            # FastAPI 入口
│   │   ├── api/v1/            # API 路由
│   │   ├── services/          # 业务逻辑
│   │   └── ...
│   └── requirements.txt       # Python 依赖
├── frontend/                   # 前端代码
│   ├── src/
│   │   ├── App.tsx
│   │   ├── screens/
│   │   └── services/api.ts
│   ├── package.json
│   └── vite.config.ts
└── docs/                       # 文档
    ├── prd/
    └── deployment/
```

---

## 3. 后端启动

### 3.1 进入后端目录

```bash
cd backend
```

### 3.2 创建虚拟环境（首次）

**Windows (PowerShell):**
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
```

**Windows (CMD):**
```cmd
python -m venv venv
venv\Scripts\activate.bat
```

**macOS / Linux:**
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3.3 安装依赖

```bash
pip install -r requirements.txt
```

### 3.4 启动后端服务

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3.5 验证后端运行

打开浏览器访问:
- API 文档: http://localhost:8000/docs
- 健康检查: http://localhost:8000/health (如有)

**期望结果**: 看到 Swagger API 文档页面

---

## 4. 前端启动

### 4.1 进入前端目录

打开新的终端窗口：

```bash
cd frontend
```

### 4.2 安装依赖（首次）

```bash
npm install
```

### 4.3 启动开发服务器

```bash
npm run dev
```

### 4.4 验证前端运行

打开浏览器访问:
- 前端应用: http://localhost:5173

**期望结果**: 看到 HYROX Prep Center 应用界面

---

## 5. 验证前后端对接

### 5.1 API 接口测试

#### 测试名称建议接口

```bash
curl "http://localhost:8000/api/v1/athletes/suggest?keyword=chen"
```

**期望响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "suggestions": [
      {"name": "Chen, Yuanmin", "match_count": 3}
    ],
    "total": 1
  }
}
```

#### 测试搜索接口

```bash
curl "http://localhost:8000/api/v1/athletes/search?name=Chen"
```

#### 测试详情接口

```bash
curl "http://localhost:8000/api/v1/results/8/hong-kong/Chen%2C%20Mitch"
```

### 5.2 前端功能测试

1. 打开前端应用 http://localhost:5173
2. 点击搜索框或"立即搜索体验"按钮
3. 输入运动员姓名（如 "chen"）
4. 验证下拉建议列表是否显示
5. 点击某个建议项，验证比赛列表是否显示
6. 点击某条比赛记录，验证详情页是否显示

---

## 6. 开发命令速查

### 6.1 后端命令

| 命令 | 说明 |
|------|------|
| `uvicorn app.main:app --reload` | 启动开发服务器 |
| `pytest` | 运行测试 |
| `pip freeze > requirements.txt` | 导出依赖 |

### 6.2 前端命令

| 命令 | 说明 |
|------|------|
| `npm run dev` | 启动开发服务器 |
| `npm run build` | 构建生产版本 |
| `npm run preview` | 预览构建结果 |

---

## 7. 常见问题排查

### 7.1 后端问题

#### Q: 启动时报 ModuleNotFoundError

**原因**: 未激活虚拟环境或未安装依赖

**解决**:
```bash
# 激活虚拟环境
.\venv\Scripts\Activate.ps1  # Windows
source venv/bin/activate      # macOS/Linux

# 重新安装依赖
pip install -r requirements.txt
```

#### Q: 端口 8000 被占用

**解决**:
```bash
# 使用其他端口
uvicorn app.main:app --reload --port 8001
```

### 7.2 前端问题

#### Q: npm install 报错

**解决**:
```bash
# 清理缓存重试
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

#### Q: 前端无法访问后端 API (CORS 错误)

**原因**: 后端未配置 CORS

**解决**: 确保 `backend/app/main.py` 中已添加 CORS 配置:
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### Q: 搜索无响应

**排查步骤**:
1. 打开浏览器开发者工具 (F12)
2. 切换到 Network 标签
3. 执行搜索操作
4. 检查请求是否发出、响应状态码

---

## 8. 开发工作流

### 8.1 日常开发流程

```
1. 启动后端
   cd backend
   .\venv\Scripts\Activate.ps1
   uvicorn app.main:app --reload

2. 启动前端（新终端）
   cd frontend
   npm run dev

3. 开始开发
   - 修改代码
   - 保存后自动热重载
   - 在浏览器中验证

4. 提交代码
   git add .
   git commit -m "feat: xxx"
```

### 8.2 同时运行前后端

建议使用两个终端窗口分别运行前后端，方便查看各自的日志输出。

**终端 1 (后端)**:
```bash
cd backend
.\venv\Scripts\Activate.ps1
uvicorn app.main:app --reload
```

**终端 2 (前端)**:
```bash
cd frontend
npm run dev
```

---

## 9. 配置说明

### 9.1 后端配置

后端配置通常在 `backend/app/config/settings.py` 中，可通过环境变量覆盖。

### 9.2 前端配置

API 地址配置在 `frontend/src/services/api.ts`:

```typescript
const API_BASE_URL = 'http://localhost:8000/api/v1';
```

如需修改，可创建 `.env` 文件:
```
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

然后在代码中使用:
```typescript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000/api/v1';
```

---

## 10. 附录

### 10.1 端口分配

| 服务 | 端口 | URL |
|------|------|-----|
| 后端 API | 8000 | http://localhost:8000 |
| 前端开发服务器 | 5173 | http://localhost:5173 |

### 10.2 有用的链接

- 后端 API 文档: http://localhost:8000/docs
- 前端应用: http://localhost:5173
- PRD 文档: [v2.0-frontend](../prd/v2.0-frontend.md)
