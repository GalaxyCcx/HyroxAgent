# 第2章解耦图源数据说明

解耦图（心率-配速解耦图）使用的数据来自两类源数据，不再使用 LLM 自由生成的数值。

---

## 一、Run1–8 配速（速度）数据

### 来源

- **数据源**：成绩表（Result）中的 `run1_time` ~ `run8_time`。
- **含义**：每段 1km 跑步的用时，单位是**分钟**（min/km）。
- **计算**：`pace_seconds = run_time * 60`，即每公里秒数（s/km），用于解耦图左 Y 轴。

### 在代码中的路径

1. **DataProvider**（`data_provider.py`）根据 `athlete_result` 的 `run1_time`…`run8_time` 与各功能站时间，构建 `PacingAnalysisData.lap_times`。
2. 每个 **LapTimeData** 含：`lap`（1–8）、`run_time`（分钟/公里）、`station_time`、`lap_time`。
3. **ChartDataBuilder.build_decoupling_data** 使用 `lap_times`，对每段 Run 计算：`pace_seconds = round((lap.run_time or 0) * 60)`。

### 如何查看你报告里的 Run1–8 配速

调用报告详情接口，响应里的 **source_data.run1_8_pace** 即为解耦图使用的配速源数据：

```http
GET /api/v1/reports/detail/{report_id}
```

响应示例（节选）：

```json
{
  "report_id": "...",
  "sections": [...],
  "source_data": {
    "run1_8_pace": [
      { "segment": "Run1", "pace_min_per_km": 4.95, "pace_seconds": 297, "unit_note": "run_time 为分钟/公里（来自成绩表），pace_seconds = run_time * 60" },
      { "segment": "Run2", "pace_min_per_km": 4.92, "pace_seconds": 295, "unit_note": "..." },
      ...
      { "segment": "Run8", "pace_min_per_km": 6.12, "pace_seconds": 367, "unit_note": "..." }
    ],
    "heart_rate_from_image": [...]
  }
}
```

- **pace_min_per_km**：成绩表里的 run 用时（分钟/公里）。
- **pace_seconds**：用于图表的每公里秒数（= pace_min_per_km × 60）。

---

## 二、图片识别出的心率数据

### 来源

- **数据源**：心率图片经 VL 模型提取得到的时序心率。
- **流程**：上传图片 → `HeartRateExtractor.extract_from_image` → 得到 **HeartRateExtractionResult**，其中 **data_points** 为 `{ timestamp_seconds, heart_rate }` 列表。
- **含义**：`timestamp_seconds` 为相对比赛开始的秒数，`heart_rate` 为当时心率（bpm）。

### 在代码中的路径

1. **heart_rate_extractor.py**：从图片解析出 `data_points: List[HeartRateDataPoint]`，每点含 `timestamp_seconds`、`heart_rate`。
2. 报告生成时写入 **heart_rate_data** 快照，并参与 **ChartDataBuilder.build_decoupling_data**：按每段 Run 的起止时间（lap 边界）对该段内所有心率点取**平均**，得到 Run1–Run8 各段一个心率值，用于解耦图右 Y 轴。

### 如何查看你报告里的心率源数据

同样使用报告详情接口，**source_data.heart_rate_from_image** 即为图片识别出的原始心率点（未按 Run 分段）：

```json
"heart_rate_from_image": [
  { "timestamp_seconds": 0,   "heart_rate": 132 },
  { "timestamp_seconds": 15,  "heart_rate": 134 },
  ...
  { "timestamp_seconds": 5144, "heart_rate": 164 }
]
```

- **timestamp_seconds**：相对比赛开始秒数。
- **heart_rate**：该时刻心率（bpm）。  
解耦图里每个 Run 的心率为：该 Run 对应时间区间内这些点的**平均值**。

---

## 三、小结

| 项目 | 来源 | 解耦图中的使用 |
|------|------|------------------|
| Run1–8 配速 | 成绩表 run1_time…run8_time（分钟/公里） | 左 Y 轴：pace_seconds = run_time × 60 |
| Run1–8 心率 | 心率图片 VL 识别 → data_points | 右 Y 轴：每段 Run 时间区间内心率点的平均值 |

查看方式：**GET /api/v1/reports/detail/{report_id}**，在响应中查看 **source_data.run1_8_pace** 和 **source_data.heart_rate_from_image**。
