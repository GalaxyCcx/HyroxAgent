# 「消失 5 分钟」章节 - 时间计算逻辑说明

本文档说明报告中**每一个时间数字**的来源与计算公式，避免混淆。

---

## 一、Run 8 相关时间（你看到的三个数）

| 出现位置 | 显示示例 | 名称 | 计算公式 | 含义 |
|----------|----------|------|----------|------|
| **1.1 损耗总览** | **-1:20** | 时间损耗 / loss_display | `(Run8 用时 − Run1～4 平均用时) × 60` 秒，仅当 > 20 秒才计入 | 相对你自己前 4 段平均，Run 8 多花了多少秒（配速崩盘幅度） |
| **1.1 损耗总览** | **可提升：约 1 分 28 秒** | improvement_display | 由**提升空间 Agent** 给出，且**必须 ≤ 1.2 表格中的「差距」** | 该段建议可争取缩短的时间（不超过与 Top 10% 的差距） |
| **1.2 跑步表格** | **差距 -1:10** | diff | `(你的 Run8 用时 − 同组 Top 10% 该段平均用时) × 60` 秒，格式化为 -M:SS | 你与同组 Top 10% 在该段的秒数差 |
| **1.2 分析卡片** | **提升空间：约 1 分 28 秒** | improvement_display | 与 1.1 同源：Agent 结果，且**必须 ≤ 表格「差距」** | 与 1.1 可提升一致，保证前后统一 |

**重要**：  
- **1:20** = 配速损耗（相对自己前 4 段），与别人无关。  
- **1:10** = 与 Top 10% 的差距，是「可提升」的**上限**（不能写出比这个大的可提升）。  
- **可提升 1:28**：若出现「可提升 > 差距」（如 1:28 > 1:10），属于 bug，后端会对可提升做**上限约束**，不超过表格差距。

---

## 二、Run 5 同理

| 位置 | 显示 | 计算 |
|------|------|------|
| 1.1 时间损耗 | -0:24 | `(Run5 − Run1～4 平均) × 60` 秒 |
| 1.1 可提升 | 约 58 秒 等 | Agent 结果，且 ≤ 1.2 表格 Run 5 的「差距」 |
| 1.2 差距 | 如 -0:21 | `(你的 Run5 − Top 10% Run5) × 60` 秒 |
| 1.2 提升空间 | 与 1.1 可提升一致 | Agent 结果，且 ≤ 表格差距 |

---

## 三、其他时间（总览）

| 项目 | 含义 |
|------|------|
| **理论最佳时间** | 完赛总秒数 − total_loss_seconds，再格式化为 H:MM:SS |
| **总计时间损耗** | 转换区 + 所有配速损耗 + 所有功能站损耗之和，与 1.1 各条 loss_seconds 一致 |
| **功能站损耗**（如 Sled Push -0:26） | 与同组**平均值**或 **TOP25%** 的差距 × 60 秒 |
| **功能站可提升** | Agent 给出的该站可争取时间，≤ 该站损耗 |

---

## 四、数据流小结

| 环节 | 内容 |
|------|------|
| DataProvider | 算 `pacing_losses`（Run5～8 相对前 4 段）、`station_losses`、`transition_loss`，汇总 `total_loss_seconds` |
| DataRegistry | 算 `canonical_loss_items`、`total_loss_display`；1.1 的 loss 数字与此一致 |
| DivisionStats | 各段 `p10`（Top 10% 该段平均用时），用于 1.2 表格「差距」和 Agent 的跑步段上限 |
| Improvement Agent | 按「可提升 ≤ 与 Top 10% 差距」给出跑步段可提升与理由；功能站/转换区 ≤ 损耗 |
| 后处理 | 用 Agent 结果覆盖 1.1/1.2 的 improvement_display，并用**表格差距**做上限，保证可提升 ≤ 差距 |

---

## 五、已实施的约束

1. **1.1 损耗数字**：与后端 `canonical_loss_items`、`total_loss_display` 严格一致。  
2. **跑步段可提升**：Agent 与后处理均约束为 **≤ 该段与 Top 10% 的差距**；若 Agent 或 LLM 写出更大值，后处理会用表格「差距」截断。  
3. **1.1 与 1.2 可提升**：同一段（如 Run 8）在 1.1 与 1.2 的「可提升」来自同一份 Agent 结果，并同时受表格差距上限约束。  
4. **1.2「与 Top 10% 的差距」固定**：该数据由后端根据 **athlete_result** 与 **division_stats.runX_time.p10** 预计算，写入 **running_vs_top10_table**；1.2 跑步表格的 you、top10、diff **必须照抄**该表，且后处理会再次用该表覆盖 LLM 输出。同一份数据（同一场次、同一运动员、同一组别）每次报告的「差距」一致，不会因 LLM 改写或误用「平均值」而变成 2:20 等错误值。
