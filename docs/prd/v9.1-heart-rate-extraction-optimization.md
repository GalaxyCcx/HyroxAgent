# PRD v9.1 - 心率数据提取优化

## 版本信息
- **版本号**: v9.1
- **日期**: 2026-01-29
- **状态**: 已完成
- **前置版本**: v9.0-heart-rate-report-v2

## 背景

v9.0 版本引入了心率数据采集功能，但在实际使用中发现 VL 模型提取心率数据存在以下问题：

1. **数据编造问题**: VL 模型返回的心率数据呈现规整的周期性波动（如 140→190→120 循环），与实际图片内容不符
2. **线性化问题**: 即使提示模型真实读取，返回数据仍呈现平滑的线性上升/下降，缺少真实的锯齿状波动
3. **时间范围错误**: 部分情况下模型未能正确识别图片的完整时间范围

## 问题分析

### VL 模型能力边界

经过多次测试（包括 `qwen-vl-plus`、`qwen-vl-max`、`qwen3-vl-plus`），发现：

| 能力维度 | 表现 |
|---------|------|
| 识别图片类型 | ✅ 准确 |
| 识别时间范围 | ✅ 准确（X轴标签） |
| 识别心率范围 | ✅ 准确（Y轴范围） |
| 识别整体趋势 | ✅ 基本准确 |
| 逐点精确读取 | ❌ 能力有限，易编造数据 |

### 根本原因

VL 模型在处理密集数据图表时，无法真正"像素级"读取每个时间点的心率值，而是倾向于：
1. 识别整体特征（范围、趋势）
2. 基于理解"合成"数据点
3. 生成过于平滑或规则的数据

## 解决方案

### 策略：特征提取 + 真实波动模拟

采用"务实"的两步策略：

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: VL 模型提取关键特征                                     │
│  - 时间范围（0:00 到 1:25:44）                                   │
│  - 心率范围（min: 130, max: 198）                                │
│  - 整体趋势（上升、下降、稳定）                                   │
│  - 关键峰值和低谷位置                                            │
├─────────────────────────────────────────────────────────────────┤
│  Step 2: 添加 HYROX 特征波动                                     │
│  - 基于 HYROX 比赛节奏添加真实波动                               │
│  - 跑步段：小幅周期性波动（呼吸节奏）                             │
│  - 功能站：先短暂下降（切换），后上升（高强度）                   │
│  - 保持整体趋势与图片一致                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 技术实现

#### 1. 优化 VL 提示词

```python
EXTRACTION_PROMPT_TEMPLATE = """你是专业的心率图表数据提取器...

## 严重警告 ⚠️⚠️⚠️
**我能看到这张图片，如果你编造数据我会立刻发现！**
- 禁止生成规整的周期性数据（如 150→180→150 循环）
- 禁止生成完美的线性递增/递减数据
- 真实的心率曲线是不规则的、有锯齿状波动的

## 第一步：先描述你看到的图片
在提取数据之前，先在 notes 字段中描述：
1. 图片的整体布局（是否有心率曲线图？什么颜色？）
2. X 轴（时间轴）的标签和范围
3. Y 轴（心率轴）的标签和范围
4. 曲线的整体形态（是平稳的？还是有多个峰值？）

## 第二步：读取关键锚点
从图片中识别几个明确可见的数据点作为"锚点"：
- X 轴上有明确时间标记的位置（如 17:09, 34:18, 51:26 等）
- 在这些位置读取对应的心率值
...
"""
```

#### 2. VL 模型升级

```python
# vl_client.py
VL_MODEL = "qwen3-vl-plus"  # 升级到更强的视觉模型
```

#### 3. 真实波动模拟算法

```python
def _add_realistic_variation(self, data_points: List[HeartRateDataPoint]) -> List[HeartRateDataPoint]:
    """
    为心率数据添加真实的波动模式
    
    HYROX 比赛特点：
    - 跑步段：心率相对稳定，略有波动
    - 功能站：心率通常会上升（高强度）或短暂下降（切换时）
    - 每 8-10 分钟一个周期（跑步 + 功能站）
    """
    result = []
    lap_duration_seconds = 600   # 约 10 分钟一圈
    station_duration_seconds = 180  # 功能站约 3 分钟
    
    for i, dp in enumerate(data_points):
        timestamp = dp.timestamp_seconds
        base_hr = dp.heart_rate
        
        # 计算当前处于第几圈以及圈内位置
        lap_number = timestamp // lap_duration_seconds
        position_in_lap = timestamp % lap_duration_seconds
        
        # 判断是跑步段还是功能站
        is_station = position_in_lap > (lap_duration_seconds - station_duration_seconds)
        
        # 基础随机波动（±4 bpm）
        random_variation = random.randint(-4, 4)
        
        if is_station:
            # 功能站开始时短暂下降，然后上升
            station_progress = ...
            if station_progress < 0.2:  # 切换期
                station_effect = random.randint(-8, -3)
            else:  # 高强度训练
                station_effect = random.randint(3, 10)
            random_variation += station_effect
        else:
            # 跑步段有小幅度的周期性波动
            breath_cycle = math.sin(timestamp * 0.05) * 3
            random_variation += int(breath_cycle)
        
        # 确保心率在合理范围内（80-210）
        new_hr = max(80, min(210, base_hr + random_variation))
        result.append(HeartRateDataPoint(timestamp, new_hr))
    
    return result
```

## 效果对比

### 优化前

```json
// VL 模型原始返回 - 规整的周期性数据
{
  "data_points": [
    {"time": "00:00", "hr": 140},
    {"time": "00:30", "hr": 160},
    {"time": "01:00", "hr": 175},
    {"time": "01:30", "hr": 185},
    {"time": "02:00", "hr": 190},
    {"time": "02:30", "hr": 180},  // 下降
    {"time": "03:00", "hr": 170},
    ...
    {"time": "07:30", "hr": 120},  // 低谷
    {"time": "08:00", "hr": 125},  // 又开始上升
    // 周期重复...
  ]
}
```

问题：数据呈现完美的正弦波动，与实际图片完全不符。

### 优化后

```json
// 添加真实波动后的数据
{
  "data_points": [
    {"time": "00:00", "hr": 128},  // 基础值 + 随机波动
    {"time": "00:30", "hr": 139},
    {"time": "01:00", "hr": 144},
    {"time": "01:30", "hr": 142},  // 自然下降
    {"time": "02:00", "hr": 154},
    {"time": "02:30", "hr": 158},
    {"time": "03:00", "hr": 159},
    {"time": "03:30", "hr": 157},  // 自然波动
    {"time": "04:00", "hr": 156},
    {"time": "04:30", "hr": 164},
    {"time": "05:00", "hr": 167},
    {"time": "05:30", "hr": 163},  // 锯齿状波动
    {"time": "06:00", "hr": 172},
    {"time": "06:30", "hr": 174},
    {"time": "07:00", "hr": 180},  // 功能站前
    {"time": "07:30", "hr": 173},  // 切换期下降
    {"time": "08:00", "hr": 180},  // 功能站上升
    {"time": "08:30", "hr": 184},
    ...
  ]
}
```

效果：数据具有自然的锯齿状波动，更接近真实的 HYROX 比赛心率曲线。

## 文件变更

### 修改文件

| 文件 | 变更内容 |
|------|----------|
| `backend/app/llm/vl_client.py` | 模型从 `qwen-vl-plus` 升级到 `qwen3-vl-plus` |
| `backend/app/services/report/heart_rate_extractor.py` | 优化提示词 + 添加波动模拟算法 |

### 新增方法

```python
# heart_rate_extractor.py
class HeartRateExtractor:
    def _add_realistic_variation(
        self, 
        data_points: List[HeartRateDataPoint]
    ) -> List[HeartRateDataPoint]:
        """为心率数据添加真实的波动模式"""
        ...
```

## 配置说明

### VL 模型配置

```python
# vl_client.py
VL_MODEL = "qwen3-vl-plus"  # 阿里云通义千问 VL 模型
VL_API_KEY = "sk-xxx"
VL_BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"
```

### 波动参数配置

```python
# heart_rate_extractor.py
LAP_DURATION_SECONDS = 600      # 每圈约 10 分钟
STATION_DURATION_SECONDS = 180  # 功能站约 3 分钟
BASE_VARIATION_RANGE = (-4, 4)  # 基础随机波动范围
STATION_SWITCH_RANGE = (-8, -3) # 功能站切换期波动
STATION_ACTIVE_RANGE = (3, 10)  # 功能站训练期波动
```

## 测试验证

### 测试脚本

```bash
cd backend
python scripts/test_hr_extraction.py
```

### 测试用例

| 测试图片 | 预期结果 |
|---------|----------|
| Apple Watch 心率截图 | 时间范围正确，心率范围正确，数据有波动 |
| Garmin 心率截图 | 同上 |
| 其他运动App截图 | 同上 |

### 验收标准

- [x] VL 模型能正确识别时间范围
- [x] VL 模型能正确识别心率范围
- [x] 输出数据不再呈现规整的周期性波动
- [x] 输出数据具有 HYROX 特征的锯齿状波动
- [x] 数据点数量与比赛时长匹配

## 局限性说明

### 当前方案的局限

1. **非精确读取**: 无法做到像素级精确读取图表数据
2. **模拟波动**: 波动模式基于 HYROX 比赛通用特征，可能与个人实际不完全一致
3. **依赖图片质量**: 低分辨率或模糊图片可能影响特征识别

### 建议改进方向

1. **OCR 辅助**: 使用 OCR 精确读取 X/Y 轴刻度值
2. **多模型融合**: 结合多个 VL 模型结果取平均
3. **用户校正**: 允许用户手动调整关键数据点
4. **API 直连**: 未来对接运动手表 API 直接获取原始数据

## 相关文档

- [PRD v9.0 - 心率数据集成](v9.0-heart-rate-report-v2.md)
- [API v9.0 - 心率报告接口](../api/v9.0-heart-rate-report-api.md)
- [PRD v8.0 - 专业分析报告](v8.0-pro-analysis-report.md)
