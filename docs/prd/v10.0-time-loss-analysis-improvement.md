# PRD v10.0 - 时间损耗分析功能优化

## 版本信息
- **版本号**: v10.0
- **日期**: 2026-01-29
- **状态**: 已完成
- **关联版本**: v8.0 (专业分析报告)

## 背景

在专业分析报告的第2章"消失的五分钟"中，时间损耗分析功能存在以下问题：

1. **数据计算不完整**：只识别出一个损耗项（Run 8配速崩盘），无法全面反映运动员的时间损耗情况
2. **可视化效果差**：
   - 总计柱子高度为0，几乎不可见
   - 每个柱子都有绿色的0标签，造成视觉混乱
   - 瀑布图效果不明显，无法清晰展示累计损耗

## 问题分析

### 数据计算问题
1. **转换区损耗**：数据源中转换区时间为0，无法计算
2. **功能站损耗**：原逻辑只与TOP25%比较，当运动员表现优于TOP25%但低于平均值时，无法识别损耗
3. **配速损耗**：只计算Run8，忽略了Run5-Run7的配速问题
4. **阈值过高**：功能站阈值10秒、配速阈值30秒，可能遗漏较小的损耗项

### 可视化问题
1. **总计柱子**：从累计值开始，高度为0，在深色背景下几乎不可见
2. **标签混乱**：辅助系列和节省系列的0值标签都显示出来，造成视觉干扰
3. **视觉层次不清**：总计列没有特殊样式，无法突出显示

## 功能概述

### 目标
1. **完善数据计算逻辑**：识别更多时间损耗项，提供更全面的分析
2. **优化可视化效果**：改进瀑布图显示，清晰展示累计损耗和总计

### 改进内容

#### 1. 数据计算逻辑优化

**功能站损耗计算改进**：
- **原逻辑**：只与TOP25%比较，阈值10秒
- **新逻辑**：
  - 同时与平均值（avg）和TOP25%比较
  - 优先使用平均值差距（更符合实际改进空间）
  - 阈值降低到5秒，捕捉更多损耗项
  - 即使表现优于TOP25%，如果低于平均值也会计入损耗

**配速损耗计算改进**：
- **原逻辑**：只计算Run8 vs 前4段平均，阈值30秒
- **新逻辑**：
  - 计算Run5、Run6、Run7、Run8相对于前4段平均的差距
  - 阈值降低到20秒
  - 选择最严重的一段作为主要损耗，并在描述中说明其他有损耗的段

#### 2. 瀑布图可视化优化

**总计柱子改进**：
- **原逻辑**：从累计值开始，高度为0（作为标记点）
- **新逻辑**：
  - 从0开始，高度为总损耗
  - 使用紫色渐变（#9333ea → #c084fc）
  - 添加2px边框，清晰可见
  - 标签显示"总计\nXXs"，使用紫色、加粗、11px字体

**标签显示优化**：
- 隐藏"节省"系列的标签（`show: false`）
- 禁用辅助系列的标签和交互（`silent: true`）
- 只在有损耗值的地方显示标签
- 总计列标签使用特殊样式（紫色、加粗、稍大字体）

**X轴标签优化**：
- 总计列使用紫色和加粗，突出显示
- 其他列保持原有样式

**Tooltip优化**：
- 只显示"损耗"系列的信息
- 总计列tooltip使用紫色主题，显示"累计总损耗"
- 避免显示无用的0值

## 功能需求

### FR-1: 数据计算逻辑改进

**优先级**: P0

**需求描述**：
1. 功能站损耗应同时与平均值和TOP25%比较，优先使用平均值
2. 配速损耗应计算Run5-Run8，而不仅仅是Run8
3. 降低阈值：功能站5秒，配速20秒

**验收标准**：
- [ ] 功能站损耗能识别出低于平均值但优于TOP25%的情况
- [ ] 配速损耗能识别出Run5-Run7的配速问题
- [ ] 至少能识别出2-3个损耗项（不包括转换区）

### FR-2: 瀑布图可视化改进

**优先级**: P0

**需求描述**：
1. 总计柱子从0开始，高度为总损耗，清晰可见
2. 移除所有绿色的0标签
3. 总计列在X轴上突出显示（紫色、加粗）

**验收标准**：
- [ ] 总计柱子清晰可见，高度等于总损耗
- [ ] 没有绿色的0标签显示
- [ ] 总计列在X轴上使用紫色和加粗
- [ ] 每个损耗项的标签正确显示，没有多余的0

### FR-3: Tooltip和交互优化

**优先级**: P1

**需求描述**：
1. Tooltip只显示有用的信息，避免显示0值
2. 总计列tooltip使用特殊样式
3. 辅助系列和节省系列不显示tooltip

**验收标准**：
- [ ] Tooltip只显示"损耗"系列的信息
- [ ] 总计列tooltip显示"累计总损耗"
- [ ] 鼠标悬停在辅助系列上不显示tooltip

## 技术实现

### 后端变更

**文件**: `backend/app/services/report/data_provider.py`

**主要变更**：
1. `_calculate_time_loss_analysis` 方法：
   - 功能站损耗计算逻辑改进（与平均值比较）
   - 配速损耗计算逻辑改进（Run5-Run8）
   - 阈值调整（功能站5秒，配速20秒）

### 前端变更

**文件**: `frontend/src/components/charts/TimeLossWaterfall.tsx`

**主要变更**：
1. 总计柱子构建逻辑：
   - 从0开始，高度为总损耗
   - 使用紫色渐变和边框
2. 标签显示逻辑：
   - 隐藏节省系列标签
   - 禁用辅助系列标签和交互
   - 总计列标签特殊样式
3. X轴标签样式：
   - 总计列使用紫色和加粗
4. Tooltip优化：
   - 只显示损耗系列信息
   - 总计列特殊样式

## 用户体验改进

### 改进前
- ❌ 只显示一个损耗项（Run 8配速崩盘）
- ❌ 总计柱子几乎不可见
- ❌ 每个柱子都有绿色的0标签，视觉混乱
- ❌ 无法清晰看到累计损耗

### 改进后
- ✅ 显示多个损耗项（功能站、配速等）
- ✅ 总计柱子清晰可见，紫色渐变
- ✅ 没有多余的0标签
- ✅ 瀑布图效果清晰，累计损耗一目了然
- ✅ 总计列突出显示，视觉层次清晰

## 测试用例

### TC-1: 数据计算测试
1. 准备测试数据：运动员功能站表现优于TOP25%但低于平均值
2. 验证：功能站损耗应被正确识别
3. 准备测试数据：Run5-Run7有配速问题
4. 验证：配速损耗应包含这些段

### TC-2: 可视化测试
1. 生成包含多个损耗项的报告
2. 验证：总计柱子清晰可见，高度等于总损耗
3. 验证：没有绿色的0标签
4. 验证：总计列在X轴上使用紫色和加粗

### TC-3: 交互测试
1. 鼠标悬停在损耗项上
2. 验证：显示正确的tooltip信息
3. 鼠标悬停在总计列上
4. 验证：显示"累计总损耗"tooltip
5. 鼠标悬停在辅助系列上
6. 验证：不显示tooltip

## 后续优化建议

1. **转换区时间数据**：调查为什么转换区时间为0，是否需要从其他数据源获取
2. **损耗项分解**：考虑将大损耗项（如Run 8配速崩盘）分解为多个子项（如Run 8前半段、Run 8后半段）
3. **动态阈值**：根据运动员水平动态调整阈值，而不是固定值
4. **可视化增强**：考虑添加连接线，更清晰地展示瀑布效果

## 相关文档

- [技术文档](./../api/v10.0-time-loss-analysis-api.md)
- [v8.0 专业分析报告 PRD](./v8.0-pro-analysis-report.md)
