# PRD v5.1: 本地 SQLite 数据存储 + 排行榜筛选优化

## 一、版本信息

| 项目 | 内容 |
|------|------|
| 版本号 | v5.1 |
| 功能名称 | 本地 SQLite 数据存储 + 排行榜筛选优化 |
| 迭代日期 | 2026-01-22 |
| 状态 | **✅ 已完成** |

### 版本变更记录

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 2026-01-19 | 初始后端 API 开发，使用 pyrox-client 实时查询 |
| v2.0 | 2026-01-20 | 前端开发，4 Tab 结构 |
| v3.0 | 2026-01-21 | 比赛数据 Tab 搜索流程优化 |
| v4.0 | 2026-01-22 | Tab 架构重构为 3 Tab |
| v5.0 | 2026-01-22 | 本地 SQLite 数据存储，替代 pyrox-client 缓存 |
| v5.1 | 2026-01-22 | **排行榜筛选逻辑修复**：分离一级标签（单人赛/双人赛）和二级标签（组别），解决单人赛下显示双人赛数据的问题 |

---

## 二、功能概述

### 2.1 背景

当前系统使用 `pyrox-client` 库直接从 HYROX 官方 API 获取数据，存在以下问题：

1. **首次请求慢**：服务重启后，首次搜索需要从远程加载多个赛季数据到内存
2. **缓存不可控**：pyrox-client 的缓存机制是黑盒，无法自定义更新策略
3. **查询受限**：只能使用 pyrox-client 提供的查询方式，无法执行自定义 SQL
4. **扩展困难**：后续需要构建更多查询接口，需要更灵活的数据存储方案

### 2.2 目标

- 使用 SQLite 作为本地数据存储，替代 pyrox-client 的缓存机制
- 支持手动触发数据同步，满足数据时效性要求
- 提供灵活的 SQL 查询能力，便于后续扩展
- 服务启动即可用，无需等待数据加载

### 2.3 核心变更

1. 新增 SQLite 数据库存储层
2. 新增数据同步服务 (SyncService)
3. 新增同步管理 API (/api/v1/sync/*)
4. 重构现有服务，从查询 pyrox-client 改为查询本地 SQLite

---

## 三、技术方案

### 3.1 技术选型

| 考量因素 | SQLite 优势 |
|---------|------------|
| 数据规模 | 238 场比赛，约 70 万条记录，SQLite 完全胜任 |
| 部署简单 | 无需额外服务，单文件存储，便于备份和迁移 |
| 查询灵活 | 支持 SQL 复杂查询，便于后续扩展自定义接口 |
| 与 pandas 集成 | 原生支持 `pd.read_sql()` 和 `to_sql()`，无缝对接现有代码 |

### 3.2 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                        数据同步层                            │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │  HYROX 官方 API  │ ──────► │   SyncService   │           │
│  └─────────────────┘         └────────┬────────┘           │
│                                       │                     │
│                                       ▼                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   本地存储层                          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────┐       │   │
│  │  │  races   │  │ results  │  │   sync_log   │       │   │
│  │  └──────────┘  └──────────┘  └──────────────┘       │   │
│  │                    SQLite DB                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                       │                     │
│                                       ▼                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    服务层                             │   │
│  │  ┌───────────────┐  ┌───────────────┐               │   │
│  │  │ AthleteService│  │ SuggestService│  ...          │   │
│  │  └───────────────┘  └───────────────┘               │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、数据库设计

### 4.1 races 表 - 比赛列表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PK | 自增主键 |
| season | INTEGER | 赛季编号 (1-8) |
| location | TEXT | 比赛地点 (小写英文) |
| file_last_modified | TEXT | 数据更新时间 |
| created_at | TIMESTAMP | 入库时间 |

**索引**：`UNIQUE (season, location)`

### 4.2 results 表 - 比赛成绩

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PK | 自增主键 |
| season | INTEGER | 赛季 |
| location | TEXT | 比赛地点 |
| event_id | TEXT | 比赛 ID |
| event_name | TEXT | 比赛名称 |
| name | TEXT | 选手姓名 |
| nationality | TEXT | 国籍代码 |
| gender | TEXT | 性别 |
| division | TEXT | 组别 |
| age_group | TEXT | 年龄组 |
| total_time | REAL | 总成绩 (分钟) |
| run_time | REAL | 跑步总时间 |
| work_time | REAL | 功能站总时间 |
| roxzone_time | REAL | Roxzone 时间 |
| run1_time ~ run8_time | REAL | 8 段跑步时间 |
| skierg_time | REAL | SkiErg |
| sled_push_time | REAL | Sled Push |
| sled_pull_time | REAL | Sled Pull |
| burpee_broad_jump_time | REAL | Burpee Broad Jump |
| row_erg_time | REAL | Row Erg |
| farmers_carry_time | REAL | Farmers Carry |
| sandbag_lunges_time | REAL | Sandbag Lunges |
| wall_balls_time | REAL | Wall Balls |
| created_at | TIMESTAMP | 入库时间 |

**索引**：
- `idx_results_name` - 运动员搜索
- `idx_results_season_location` - 按比赛筛选
- `idx_results_nationality` - 按国籍筛选
- `idx_results_total_time` - 按成绩排序

### 4.3 sync_log 表 - 同步日志

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PK | 自增主键 |
| season | INTEGER | 同步的赛季 |
| location | TEXT | 同步的比赛 (NULL 表示整个赛季) |
| status | TEXT | success / failed |
| records_count | INTEGER | 同步记录数 |
| error_message | TEXT | 错误信息 |
| synced_at | TIMESTAMP | 同步时间 |

---

## 五、API 接口设计

### 5.1 同步 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/sync/season/{season}` | POST | 同步指定赛季全部数据 |
| `/api/v1/sync/race` | POST | 同步指定单场比赛 |
| `/api/v1/sync/all` | POST | 同步所有赛季数据 |
| `/api/v1/sync/status` | GET | 查看同步状态和统计 |

### 5.2 接口详情

#### POST /api/v1/sync/season/{season}

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| season | int | 是 | 赛季编号 (1-8) |

**响应示例**：
```json
{
  "success": true,
  "season": 8,
  "races_count": 50,
  "records_count": 150000,
  "duration_seconds": 45.2
}
```

#### POST /api/v1/sync/race

**请求体**：
```json
{
  "season": 8,
  "location": "shanghai"
}
```

**响应示例**：
```json
{
  "success": true,
  "season": 8,
  "location": "shanghai",
  "records_count": 3032,
  "duration_seconds": 2.5
}
```

#### POST /api/v1/sync/all

**响应示例**：
```json
{
  "success": true,
  "seasons_synced": 8,
  "total_races": 238,
  "total_records": 700000,
  "duration_seconds": 360.5
}
```

#### GET /api/v1/sync/status

**响应示例**：
```json
{
  "database_path": "data/hyrox.db",
  "database_size_mb": 85.5,
  "total_races": 238,
  "total_results": 700000,
  "last_sync": "2026-01-22T10:30:00Z",
  "seasons": [
    {"season": 8, "races": 50, "results": 150000, "last_sync": "2026-01-22T10:30:00Z"},
    {"season": 7, "races": 62, "results": 180000, "last_sync": "2026-01-22T10:25:00Z"}
  ]
}
```

---

## 六、用户操作流程

### 6.1 首次部署

```
1. 启动后端服务
   │
   ▼
2. 调用 POST /api/v1/sync/all
   │
   ▼
3. 等待全量数据同步完成 (约 5-10 分钟)
   │
   ▼
4. 系统可正常使用
```

### 6.2 日常使用

```
用户搜索运动员
   │
   ▼
服务直接查询本地 SQLite
   │
   ▼
毫秒级响应
```

### 6.3 数据更新

```
1. 管理员判断需要更新数据
   │
   ├─ 更新单场比赛 → POST /api/v1/sync/race
   │
   ├─ 更新整个赛季 → POST /api/v1/sync/season/{season}
   │
   └─ 全量更新 → POST /api/v1/sync/all
```

---

## 七、文件变更清单

### 7.1 新增文件

| 文件路径 | 说明 |
|----------|------|
| `backend/app/db/database.py` | SQLite 连接管理 |
| `backend/app/db/models.py` | SQLAlchemy 模型定义 |
| `backend/app/services/sync_service.py` | 数据同步服务 |
| `backend/app/api/v1/sync.py` | 同步 API 端点 |
| `docs/api/v5.0-sync-api.md` | 同步 API 文档 |

### 7.2 修改文件

| 文件路径 | 变更说明 |
|----------|----------|
| `.cursor/rules/database.mdc` | 更新为 SQLite 规范 |
| `backend/app/services/athlete_service.py` | 改用 SQLite 查询 |
| `backend/app/services/suggest_service.py` | 改用 SQLite 查询 |
| `backend/app/api/v1/router.py` | 注册 sync 路由 |
| `backend/requirements.txt` | 新增 sqlalchemy, aiosqlite |

---

## 八、验收标准

### 8.1 数据同步

1. ✅ `/api/v1/sync/all` 能成功同步所有赛季数据
2. ✅ `/api/v1/sync/season/{season}` 能同步指定赛季
3. ✅ `/api/v1/sync/race` 能同步单场比赛
4. ✅ `/api/v1/sync/status` 返回正确的同步状态
5. ✅ 同步过程有日志记录

### 8.2 数据查询

6. ✅ 运动员搜索功能正常 (使用 SQLite)
7. ✅ 名称建议功能正常 (使用 SQLite)
8. ✅ 查询响应时间 < 100ms

### 8.3 服务稳定性

9. ✅ 服务重启后立即可用，无需等待
10. ✅ 数据库文件正确存储在 `data/hyrox.db`
11. ✅ 无内存泄漏

---

## 九、依赖变更

### 新增依赖

```
sqlalchemy>=2.0.0
aiosqlite>=0.19.0
```

### 保留依赖

```
pyrox-client>=0.1.0  # 仅用于 SyncService 从官方 API 拉取数据
```

---

## 十、相关文档

- [数据库开发规范](../../.cursor/rules/database.mdc)
- [同步 API 文档](../api/v5.0-sync-api.md)
- [数据字典](../api/Data_Dictionary.md)
- [本地开发指南](../deployment/v2.0-local-dev-guide.md)


