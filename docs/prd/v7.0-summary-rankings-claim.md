# PRD v7.0 - 总结页排名修复 + 认领功能

## 版本信息
- **版本号**: v7.0
- **日期**: 2026-01-23
- **状态**: 开发中

## 背景

### 问题 1: 排名数据不一致
用户在成绩列表页筛选"单人赛-公开组-男子"后，点击排名第一的选手进入总结页，但总结页显示的"总排名"并非第一。

**根因分析**：
- 成绩列表的排名是前端在筛选后重新计算的 `index + 1`
- 总结页显示的是后端的 `overall_rank`，该排名包含**所有**参赛者（单人+双人+所有组别）
- 双人赛选手通常成绩更快，导致单人赛第一名的 `overall_rank` 可能是 50+

### 问题 2: 排名卡片标签错误
- "年龄组"卡片实际显示的是 `division_rank`（组别排名），标签与数据不匹配
- "TOP 10%"徽章是硬编码的，不反映实际排名

### 需求 3: 认领功能
Demo 版中包含"认领"功能模块，允许用户将成绩保存到个人档案。需要在当前版本中实现（静态版本）。

## 修改方案

### 1. 排名卡片重构

#### 当前设计（有问题）
| 卡片 | 标签 | 数据来源 | 问题 |
|------|------|----------|------|
| 1 | TOP 10% | 硬编码 | 不反映实际排名 |
| 2 | 总排名 | `overall_rank` | 包含双人赛，与筛选不一致 |
| 3 | 年龄组 | `division_rank` | 标签与数据不匹配 |

#### 新设计
| 卡片 | 标签 | 数据来源 | 显示格式 |
|------|------|----------|----------|
| 1 | 前 X% | `division_rank / division_total` | 动态徽章，金色边框 |
| 2 | 组别排名 | `division_rank / division_total` | #42 / 200 + 击败 79% |
| 3 | 年龄组 | `age_group_rank / age_group_total` | #12 / 85 + 击败 86% |

#### 计算公式
- **前 X%**: `Math.ceil((division_rank / division_total) * 100)`
- **击败 X%**: `Math.round((1 - rank / total) * 100)`

### 2. 认领功能（静态实现）

#### 新增状态
```typescript
const [isClaimed, setIsClaimed] = useState(false);
const [showClaimModal, setShowClaimModal] = useState(false);
const [toastMsg, setToastMsg] = useState<string | null>(null);
```

#### 组件结构

**Claim Bar** (在 Breakdown Cards 下方，仅 `!isClaimed` 时显示)
```
┌────────────────────────────────────────────────┐
│ [icon] 这是您的成绩？              [去认领] │
│        认领后可永久保存并分析                   │
└────────────────────────────────────────────────┘
```

**Claim Modal** (确认弹窗)
```
┌────────────────────────────────────────┐
│              [lock_person]              │
│         确认保存到我的？                │
│   保存后该成绩将同步至你的运动员档案      │
│   并解锁详细数据分析。                   │
│                                         │
│      [取消]           [确认]            │
└────────────────────────────────────────┘
```

**Toast** (操作成功提示)
```
┌─────────────────────────┐
│ ✓ 认证成功               │
└─────────────────────────┘
```

## 技术实现

### 修改文件
- `frontend/src/screens/LiveTab.tsx`

### 修改点

1. **扩展 displayData**
   ```typescript
   const displayData = hasRealData ? {
     // ... existing fields
     divisionRank: selectedAthlete.rankings.division_rank,
     divisionTotal: selectedAthlete.rankings.division_total,
     ageGroupRank: selectedAthlete.rankings.age_group_rank,
     ageGroupTotal: selectedAthlete.rankings.age_group_total,
   } : { /* fallback */ };
   ```

2. **计算百分位函数**
   ```typescript
   const getTopPercent = (rank: number, total: number) => 
     total > 0 ? Math.ceil((rank / total) * 100) : 0;
   
   const getBeatPercent = (rank: number, total: number) =>
     total > 0 ? Math.round((1 - rank / total) * 100) : 0;
   ```

3. **排名卡片 JSX 更新**
   - 卡片1: 动态 "前 X%" 徽章
   - 卡片2: 组别排名 + 击败百分比
   - 卡片3: 年龄组排名 + 击败百分比（处理 null 情况）

4. **认领功能组件**
   - Claim Bar: 绿色边框卡片
   - Claim Modal: 全屏遮罩 + 居中弹窗
   - Toast: 固定位置提示

## 验收标准

1. [ ] 总结页"组别排名"与成绩列表筛选后的排名一致
2. [ ] "前 X%"徽章动态显示，数值正确
3. [ ] "击败 X%"计算正确
4. [ ] 年龄组排名正确显示（处理无数据情况）
5. [ ] 认领条在未认领时显示，认领后隐藏
6. [ ] 认领弹窗正常弹出/关闭
7. [ ] 认领成功后显示 Toast

