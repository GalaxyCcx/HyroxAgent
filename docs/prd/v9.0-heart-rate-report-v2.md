# PRD v9.0 - 心率数据集成与报告系统 V2.0

## 版本信息
- **版本号**: v9.0
- **日期**: 2026-01-28
- **状态**: 已完成
- **前置版本**: v8.0-pro-analysis-report

## 背景

v8.0 版本实现了基础的专业分析报告功能，但存在以下局限：
1. **缺少心率数据**: 无法分析用户的生理负荷和恢复能力
2. **图表覆盖不足**: LLM 动态生成图表不稳定，覆盖率仅 60-70%
3. **章节生成不够定制化**: 输出格式不够一致，部分内容质量不稳定
4. **无法强制重新生成**: 已存在报告无法更新

本版本引入心率数据采集能力，并重构 Multi-Agent 架构以提升报告质量和稳定性。

## 功能概述

### 核心新功能

#### 1. 心率数据采集与分析
- 用户可上传 1-3 张运动手表/App 的心率截图
- 使用视觉语言模型（VL Model）自动提取心率数据
- 将心率时间序列映射到 16 个赛事分段（8 次跑步 + 8 个功能站）
- 在报告中生成心率配速脱钩分析

#### 2. 报告系统 V2.0
- **数据预计算**: 并发获取所有章节所需数据
- **图表预构建**: 固定 6 种专业图表，100% 覆盖率
- **章节定制化**: 每个章节有固定的输入数据和输出 Schema
- **强制重新生成**: 支持更新已存在的报告

### 用户流程

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 用户在 Lite 分析页点击"解锁详细报告"                          │
├─────────────────────────────────────────────────────────────────┤
│  2. 弹出心率截图上传窗口（可选）                                  │
│     - 支持拖拽或点击上传                                         │
│     - 最多 3 张，单张 ≤ 10MB                                     │
│     - 支持 PNG/JPG 格式                                          │
├─────────────────────────────────────────────────────────────────┤
│  3. 点击"开始生成报告"或"跳过，直接生成"                         │
├─────────────────────────────────────────────────────────────────┤
│  4. 显示生成进度条（SSE 实时更新）                                │
│     - 处理心率图片（如有）                                       │
│     - 数据准备阶段                                               │
│     - 各章节生成                                                 │
├─────────────────────────────────────────────────────────────────┤
│  5. 完成后显示专业报告                                           │
│     - 6 个章节 + 6 种图表                                        │
│     - 含心率分析（如有心率数据）                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 报告结构 V2.0

```
┌─────────────────────────────────────────────────────────────────┐
│ [Chapter 1] 成績總覽與定位                                       │
│   - Performance Heatmap（柱状图）                                │
│   - 16 分段表现评估                                              │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 2] 時間損失熱區分析                                     │
│   - Splits Breakdown（双向柱状图）                               │
│   - 时间损失来源定位                                             │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 3] ZONE0 引擎深度復盤                                   │
│   - HR-Pace Dual Axis（双轴折线图）                              │
│   - 心率配速脱钩分析 / 配速分析替代                              │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 4] 成績預測與目標設定                                   │
│   - Goal Progress（进度条）                                      │
│   - 潜力预测和目标规划                                           │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 5] 對標分析                                             │
│   - Comparison Radar（雷达图）                                   │
│   - 与目标选手/平均水平对比                                       │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 6] 訓練計劃建議                                         │
│   - Training Focus（饼图）                                       │
│   - 8 周训练计划建议                                             │
└─────────────────────────────────────────────────────────────────┘
```

## 技术架构

### Multi-Agent V2.0 系统

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ReportGeneratorV2                                │
│                         (流程编排器)                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌───────────────┐    ┌───────────────┐    ┌───────────────────────┐   │
│   │ HeartRate     │    │ HeartRate     │    │    DataProvider       │   │
│   │ Extractor     │───▶│ Mapper        │───▶│    (数据预计算)       │   │
│   │ (VL 模型提取) │    │ (分段映射)     │    │    - 并发数据获取      │   │
│   └───────────────┘    └───────────────┘    └───────────┬───────────┘   │
│                                                          │               │
│                                                          ▼               │
│   ┌───────────────────────────────────────────────────────────────────┐ │
│   │                     ChartDataBuilder                               │ │
│   │                     (图表预构建)                                   │ │
│   │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │ │
│   │   │Heatmap  │ │Splits   │ │HR-Pace  │ │Goal     │ │Radar    │    │ │
│   │   │(柱状图) │ │Breakdown│ │DualAxis │ │Progress │ │Compare  │    │ │
│   │   └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘    │ │
│   └───────────────────────────────────────────────────────────────────┘ │
│                                     │                                    │
│                                     ▼                                    │
│   ┌───────────────────────────────────────────────────────────────────┐ │
│   │                      SectionAgent × 6                              │ │
│   │                      (定制化章节生成)                              │ │
│   │   - 固定输入数据 Schema                                            │ │
│   │   - 固定输出格式 Schema                                            │ │
│   │   - 并发执行                                                       │ │
│   └───────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 组件说明

#### 1. HeartRateExtractor (心率提取器)
- **输入**: 用户上传的心率截图（base64）
- **模型**: 阿里云百炼 qwen-vl-plus
- **输出**: 提取的心率数据（平均心率、最大心率、心率区间分布）

```python
class HeartRateExtractor:
    async def extract(self, image_paths: List[str]) -> HeartRateData:
        """从截图中提取心率数据"""
        # 调用 VL 模型分析图片
        # 返回结构化心率数据
```

#### 2. HeartRateMapper (心率映射器)
- **输入**: 提取的心率数据 + 赛事分段时间
- **输出**: 16 分段心率数据

```python
class HeartRateMapper:
    def map_to_segments(self, hr_data: HeartRateData, 
                        result: AthleteResult) -> Dict[str, SegmentHR]:
        """将心率数据映射到 16 个赛事分段"""
```

#### 3. DataProvider (数据提供者)
- **职责**: 并发获取所有章节所需数据
- **数据源**: 
  - 运动员成绩数据
  - 组别统计数据
  - 历史成绩对比
  - 心率数据（如有）

```python
class DataProvider:
    async def prepare_all_data(self, context: ReportContext) -> Dict:
        """并发准备所有章节数据"""
        tasks = [
            self._get_athlete_result(),
            self._get_division_stats(),
            self._get_segment_analysis(),
            self._get_historical_data(),
            # ...
        ]
        return await asyncio.gather(*tasks)
```

#### 4. ChartDataBuilder (图表构建器)
- **职责**: 预构建所有图表的 ECharts 配置
- **图表类型**:

| 图表 ID | 类型 | 用途 |
|---------|------|------|
| performance_heatmap | bar | 16 分段表现评估 |
| splits_breakdown | bar (双向) | 时间损失分布 |
| hr_pace_dual_axis | line (双轴) | 心率配速关系 |
| goal_progress | gauge | 目标进度 |
| comparison_radar | radar | 多维度对比 |
| training_focus | pie | 训练重点分布 |

#### 5. SectionAgent (章节 Agent)
- **职责**: 基于预准备数据生成章节内容
- **特点**:
  - 固定输入 Schema（每个章节不同）
  - 固定输出 Schema（JSON 格式）
  - 支持优雅降级（如无心率数据时）

```python
# 章节定义示例
{
    "section_id": "heart_rate",
    "title": "ZONE0 引擎深度復盤",
    "input_data": ["athlete_result", "division_stats", "heart_rate_data"],
    "output_schema": {
        "analysis_type": "full | degraded",
        "hr_drift_rate": "float",
        "decoupling_point": "string",
        "efficiency_rating": "string",
        # ...
    },
    "requires_heart_rate": True,
    "allow_degraded": True  # 无心率时使用配速分析替代
}
```

### 新增数据库模型

```python
class HeartRateImage(Base):
    """心率图片记录"""
    __tablename__ = "heart_rate_images"
    
    id = Column(Integer, primary_key=True)
    report_id = Column(String(36), ForeignKey("pro_reports.report_id"))
    image_path = Column(String(500))  # 存储路径
    extracted_data = Column(Text)     # 提取结果 (JSON)
    status = Column(String(20))       # pending/processed/error
    created_at = Column(DateTime, default=datetime.utcnow)
```

### VL 模型配置

```json
{
  "vl_model": {
    "provider": "aliyun_bailian",
    "model": "qwen-vl-plus",
    "api_key": "sk-xxx",
    "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
    "max_tokens": 4096
  }
}
```

## API 变更

### 新增接口

#### 1. 心率图片上传
```
POST /api/v1/upload/heart-rate
Content-Type: multipart/form-data

Form Data:
- report_id: string (必填)
- files: File[] (1-3 张图片)
```

#### 2. V2 创建报告
```
POST /api/v1/reports/v2/create
{
  "season": 8,
  "location": "shanghai",
  "athlete_name": "...",
  "force_regenerate": true  // 新增：强制重新生成
}
```

#### 3. V2 生成报告（支持心率图片）
```
GET /api/v1/reports/v2/generate/{report_id}?heart_rate_image_paths=path1,path2
Accept: text/event-stream
```

详见 [API 文档 v9.0](../api/v9.0-heart-rate-report-api.md)

## 文件结构

### 后端新增/修改文件

```
backend/app/
├── api/v1/
│   ├── upload.py              # [新增] 图片上传接口
│   └── report.py              # [修改] 添加 V2 接口
├── llm/
│   └── vl_client.py           # [新增] VL 模型客户端
├── services/report/
│   ├── heart_rate_extractor.py  # [新增] 心率提取器
│   ├── heart_rate_mapper.py     # [新增] 心率映射器
│   ├── data_provider.py         # [新增] 数据提供者
│   ├── chart_builder.py         # [新增] 图表构建器
│   ├── section_agent.py         # [新增] 章节 Agent
│   ├── section_definitions_v2.py # [新增] V2 章节定义
│   └── report_generator.py      # [修改] V2 生成流程
└── db/
    └── models.py                # [修改] 添加 HeartRateImage
```

### 前端新增/修改文件

```
frontend/src/
├── components/
│   └── ImageUploader.tsx     # [新增] 心率图片上传组件
├── screens/
│   └── LiveTab.tsx           # [修改] 集成上传流程
├── services/
│   └── api.ts                # [修改] V2 API 调用
└── types.ts                  # [修改] 新增类型定义
```

## 验收标准

### 心率功能
- [x] 心率截图上传组件正确显示（拖拽 + 点击）
- [x] 支持 1-3 张图片上传
- [x] 上传成功后显示图片预览
- [x] 上传失败时显示错误提示
- [x] 可跳过上传直接生成报告

### 报告生成
- [x] V2 接口正确创建报告
- [x] force_regenerate 参数生效
- [x] SSE 进度实时更新
- [x] 心率数据正确提取和映射
- [x] 6 个章节全部生成

### 图表渲染
- [x] Performance Heatmap 正确显示 16 分段
- [x] 所有图表使用深色主题
- [x] 图表标签不重叠
- [x] 图表交互正常（tooltip、legend）

### 心率分析（第三章）
- [x] 有心率数据时显示完整分析
- [x] 无心率数据时显示配速替代分析
- [x] 心率区间分布正确展示

## 已知问题 & 后续优化

1. **VL 模型准确率**: 心率提取依赖截图质量，建议提供截图指南
2. **历史心率对比**: 当前版本仅分析单场心率，可扩展为多场对比
3. **实时心率接入**: 未来可对接运动手表 API 直接获取数据

## 相关文档

- [API 文档 v9.0](../api/v9.0-heart-rate-report-api.md)
- [PRD v8.0 - 专业分析报告](v8.0-pro-analysis-report.md)
- [部署指南](../deployment/quick-start.md)
