# PRD v10.0 - 报告章节结构重构

## 版本信息
- **版本号**: v10.0
- **日期**: 2026-01-28
- **状态**: 已完成
- **前置版本**: v9.0-heart-rate-report-v2

## 背景

v9.0 版本实现了心率数据集成和报告系统 V2.0，但存在以下问题：

1. **章节结构与产品规划不一致**: 实际生成 6 个章节，但产品规划只需 5 个核心章节
2. **章节重复渲染**: `summary` 章节同时被 `IntroductionCard` 和章节列表渲染，导致内容重复
3. **章节命名不统一**: `heart_rate` 章节 ID 与标题"ZONEØ 引擎深度复盘"不匹配
4. **冗余章节**: `comparison`（对标分析）功能与其他章节有重叠，产品决定移除

本版本重构章节结构，使其与参考设计文档完全一致。

## 功能概述

### 核心变更

#### 1. 章节结构精简（6 章 → 5 章）

| 序号 | 章节 ID | 标题 | 变更 |
|------|---------|------|------|
| 1 | `summary` | 核心摘要：ZONEØ 战力值 | 标题更新 |
| 2 | `time_loss` | 消失的五分鐘 (The Lost 5 Minutes) | 无变更 |
| 3 | `deep_dive` | ZONEØ 引擎深度復盤 | ID 从 `heart_rate` 改为 `deep_dive` |
| 4 | `prediction` | 下一站預測與提升路徑 | 无变更 |
| 5 | `training` | 定制化訓練建議 | 无变更 |
| - | ~~comparison~~ | ~~對標分析~~ | **已删除** |

#### 2. 前端渲染优化

- `summary` 章节通过 `IntroductionCard` 组件单独渲染（显示 ROXSCAN 评分卡片）
- 章节列表过滤掉 `summary`，避免重复渲染
- 其他 4 个章节（time_loss, deep_dive, prediction, training）正常渲染，序号从 2 开始
- 总结部分通过 `conclusion` 独立渲染

### 目标章节结构

```
┌─────────────────────────────────────────────────────────────────┐
│ [核心摘要卡片] 核心摘要：ZONEØ 战力值                            │
│   - ROXSCAN 综合评分（0-100分）                                 │
│   - S/A/B/C/D 等级判定                                          │
│   - 三维能力值（力量/有氧底座/转换效率）                          │
│   - 重点发现（优势/弱势亮点）                                    │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 2] 消失的五分鐘 (The Lost 5 Minutes)                   │
│   - 总时间损耗量化                                               │
│   - 损耗来源分类（转换区/配速崩盘/功能站）                        │
│   - 理论最佳成绩计算                                             │
│   - 改进难度评估                                                 │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 3] ZONEØ 引擎深度復盤                                   │
│   - 心率配速脱钩分析（有心率数据时）                              │
│   - 三阶段模型：稳态期/脱钩期/崩盘区                              │
│   - 配速分析替代（无心率数据时）                                  │
│   - 效率评级与建议                                               │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 4] 下一站預測與提升路徑                                 │
│   - 五档预测区间（Excellent/Great/Expected/Subpar/Poor）         │
│   - 统计样本分析                                                 │
│   - 关键提升项目                                                 │
│   - 里程碑路径规划                                               │
├─────────────────────────────────────────────────────────────────┤
│ [Chapter 5] 定制化訓練建議                                       │
│   - 弱项分析（根因+训练重点）                                    │
│   - 周期训练计划（基础期/强化期/比赛期）                          │
│   - 7天训练日历                                                  │
│   - 关键训练课程                                                 │
├─────────────────────────────────────────────────────────────────┤
│ [总结卡片] 总结与建议                                            │
│   - 核心亮点总结                                                 │
│   - 行动建议                                                     │
└─────────────────────────────────────────────────────────────────┘
```

## 技术实现

### 后端修改

#### 1. section_definitions_v2.py

```python
# 修改前
SECTION_DEFINITIONS_V2 = {
    "summary": {..., "title": "成績總覽與定位"},
    "time_loss": {...},
    "heart_rate": {..., "section_id": "heart_rate"},  # ID 不一致
    "prediction": {...},
    "comparison": {...},  # 冗余章节
    "training": {...},
}

def get_all_section_ids():
    return ["summary", "time_loss", "heart_rate", "prediction", "comparison", "training"]

# 修改后
SECTION_DEFINITIONS_V2 = {
    "summary": {..., "title": "核心摘要：ZONEØ 战力值"},  # 标题更新
    "time_loss": {...},
    "deep_dive": {..., "section_id": "deep_dive"},  # ID 统一
    "prediction": {...},
    # "comparison" 已删除
    "training": {...},
}

def get_all_section_ids():
    return ["summary", "time_loss", "deep_dive", "prediction", "training"]
```

#### 2. section_agent.py

```python
# 修改前
SECTION_PROMPTS = {
    "heart_rate": """...""",
    "comparison": """...""",
}

# 修改后
SECTION_PROMPTS = {
    "deep_dive": """...""",  # 重命名
    # "comparison" 已删除
}
```

#### 3. report_generator.py

```python
# 修改前
elif section_id == "heart_rate":
    # 心率分析章节处理
elif section_id == "comparison":
    # 对标分析章节处理

# 修改后
elif section_id == "deep_dive":
    # 深度复盘章节处理
# "comparison" 分支已删除
```

### 前端修改

#### LiveTab.tsx

```tsx
// 修改前
{proReportDetail.sections && proReportDetail.sections.map((section, index) => {
  // 渲染所有章节，包括 summary
  return <SectionCard index={index + 1} {...section} />;
})}

// 修改后
{proReportDetail.sections && proReportDetail.sections
  .filter((section) => section.section_id !== "summary")  // 过滤 summary
  .map((section, index) => {
    // 序号从 2 开始（1 是核心摘要）
    return <SectionCard index={index + 2} {...section} />;
  })}
```

## 文件变更清单

### 后端

| 文件路径 | 变更类型 | 描述 |
|---------|---------|------|
| `backend/app/services/report/section_definitions_v2.py` | 修改 | 删除 comparison，重命名 heart_rate→deep_dive，更新 summary 标题 |
| `backend/app/services/report/section_agent.py` | 修改 | 更新 prompt 映射，删除 comparison prompt |
| `backend/app/services/report/report_generator.py` | 修改 | 更新 content 转换逻辑，删除 comparison 分支 |

### 前端

| 文件路径 | 变更类型 | 描述 |
|---------|---------|------|
| `frontend/src/screens/LiveTab.tsx` | 修改 | 过滤 summary 章节，调整序号从 2 开始 |

## 渲染对比

### 修改前（8 个视觉区块）

1. IntroductionCard（核心摘要）
2. summary 章节（成绩总览与定位）← 重复
3. time_loss 章节
4. heart_rate 章节
5. prediction 章节
6. comparison 章节 ← 冗余
7. training 章节
8. conclusion（总结与建议）

### 修改后（6 个视觉区块）

1. IntroductionCard（核心摘要：ZONEØ 战力值）
2. time_loss 章节（序号 2）
3. deep_dive 章节（序号 3）
4. prediction 章节（序号 4）
5. training 章节（序号 5）
6. conclusion（总结与建议）

## 验收标准

### 后端
- [x] `get_all_section_ids()` 返回 5 个章节 ID
- [x] 不再包含 `comparison` 章节定义
- [x] `deep_dive` 章节正确替代 `heart_rate`
- [x] 心率分析功能在 `deep_dive` 章节正常工作
- [x] 无 lint 错误

### 前端
- [x] IntroductionCard 正确渲染核心摘要
- [x] 章节列表不包含 summary 章节
- [x] 章节序号从 2 开始
- [x] 共 4 个编号章节 + 总结
- [x] 旧报告数据兼容（自动忽略 comparison）

## 兼容性说明

1. **旧报告数据**: 已生成的报告中如包含 `comparison` 章节数据，前端渲染时会自动忽略
2. **新报告生成**: 新生成的报告将只包含 5 个章节
3. **API 无变更**: 报告 API 接口保持不变，仅后端生成逻辑调整

## 相关文档

- [PRD v9.0 - 心率数据集成](v9.0-heart-rate-report-v2.md)
- [PRD v8.0 - 专业分析报告](v8.0-pro-analysis-report.md)
- [API 文档 v8.0](../api/v8.0-report-api.md)
