# PRD: MVP v1.0 - 运动员成绩查询

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v1.0 |
| 作者 | HyroxAgent Team |
| 创建日期 | 2025-01-20 |
| 状态 | 待开发 |
| 参考 | [Roxlab](https://www.roxlab.app) |

## 修订历史

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| 0.1 | 2025-01-20 | AI | 初稿 |
| 0.2 | 2026-01-20 | AI | 优化搜索功能：增加两阶段搜索（名称建议+正式搜索） |

---

## 1. 产品概述

### 1.1 背景

HYROX 是一项标准化的室内健身竞赛，在全球范围内举办。参赛者需要完成 8 段 1km 跑步和 8 个功能性训练站。目前市面上已有 Roxlab 等第三方数据分析平台，我们需要开发类似的运动员成绩查询和展示功能。

### 1.2 目标

开发一个最小可行产品 (MVP)，实现：
1. **运动员搜索** - 用户可通过姓名搜索运动员
2. **成绩展示** - 展示运动员的单场比赛详细成绩
3. **排名计算** - 计算并展示各维度排名信息

### 1.3 成功指标

| 指标 | 目标值 |
|------|--------|
| 搜索响应时间 | < 3s |
| 详情页加载时间 | < 2s |
| 功能可用性 | 100% |

---

## 2. 用户故事

### 2.1 目标用户

HYROX 运动爱好者，希望查询自己或他人的比赛成绩。

### 2.2 用户故事

| ID | 用户故事 | 优先级 |
|----|----------|--------|
| US01 | 作为用户，我希望通过输入姓名搜索运动员，以便找到我关注的选手 | P0 |
| US02 | 作为用户，我希望查看运动员的比赛成绩详情，以便了解其表现 | P0 |
| US03 | 作为用户，我希望看到运动员的排名信息，以便了解其在同组中的水平 | P0 |
| US04 | 作为用户，我希望看到分段成绩，以便分析强项和弱项 | P1 |

---

## 3. 功能需求

### 3.1 功能列表

| 功能ID | 功能名称 | 优先级 | 状态 |
|--------|----------|--------|------|
| F001 | 运动员搜索 | P0 | 待开发 |
| F002 | 成绩详情展示 | P0 | 待开发 |
| F003 | 排名计算与展示 | P0 | 待开发 |
| F004 | 分段成绩可视化 | P1 | 待开发 |
| F005 | 时间占比图表 | P1 | 待开发 |

### 3.2 F001: 运动员搜索（两阶段搜索）

**描述**: 采用两阶段搜索模式，先帮助用户找到正确的运动员姓名，再进行正式的成绩查询。

#### 3.2.1 第一阶段：名称建议

**用户场景**:
- 用户可能不记得运动员的准确姓名拼写
- 姓名格式可能是 "Lastname, Firstname" 或 "Firstname Lastname"
- 存在大小写差异

**输入**:
- 搜索关键词（必填，2-50字符）

**输出**:
- 匹配的运动员姓名列表（去重），最多返回 5 个候选项
- 每个候选项包含：
  - 姓名（标准格式）
  - 匹配的比赛数量

**匹配规则**:
1. **模糊匹配**: 输入的每个词都需要在姓名中出现（不要求顺序）
2. **不区分大小写**: "chen" 匹配 "Chen", "CHEN"
3. **支持部分匹配**: "yua" 匹配 "Yuanmin"
4. **姓名顺序无关**: "yuanmin chen" 匹配 "Chen, Yuanmin"

**示例**:
| 输入 | 可能的匹配结果 |
|------|----------------|
| chen yuan | Chen, Yuanmin (3场); Chen, Yuan (2场) |
| mitch | Chen, Mitch (5场); Mitchell, John (2场) |
| magill | Magill, Connor (8场) |

#### 3.2.2 第二阶段：成绩搜索

**触发条件**: 用户从名称建议列表中点击选择一个姓名

**输入**:
- 精确姓名（从第一阶段选择）
- 赛季筛选（可选）

**输出**:
- 该运动员的所有比赛记录列表，每条包含：
  - 姓名
  - 比赛名称
  - 总成绩（格式化）
  - 组别、性别、年龄组
  - 国籍

**业务规则**:
1. **精确匹配姓名**（已在第一阶段确认）
2. 按比赛时间倒序排列（最新的在前）
3. 默认返回最多 20 条结果
4. 搜索范围：默认搜索最近 1 个赛季

#### 3.2.3 UI 交互流程

```
┌─────────────────────────────────────┐
│  🔍 输入运动员姓名...               │
└─────────────────────────────────────┘

         ↓ 用户输入 "chen yuan"（防抖 500ms）

┌─────────────────────────────────────┐
│  🔍 chen yuan                    ✕  │
├─────────────────────────────────────┤
│  📋 请选择运动员:                   │
│  ┌─────────────────────────────────┐│
│  │ Chen, Yuanmin        (3场比赛) ││
│  ├─────────────────────────────────┤│
│  │ Chen, Yuan           (2场比赛) ││
│  ├─────────────────────────────────┤│
│  │ Chen, Yuanjie        (1场比赛) ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘

         ↓ 用户点击 "Chen, Yuanmin"

┌─────────────────────────────────────┐
│  ← Chen, Yuanmin                    │
├─────────────────────────────────────┤
│  正在搜索 Chen, Yuanmin 的比赛...   │
└─────────────────────────────────────┘

         ↓ 显示比赛记录列表

┌─────────────────────────────────────┐
│  ← Chen, Yuanmin                    │
├─────────────────────────────────────┤
│  ┌─────────────────────────────────┐│
│  │ Chen, Yuanmin     01:25:30     ││
│  │ 2025 Hong Kong · Men's Open    ││
│  ├─────────────────────────────────┤│
│  │ Chen, Yuanmin     01:28:15     ││
│  │ 2024 Shanghai · Men's Open     ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘
```

**UI 要求**:
- 搜索框在页面顶部，输入时实时显示名称建议（防抖 500ms）
- 名称建议以下拉列表形式显示，最多 5 个候选
- 点击候选项后，搜索框显示选中的姓名，同时触发成绩搜索
- 支持键盘上下选择，Enter 确认
- 无匹配名称时显示 "未找到匹配的运动员姓名"
- 搜索结果为空时显示 "该运动员暂无比赛记录"

### 3.3 F002: 成绩详情展示

**描述**: 展示运动员在某场比赛中的完整成绩信息。

**展示内容**:

**区域 1 - 头部信息**:
- 比赛名称（如 "2025 Hong Kong"）
- 组别（如 "Men's Open"）
- 年龄组（如 "Age 35-39"）

**区域 2 - 运动员信息**:
- 姓名
- 国籍（国旗 + 国家名）
- 比赛日期

**区域 3 - 核心成绩**:
- 总成绩（HH:MM:SS 格式）
- 总排名
- 年龄组排名
- 组别排名

**区域 4 - 时间分布**:
- 跑步时间及占比
- 功能站时间及占比
- Roxzone 时间及占比

**区域 5 - 分段成绩**:
- 8 段跑步成绩
- 8 个功能站成绩（含动作要求）

### 3.4 F003: 排名计算

**描述**: 根据比赛数据计算运动员的各维度排名。

**排名维度**:

| 排名类型 | 计算规则 |
|----------|----------|
| Overall Rank | 在全部参赛选手中按 total_time 升序排名 |
| Gender Rank | 在同性别选手中排名 |
| Division Rank | 在同性别同组别选手中排名 |
| Age Group Rank | 在同性别同组别同年龄组选手中排名 |

**计算逻辑**: 见第 5 节接口设计。

---

## 4. 页面设计

### 4.1 页面流程

```
┌─────────────┐      ┌─────────────┐
│   搜索页    │ ───► │  详情页     │
│  (首页)     │      │             │
└─────────────┘      └─────────────┘
```

### 4.2 搜索页 (index) - 两阶段搜索

**状态1: 初始状态**
```
┌─────────────────────────────────────┐
│  HyroxAgent                         │
├─────────────────────────────────────┤
│                                     │
│  🔍 搜索运动员                       │
│  ┌─────────────────────────────┐    │
│  │ 请输入姓名...               │    │
│  └─────────────────────────────┘    │
│                                     │
│        🏅                           │
│   输入运动员姓名开始搜索             │
│   支持模糊搜索，姓名顺序无关         │
│                                     │
└─────────────────────────────────────┘
```

**状态2: 显示名称建议（第一阶段）**
```
┌─────────────────────────────────────┐
│  HyroxAgent                         │
├─────────────────────────────────────┤
│                                     │
│  🔍 搜索运动员                       │
│  ┌─────────────────────────────┐    │
│  │ chen yuan              ✕    │    │
│  └─────────────────────────────┘    │
│  ┌─────────────────────────────┐    │
│  │ 📋 请选择运动员:             │    │
│  ├─────────────────────────────┤    │
│  │ Chen, Yuanmin    (3场比赛)  │◄── │
│  ├─────────────────────────────┤    │
│  │ Chen, Yuan       (2场比赛)  │    │
│  ├─────────────────────────────┤    │
│  │ Chen, Yuanjie    (1场比赛)  │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

**状态3: 显示比赛记录（第二阶段）**
```
┌─────────────────────────────────────┐
│  HyroxAgent                         │
├─────────────────────────────────────┤
│                                     │
│  ← Chen, Yuanmin 的比赛记录         │
│  ┌─────────────────────────────┐    │
│  │ 🔍 重新搜索                  │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ 🇨🇳 Chen, Yuanmin            │    │
│  │ 2025 Hong Kong              │    │
│  │ 01:25:30 | Men's Open       │    │
│  │ Age 30-34                   │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ 🇨🇳 Chen, Yuanmin            │    │
│  │ 2024 Shanghai               │    │
│  │ 01:28:15 | Men's Open       │    │
│  │ Age 30-34                   │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

**状态4: 无匹配名称**
```
┌─────────────────────────────────────┐
│  🔍 搜索运动员                       │
│  ┌─────────────────────────────┐    │
│  │ xyzabc                 ✕    │    │
│  └─────────────────────────────┘    │
│                                     │
│        🏃                           │
│   未找到匹配的运动员姓名             │
│   请检查拼写或尝试其他关键词         │
│                                     │
└─────────────────────────────────────┘
```

### 4.3 成绩详情页 (result)

```
┌─────────────────────────────────────┐
│  ← 返回                             │
├─────────────────────────────────────┤
│  2025 Hong Kong                     │
│  Men's Open · Age 35-39             │
├─────────────────────────────────────┤
│                                     │
│  Chen, Mitch                        │
│  🇭🇰 Hong Kong                       │
│  Jul 26-27, 2025                    │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────┐    ┌───────────┐     │
│  │ Total     │    │ Overall   │     │
│  │ 01:34:45  │    │ #511      │     │
│  └───────────┘    └───────────┘     │
│                                     │
│  ┌───────────┐    ┌───────────┐     │
│  │ Age Rank  │    │ Division  │     │
│  │ #122/280  │    │ #400/700  │     │
│  └───────────┘    └───────────┘     │
│                                     │
├─────────────────────────────────────┤
│  时间分布                           │
│                                     │
│  Running     00:45:30    (48%)      │
│  ████████████████░░░░░░░░░░░░       │
│                                     │
│  Workout     00:42:15    (44%)      │
│  ██████████████░░░░░░░░░░░░░░       │
│                                     │
│  Roxzone     00:07:00    (8%)       │
│  ████░░░░░░░░░░░░░░░░░░░░░░░░       │
│                                     │
├─────────────────────────────────────┤
│  分段成绩                           │
│                                     │
│  Run 1           04:30              │
│  ─────────────────────────────────  │
│  SkiErg          04:20    1000m     │
│  ─────────────────────────────────  │
│  Run 2           05:15              │
│  ─────────────────────────────────  │
│  Sled Push       02:10    50m       │
│  ─────────────────────────────────  │
│  Run 3           05:00              │
│  ─────────────────────────────────  │
│  Sled Pull       02:45    50m       │
│  ─────────────────────────────────  │
│  Run 4           05:30              │
│  ─────────────────────────────────  │
│  Burpee Broad    03:20    80m       │
│  ─────────────────────────────────  │
│  Run 5           05:45              │
│  ─────────────────────────────────  │
│  Row Erg         04:50    1000m     │
│  ─────────────────────────────────  │
│  Run 6           06:00              │
│  ─────────────────────────────────  │
│  Farmers Carry   02:00    200m      │
│  ─────────────────────────────────  │
│  Run 7           06:15              │
│  ─────────────────────────────────  │
│  Sandbag Lunges  03:30    100m      │
│  ─────────────────────────────────  │
│  Run 8           06:45              │
│  ─────────────────────────────────  │
│  Wall Balls      04:20    100 reps  │
│                                     │
└─────────────────────────────────────┘
```

---

## 5. 接口设计

### 5.1 接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 名称建议 | GET | /api/v1/athletes/suggest | 第一阶段：模糊匹配返回候选姓名 |
| 搜索运动员 | GET | /api/v1/athletes/search | 第二阶段：精确姓名搜索比赛记录 |
| 获取成绩详情 | GET | /api/v1/results/{season}/{location}/{athlete_name} | 获取详细成绩 |

### 5.2 名称建议接口（新增）

**接口**: `GET /api/v1/athletes/suggest`

**描述**: 第一阶段搜索，根据输入的关键词返回匹配的运动员姓名候选列表。

**请求参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| keyword | string | 是 | - | 搜索关键词，2-50字符 |
| limit | int | 否 | 5 | 返回候选数量上限，最大10 |

**成功响应** (HTTP 200):

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "suggestions": [
      {
        "name": "Chen, Yuanmin",
        "match_count": 3
      },
      {
        "name": "Chen, Yuan",
        "match_count": 2
      }
    ],
    "total": 2
  }
}
```

**后端匹配逻辑**:

```python
def match_name(keyword: str, name: str) -> bool:
    """
    模糊匹配姓名
    
    规则:
    1. 将 keyword 按空格分词
    2. 每个词都必须在 name 中出现（不区分大小写）
    3. 支持部分匹配（词是 name 中某部分的前缀）
    
    示例:
    - match_name("chen yuan", "Chen, Yuanmin") -> True
    - match_name("yuan chen", "Chen, Yuanmin") -> True  
    - match_name("chen li", "Chen, Yuanmin") -> False
    """
    name_lower = name.lower().replace(',', ' ')
    keywords = keyword.lower().split()
    
    for kw in keywords:
        # 检查 kw 是否是 name 中任意单词的前缀
        if not any(word.startswith(kw) for word in name_lower.split()):
            return False
    return True
```

**错误响应**:

| code | message | 说明 |
|------|---------|------|
| 40001 | 搜索关键词不能为空 | keyword 参数缺失 |
| 40003 | 搜索关键词至少2个字符 | keyword 长度不足 |

---

### 5.3 搜索运动员接口

**接口**: `GET /api/v1/athletes/search`

**描述**: 第二阶段搜索，根据精确姓名搜索该运动员的所有比赛记录。

**请求参数**:

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| name | string | 是 | - | 精确姓名（从 suggest 接口获取），1-50字符 |
| season | int | 否 | 最近1个赛季 | 赛季筛选，1-10 |
| limit | int | 否 | 20 | 返回数量上限，最大100 |

**成功响应** (HTTP 200):

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "8_hong-kong_Chen_Mitch",
        "name": "Chen, Mitch",
        "nationality": "HKG",
        "gender": "male",
        "age_group": "35-39",
        "division": "open",
        "event_id": "LR3MS4JI36D4F8",
        "event_name": "2025 Hong Kong",
        "season": 8,
        "location": "hong-kong",
        "total_time": "01:34:45",
        "total_time_minutes": 94.75
      }
    ],
    "total": 1,
    "has_more": false
  }
}
```

**错误响应**:

| code | message | 说明 |
|------|---------|------|
| 40001 | 搜索关键词不能为空 | name 参数缺失 |
| 40002 | 搜索关键词过长 | name 超过50字符 |

**后端实现逻辑**:

```python
async def search_athletes(
    name: str,
    season: int | None = None,
    limit: int = 20
) -> dict:
    """
    搜索运动员
    
    实现逻辑:
    1. 确定搜索的赛季范围
       - 如果指定 season，只搜索该赛季
       - 否则搜索最近 2 个赛季 (7, 8)
    2. 获取目标赛季的比赛列表
    3. 遍历每场比赛，加载数据并匹配姓名
    4. 合并结果，按比赛时间倒序排列
    5. 返回前 limit 条
    
    优化策略:
    - 使用缓存减少重复请求
    - 并行加载多场比赛数据
    - 提前终止（达到 limit 后停止搜索）
    """
    from pyrox import PyroxClient
    import pandas as pd
    
    client = PyroxClient()
    results = []
    
    # 确定搜索赛季
    if season:
        seasons = [season]
    else:
        seasons = [8, 7]  # 最近两个赛季
    
    for s in seasons:
        races = client.list_races(season=s)
        
        for _, race in races.iterrows():
            try:
                race_data = client.get_race(season=s, location=race['location'])
                
                # 模糊匹配姓名（不区分大小写）
                matched = race_data[
                    race_data['name'].str.contains(name, case=False, na=False)
                ]
                
                for _, athlete in matched.iterrows():
                    results.append({
                        "id": f"{s}_{race['location']}_{athlete['name'].replace(' ', '_')}",
                        "name": athlete['name'],
                        "nationality": athlete['nationality'],
                        "gender": athlete['gender'],
                        "age_group": athlete.get('age_group', ''),
                        "division": athlete['division'],
                        "event_id": athlete['event_id'],
                        "event_name": athlete['event_name'],
                        "season": s,
                        "location": race['location'],
                        "total_time": format_time(athlete['total_time']),
                        "total_time_minutes": float(athlete['total_time']),
                    })
                    
                    if len(results) >= limit:
                        break
                        
            except Exception as e:
                # 记录日志，继续处理下一场
                logger.warning(f"Failed to load race {s}/{race['location']}: {e}")
                continue
        
        if len(results) >= limit:
            break
    
    # 按赛季和成绩排序
    results.sort(key=lambda x: (-x['season'], x['total_time_minutes']))
    
    return {
        "items": results[:limit],
        "total": len(results),
        "has_more": len(results) > limit
    }
```

### 5.3 获取成绩详情接口

**接口**: `GET /api/v1/results/{event_id}/{athlete_name}`

**路径参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| event_id | string | 比赛ID |
| athlete_name | string | 运动员姓名 (URL 编码) |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| season | int | 是 | 赛季 |
| location | string | 是 | 比赛地点 |

**成功响应** (HTTP 200):

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "athlete": {
      "name": "Chen, Mitch",
      "nationality": "HKG",
      "nationality_name": "Hong Kong",
      "gender": "male",
      "gender_display": "Men's",
      "age_group": "35-39",
      "division": "open",
      "division_display": "Open"
    },
    "race": {
      "event_id": "LR3MS4JI36D4F8",
      "event_name": "2025 Hong Kong",
      "season": 8,
      "location": "hong-kong",
      "location_display": "Hong Kong",
      "date": "Jul 26-27, 2025"
    },
    "results": {
      "total_time": "01:34:45",
      "total_time_minutes": 94.75,
      "run_time": "00:45:30",
      "run_time_minutes": 45.5,
      "run_time_percent": 48.0,
      "work_time": "00:42:15",
      "work_time_minutes": 42.25,
      "work_time_percent": 44.6,
      "roxzone_time": "00:07:00",
      "roxzone_time_minutes": 7.0,
      "roxzone_time_percent": 7.4
    },
    "rankings": {
      "overall_rank": 511,
      "overall_total": 1200,
      "gender_rank": 450,
      "gender_total": 800,
      "division_rank": 400,
      "division_total": 700,
      "age_group_rank": 122,
      "age_group_total": 280
    },
    "splits": {
      "runs": [
        {"name": "Run 1", "time": "04:30", "time_minutes": 4.5},
        {"name": "Run 2", "time": "05:15", "time_minutes": 5.25},
        {"name": "Run 3", "time": "05:00", "time_minutes": 5.0},
        {"name": "Run 4", "time": "05:30", "time_minutes": 5.5},
        {"name": "Run 5", "time": "05:45", "time_minutes": 5.75},
        {"name": "Run 6", "time": "06:00", "time_minutes": 6.0},
        {"name": "Run 7", "time": "06:15", "time_minutes": 6.25},
        {"name": "Run 8", "time": "06:45", "time_minutes": 6.75}
      ],
      "workouts": [
        {"name": "SkiErg", "time": "04:20", "time_minutes": 4.33, "distance": "1000m"},
        {"name": "Sled Push", "time": "02:10", "time_minutes": 2.17, "distance": "50m"},
        {"name": "Sled Pull", "time": "02:45", "time_minutes": 2.75, "distance": "50m"},
        {"name": "Burpee Broad Jump", "time": "03:20", "time_minutes": 3.33, "distance": "80m"},
        {"name": "Row Erg", "time": "04:50", "time_minutes": 4.83, "distance": "1000m"},
        {"name": "Farmers Carry", "time": "02:00", "time_minutes": 2.0, "distance": "200m"},
        {"name": "Sandbag Lunges", "time": "03:30", "time_minutes": 3.5, "distance": "100m"},
        {"name": "Wall Balls", "time": "04:20", "time_minutes": 4.33, "distance": "100 reps"}
      ]
    }
  }
}
```

**错误响应**:

| code | message | 说明 |
|------|---------|------|
| 40401 | 运动员不存在 | 未找到匹配的记录 |
| 40402 | 比赛不存在 | 无效的 event_id |

---

## 6. 计算逻辑

### 6.1 排名计算

```python
def calculate_rankings(
    race_data: pd.DataFrame,
    athlete_name: str
) -> dict:
    """
    计算运动员在比赛中的各项排名
    
    Args:
        race_data: 整场比赛的所有选手数据 (DataFrame)
        athlete_name: 目标运动员姓名
    
    Returns:
        包含各项排名的字典
    
    计算规则:
        - 排名按 total_time 升序，时间越短排名越靠前
        - 相同成绩并列排名
        - 无效成绩 (NaN) 不参与排名
    """
    # 过滤无效成绩
    valid_data = race_data[race_data['total_time'].notna()].copy()
    
    # 获取目标运动员记录
    athlete_mask = valid_data['name'] == athlete_name
    if not athlete_mask.any():
        raise ValueError(f"Athlete {athlete_name} not found")
    
    athlete = valid_data[athlete_mask].iloc[0]
    
    # 1. 总排名 (Overall Rank)
    valid_data_sorted = valid_data.sort_values('total_time').reset_index(drop=True)
    valid_data_sorted['overall_rank'] = range(1, len(valid_data_sorted) + 1)
    overall_rank = valid_data_sorted.loc[
        valid_data_sorted['name'] == athlete_name, 'overall_rank'
    ].iloc[0]
    
    # 2. 性别排名 (Gender Rank)
    gender_data = valid_data[valid_data['gender'] == athlete['gender']].copy()
    gender_sorted = gender_data.sort_values('total_time').reset_index(drop=True)
    gender_sorted['gender_rank'] = range(1, len(gender_sorted) + 1)
    gender_rank = gender_sorted.loc[
        gender_sorted['name'] == athlete_name, 'gender_rank'
    ].iloc[0]
    
    # 3. 组别排名 (Division Rank)
    # 同性别 + 同组别
    division_data = valid_data[
        (valid_data['gender'] == athlete['gender']) & 
        (valid_data['division'] == athlete['division'])
    ].copy()
    division_sorted = division_data.sort_values('total_time').reset_index(drop=True)
    division_sorted['division_rank'] = range(1, len(division_sorted) + 1)
    division_rank = division_sorted.loc[
        division_sorted['name'] == athlete_name, 'division_rank'
    ].iloc[0]
    
    # 4. 年龄组排名 (Age Group Rank)
    # 同性别 + 同组别 + 同年龄组
    age_group = athlete.get('age_group', '')
    if pd.notna(age_group) and age_group:
        age_group_data = valid_data[
            (valid_data['gender'] == athlete['gender']) & 
            (valid_data['division'] == athlete['division']) &
            (valid_data['age_group'] == age_group)
        ].copy()
        age_group_sorted = age_group_data.sort_values('total_time').reset_index(drop=True)
        age_group_sorted['age_group_rank'] = range(1, len(age_group_sorted) + 1)
        age_group_rank = age_group_sorted.loc[
            age_group_sorted['name'] == athlete_name, 'age_group_rank'
        ].iloc[0]
        age_group_total = len(age_group_data)
    else:
        age_group_rank = None
        age_group_total = None
    
    return {
        "overall_rank": int(overall_rank),
        "overall_total": len(valid_data),
        "gender_rank": int(gender_rank),
        "gender_total": len(gender_data),
        "division_rank": int(division_rank),
        "division_total": len(division_data),
        "age_group_rank": int(age_group_rank) if age_group_rank else None,
        "age_group_total": int(age_group_total) if age_group_total else None,
    }
```

### 6.2 时间格式化

```python
import pandas as pd

def format_time(minutes: float) -> str:
    """
    将分钟数转换为 HH:MM:SS 格式
    
    Args:
        minutes: 时间（分钟），如 94.75
    
    Returns:
        格式化的时间字符串，如 "01:34:45"
    
    Examples:
        >>> format_time(94.75)
        '01:34:45'
        >>> format_time(4.5)
        '00:04:30'
        >>> format_time(None)
        '--:--:--'
    """
    if pd.isna(minutes) or minutes is None:
        return "--:--:--"
    
    total_seconds = int(round(minutes * 60))
    hours = total_seconds // 3600
    remaining = total_seconds % 3600
    mins = remaining // 60
    secs = remaining % 60
    
    return f"{hours:02d}:{mins:02d}:{secs:02d}"


def format_time_short(minutes: float) -> str:
    """
    将分钟数转换为 MM:SS 格式（用于分段成绩）
    
    Args:
        minutes: 时间（分钟），如 4.5
    
    Returns:
        格式化的时间字符串，如 "04:30"
    
    Examples:
        >>> format_time_short(4.5)
        '04:30'
        >>> format_time_short(None)
        '--:--'
    """
    if pd.isna(minutes) or minutes is None:
        return "--:--"
    
    total_seconds = int(round(minutes * 60))
    mins = total_seconds // 60
    secs = total_seconds % 60
    
    return f"{mins:02d}:{secs:02d}"


def calculate_time_percent(part_time: float, total_time: float) -> float:
    """
    计算时间占比
    
    Args:
        part_time: 部分时间（分钟）
        total_time: 总时间（分钟）
    
    Returns:
        百分比，保留一位小数
    
    Examples:
        >>> calculate_time_percent(45.5, 94.75)
        48.0
    """
    if pd.isna(part_time) or pd.isna(total_time) or total_time == 0:
        return 0.0
    
    return round((part_time / total_time) * 100, 1)
```

### 6.3 分段成绩提取

```python
# 功能站配置
WORKOUT_STATIONS = [
    {"key": "skiErg_time", "name": "SkiErg", "distance": "1000m"},
    {"key": "sledPush_time", "name": "Sled Push", "distance": "50m"},
    {"key": "sledPull_time", "name": "Sled Pull", "distance": "50m"},
    {"key": "burpeeBroadJump_time", "name": "Burpee Broad Jump", "distance": "80m"},
    {"key": "rowErg_time", "name": "Row Erg", "distance": "1000m"},
    {"key": "farmersCarry_time", "name": "Farmers Carry", "distance": "200m"},
    {"key": "sandbagLunges_time", "name": "Sandbag Lunges", "distance": "100m"},
    {"key": "wallBalls_time", "name": "Wall Balls", "distance": "100 reps"},
]

# 跑步分段配置
RUN_SEGMENTS = [
    {"key": "run1_time", "name": "Run 1"},
    {"key": "run2_time", "name": "Run 2"},
    {"key": "run3_time", "name": "Run 3"},
    {"key": "run4_time", "name": "Run 4"},
    {"key": "run5_time", "name": "Run 5"},
    {"key": "run6_time", "name": "Run 6"},
    {"key": "run7_time", "name": "Run 7"},
    {"key": "run8_time", "name": "Run 8"},
]


def extract_splits(athlete_data: dict) -> dict:
    """
    提取分段成绩
    
    Args:
        athlete_data: 运动员单条记录数据
    
    Returns:
        包含 runs 和 workouts 的字典
    """
    runs = []
    for segment in RUN_SEGMENTS:
        time_val = athlete_data.get(segment["key"])
        runs.append({
            "name": segment["name"],
            "time": format_time_short(time_val),
            "time_minutes": float(time_val) if pd.notna(time_val) else None,
        })
    
    workouts = []
    for station in WORKOUT_STATIONS:
        time_val = athlete_data.get(station["key"])
        workouts.append({
            "name": station["name"],
            "time": format_time_short(time_val),
            "time_minutes": float(time_val) if pd.notna(time_val) else None,
            "distance": station["distance"],
        })
    
    return {
        "runs": runs,
        "workouts": workouts,
    }
```

---

## 7. 数据定义

### 7.1 比赛日期映射表

```python
# 静态维护的比赛日期映射
# 格式: (season, location) -> {date, city}
RACE_DATES = {
    # Season 8 (2025/26)
    ("8", "hong-kong"): {"date": "Jul 26-27, 2025", "city": "Hong Kong"},
    ("8", "shanghai"): {"date": "Aug 16-17, 2025", "city": "Shanghai"},
    ("8", "beijing"): {"date": "Dec 6-7, 2025", "city": "Beijing"},
    ("8", "singapore-expo"): {"date": "Mar 8-9, 2025", "city": "Singapore"},
    
    # Season 7 (2024/25)
    ("7", "hong-kong"): {"date": "Jul 27-28, 2024", "city": "Hong Kong"},
    ("7", "amsterdam"): {"date": "Nov 9-10, 2024", "city": "Amsterdam"},
    ("7", "beijing"): {"date": "Dec 7-8, 2024", "city": "Beijing"},
    ("7", "shanghai"): {"date": "Sep 14-15, 2024", "city": "Shanghai"},
    ("7", "london"): {"date": "Oct 12-13, 2024", "city": "London"},
    
    # 更多比赛可按需添加...
}


def get_race_info(season: int, location: str) -> dict:
    """
    获取比赛详情信息
    
    Args:
        season: 赛季编号
        location: 比赛地点代码
    
    Returns:
        包含 date 和 city 的字典
    """
    key = (str(season), location)
    if key in RACE_DATES:
        return RACE_DATES[key]
    
    # 默认返回：地点代码格式化为城市名
    city = location.replace("-", " ").title()
    return {
        "date": "",  # 未知日期
        "city": city
    }
```

### 7.2 国籍代码映射

```python
# 常用国籍代码 -> 国家名称
NATIONALITY_NAMES = {
    "CHN": "China",
    "HKG": "Hong Kong",
    "TPE": "Taiwan",
    "MAC": "Macau",
    "USA": "United States",
    "GBR": "United Kingdom",
    "GER": "Germany",
    "FRA": "France",
    "IRL": "Ireland",
    "NED": "Netherlands",
    "AUS": "Australia",
    "JPN": "Japan",
    "KOR": "South Korea",
    "SIN": "Singapore",
    # 更多可按需添加
}


def get_nationality_name(code: str) -> str:
    """获取国籍名称"""
    return NATIONALITY_NAMES.get(code, code)
```

### 7.3 显示名称映射

```python
# 性别显示
GENDER_DISPLAY = {
    "male": "Men's",
    "female": "Women's",
    "mixed": "Mixed",
}

# 组别显示
DIVISION_DISPLAY = {
    "open": "Open",
    "pro": "Pro",
    "doubles": "Doubles",
    "pro_doubles": "Pro Doubles",
}


def get_gender_display(gender: str) -> str:
    """获取性别显示名"""
    return GENDER_DISPLAY.get(gender, gender.title())


def get_division_display(division: str) -> str:
    """获取组别显示名"""
    return DIVISION_DISPLAY.get(division, division.title())
```

---

## 8. 技术实现

### 8.1 后端目录结构

```
backend/app/
├── __init__.py
├── main.py                     # FastAPI 入口
├── api/
│   ├── __init__.py
│   ├── deps.py                 # 依赖注入
│   └── v1/
│       ├── __init__.py
│       ├── router.py           # 路由汇总
│       ├── athletes.py         # 搜索接口
│       └── results.py          # 成绩详情接口
├── services/
│   ├── __init__.py
│   ├── athlete_service.py      # 运动员搜索服务
│   ├── result_service.py       # 成绩查询服务
│   └── ranking_service.py      # 排名计算服务
├── core/
│   ├── __init__.py
│   ├── hyrox_client.py         # pyrox-client 封装
│   └── exceptions.py           # 自定义异常
├── models/
│   ├── __init__.py
│   └── schemas.py              # Pydantic 模型
├── utils/
│   ├── __init__.py
│   ├── time_format.py          # 时间格式化
│   └── constants.py            # 常量定义
└── config/
    ├── __init__.py
    └── settings.py             # 配置
```

### 8.2 前端目录结构

```
miniprogram/miniprogram/
├── app.js
├── app.json
├── app.wxss
├── pages/
│   ├── index/                  # 搜索页（首页）
│   │   ├── index.js
│   │   ├── index.json
│   │   ├── index.wxml
│   │   └── index.wxss
│   └── result/                 # 成绩详情页
│       ├── result.js
│       ├── result.json
│       ├── result.wxml
│       └── result.wxss
├── components/
│   ├── athlete-card/           # 运动员卡片组件
│   ├── rank-card/              # 排名卡片组件
│   ├── time-bar/               # 时间占比条
│   └── split-item/             # 分段成绩项
├── services/
│   ├── api.js                  # API 接口
│   ├── request.js              # 请求封装
│   └── config.js               # 配置
└── utils/
    └── util.js                 # 工具函数
```

### 8.3 技术依赖

**后端**:
```
fastapi>=0.109.0
uvicorn>=0.27.0
pydantic>=2.5.0
pyrox-client>=0.1.0
pandas>=2.0.0
python-dotenv>=1.0.0
```

**前端**:
```json
{
  "dependencies": {
    "@vant/weapp": "^1.11.0"
  }
}
```

---

## 9. 非功能需求

### 9.1 性能要求

| 指标 | 要求 |
|------|------|
| 搜索接口响应时间 | P95 < 3s |
| 详情接口响应时间 | P95 < 2s |
| 前端首屏加载 | < 2s |

### 9.2 可用性

| 指标 | 要求 |
|------|------|
| 服务可用性 | 99% |
| 错误率 | < 1% |

### 9.3 兼容性

| 平台 | 要求 |
|------|------|
| 微信小程序基础库 | >= 2.20.0 |
| iOS | >= 11.0 |
| Android | >= 5.0 |

---

## 10. 排期计划

| 阶段 | 时间 | 负责人 | 产出 |
|------|------|--------|------|
| PRD 评审 | Day 1 | PM | 需求确认 |
| 技术设计 | Day 1 | 开发 | 技术方案 |
| 后端开发 | Day 2-3 | 后端 | API 接口 |
| 前端开发 | Day 3-4 | 前端 | 小程序页面 |
| 联调测试 | Day 5 | 全员 | 功能可用 |
| Bug 修复 | Day 6 | 全员 | 问题修复 |
| 发布上线 | Day 7 | 运维 | MVP 上线 |

---

## 11. 风险与依赖

### 11.1 风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| pyrox-client 不稳定 | 高 | 中 | 增加缓存，降级方案 |
| 搜索性能差 | 中 | 高 | 预加载热门比赛，限制搜索范围 |
| 数据缺失 | 低 | 中 | 友好提示，优雅降级 |

### 11.2 依赖

- pyrox-client 库可正常工作
- HYROX 官方数据源稳定

---

## 12. 附录

### 12.1 HYROX 比赛流程

```
起点 → Run 1 (1km) → SkiErg (1000m)
                          ↓
         Run 2 (1km) → Sled Push (50m)
                          ↓
         Run 3 (1km) → Sled Pull (50m)
                          ↓
         Run 4 (1km) → Burpee Broad Jump (80m)
                          ↓
         Run 5 (1km) → Row Erg (1000m)
                          ↓
         Run 6 (1km) → Farmers Carry (200m)
                          ↓
         Run 7 (1km) → Sandbag Lunges (100m)
                          ↓
         Run 8 (1km) → Wall Balls (100次) → 终点

总计: 8km 跑步 + 8 个功能站
```

### 12.2 参考资料

- [Roxlab 官网](https://www.roxlab.app)
- [HYROX 官方结果](https://results.hyrox.com)
- [pyrox-client 文档](https://pypi.org/project/pyrox-client/)

