# PRD v3.1: 比赛数据 Tab 功能迭代

## 一、版本信息

| 项目 | 内容 |
|------|------|
| 版本号 | v3.1 |
| 功能名称 | 比赛数据 Tab 搜索流程 & 真实数据展示 |
| 迭代日期 | 2026-01-21 |
| 状态 | **已完成** |

### 版本变更记录

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v3.0 | 2026-01-21 | 初始版本：搜索流程、真实数据对接 |
| v3.1 | 2026-01-21 | 流程优化：移除 RACE_LIST，HUB 排序、角标，分段排序修复 |

---

## 二、功能概述

将"比赛数据"Tab 从静态 Mock 数据展示，改为**先搜索后展示**的交互模式，对接后端真实 API 数据。

### 核心变更
1. DataTab 首次进入显示搜索引导页，引导用户搜索运动员
2. 搜索流程复用 LiveTab 的搜索逻辑
3. 选择比赛后展示真实数据（替换 Mock 数据）
4. 新增后端分段统计接口，支持 Top% 和 Δ Avg 计算

---

## 三、用户流程

```
用户点击"比赛数据" Tab
        │
        ▼
    ┌─────────────────┐
    │ 是否已选择运动员？ │
    └─────────────────┘
        │
    ┌───┴───┐
    │       │
    否      是
    │       │
    ▼       ▼
搜索引导页  数据中心 HUB
    │
    ▼
点击"搜索运动员"
    │
    ▼
搜索页面（输入关键词）
    │
    ▼
显示候选列表（suggest API）
    │
    ▼
点击候选 → 数据中心 HUB（直接显示全部比赛卡片）
    │          ↑
    │          │ (v3.1 变更：移除 RACE_LIST 中间页)
    │          │
    ├── 点击卡片 → 比赛总结 SUMMARY
    │       │
    │       ├── 进入分段中心 → SPLIT_CENTER
    │       │       │
    │       │       └── 点击站点 → 站点深挖 STATION_DETAIL
    │       │
    │       └── 生成海报 → 战报海报 POSTER
```

### v3.1 流程优化

**变更前**: 搜索 → 选择名称 → **比赛列表(RACE_LIST)** → 选择比赛 → HUB(1卡片) → SUMMARY

**变更后**: 搜索 → 选择名称 → **HUB(全部比赛卡片)** → 点击卡片 → SUMMARY

---

## 四、页面状态设计

| 状态 | 触发条件 | 页面内容 |
|------|---------|---------|
| **SEARCH_PROMPT** | 首次进入 Tab | 引导页：大按钮"搜索运动员查看比赛数据" |
| **SEARCH_ACTIVE** | 点击搜索 | 搜索框 + 候选列表 |
| ~~RACE_LIST~~ | ~~选择候选人~~ | ~~该运动员所有比赛记录列表~~ (v3.1 移除) |
| **HUB** | 选择候选人 | 数据中心：**全部比赛卡片列表**（按赛季降序） |
| **SUMMARY** | 点击卡片 | 单场比赛总结 |
| **SPLIT_CENTER** | 点击进入分段 | 分段成绩（3个 Tab：总览/Run/Station） |
| **STATION_DETAIL** | 点击站点 | 站点深挖详情 |
| **POSTER** | 点击生成海报 | 战报海报预览 |

---

## 五、数据字段处理

### 5.1 正常展示字段

| 前端字段 | 数据来源 | 备注 |
|---------|---------|------|
| 比赛名称 | `race.event_name` | |
| 比赛类型 | `division` | open/pro → SINGLE，doubles → DOUBLES |
| 总成绩 | `results.total_time` | |
| 总排名 | `rankings.overall_rank` | |
| TOP% 徽章 | 计算：`rank/total*100` | |
| 跑步总时长 | `results.run_time` | |
| 站点总时长 | `results.work_time` | |
| Roxzone 总时长 | `results.roxzone_time` | |
| 8段跑步时间 | `splits.runs[]` | |
| 8个站点时间 | `splits.workouts[]` | |
| 各分段 Top% | `analytics.splits_analytics[].top_percent` | 新增接口 |
| 各分段 Δ Avg | `analytics.splits_analytics[].diff_display` | 新增接口 |

### 5.2 缺失字段处理

| 缺失字段 | 处理方案 |
|---------|---------|
| **Bib 号码** | 隐藏，不展示 |
| **Roxzone 8段拆解** | 隐藏 ROXZONE Tab，总览中只显示总时间 |
| **RELAY 类型** | 不展示，只支持 SINGLE/DOUBLES |
| **AI 诊断建议** | 显示占位："AI 分析功能即将上线" |

---

## 六、计算逻辑

### 6.1 TOP% 徽章计算

**公式**：
```
top_percent = (overall_rank / overall_total) * 100
```

**展示规则**：
| 计算结果 | 展示文案 | 样式 |
|---------|---------|------|
| ≤ 5% | TOP 5% | 金色高亮 |
| ≤ 10% | TOP 10% | 绿色高亮 |
| ≤ 20% | TOP 20% | 绿色 |
| ≤ 50% | TOP 50% | 白色 |
| > 50% | 不显示徽章 | - |

### 6.2 比赛类型推断

**映射规则**：
```
division = 'open' 或 'pro' → SINGLE
division = 'doubles' 或 'pro_doubles' → DOUBLES
```

**队友名称提取**（DOUBLES 时）：
```
name = "Florence Chan, Megan Cheng"
→ 队友: ["Florence Chan", "Megan Cheng"]
```

### 6.3 各分段 Top% 计算

**逻辑**：
1. 获取全场该分段的有效数据
2. 计算该运动员在该分段的排名（时间越短排名越前）
3. 计算百分位：`(rank / total) * 100`

**展示规则**：
| 计算结果 | 展示颜色 |
|---------|---------|
| ≤ 20% | 绿色 (text-primary) |
| 21-50% | 白色 |
| > 50% | 黄色/橙色 (警告色) |

### 6.4 各分段 Δ Avg 计算

**逻辑**：
1. 计算全场该分段的平均时间
2. 计算差距：`运动员时间 - 平均时间`
3. 转换为秒数显示

**展示规则**：
| 差距 | 展示格式 | 颜色 |
|-----|---------|------|
| < 0 | "-26s" | 绿色 (快于平均) |
| = 0 | "0s" | 白色 |
| > 0 | "+12s" | 黄色 (慢于平均) |

### 6.5 进度条计算

**公式**：
```
progress = 100 - top_percent
```
Top% 越低，进度条越长（表示表现越好）

---

## 七、后端接口变更

### 7.1 Bug 修复

修复 `constants.py` 站点字段映射错误（7个字段名）

### 7.2 新增接口

**路径**：`GET /api/v1/results/{season}/{location}/{name}/analytics`

**响应数据**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "splits_analytics": [
      {
        "name": "Run 1",
        "type": "run",
        "time": "04:12",
        "time_minutes": 4.12,
        "rank": 42,
        "total": 412,
        "top_percent": 10.2,
        "avg_time_minutes": 4.55,
        "diff_seconds": -26,
        "diff_display": "-26s"
      }
    ]
  }
}
```

---

## 八、UI 调整

### 8.1 SPLIT_CENTER Tab 变更

| 原设计 | 新设计 |
|--------|--------|
| 4个 Tab：总览/Run/Station/Roxzone | 3个 Tab：总览/Run/Station |

### 8.2 SUMMARY 页面变更

- 移除 Bib 号码显示
- 保留其他字段不变

### 8.3 诊断建议区域

- 显示卡片样式
- 内容："AI 分析功能即将上线"
- 图标：`smart_toy` + 锁定样式

### 8.4 HUB 页面变更 (v3.1)

| 项目 | 变更内容 |
|------|---------|
| 卡片排序 | 按 `season` 降序排列，最新赛季在最上面 |
| 卡片角标 | 显示 "FINISHER" 角标（因 AthleteSearchItem 无排名数据，暂无法计算 TOP XX%） |
| 底部信息 | 从 "Season S7" 改为 "查看分段排名" |
| 标题旁赛季 | 显示在比赛名称旁，如 "HYROX BERLIN S7" |

### 8.5 SPLIT_CENTER 总览 Tab 变更 (v3.1)

| 项目 | 变更内容 |
|------|---------|
| 排序方式 | 交替显示：R1, S1, R2, S2, R3, S3... |
| R/S 标签计算 | 根据类型动态计数，而非索引位置 |

### 8.6 RUN/STATION Tab 样式 (v3.1)

| Tab | 百分比格式 | 进度条颜色逻辑 |
|-----|-----------|---------------|
| RUN | `15%` (不带 TOP) | < 30%: 绿色, 30-50%: 灰色, > 50%: 黄色 |
| STATION | `TOP 15%` (带 TOP) | < 40%: 绿色, > 40%: 橙色, > 60%: 橙色+警告图标 |

---

## 九、验收标准

### v3.0 基础功能
1. ✅ 点击"比赛数据"Tab，首次进入显示搜索引导页
2. ✅ 搜索流程正常：输入 → 候选 → 数据展示
3. ✅ 比赛卡片正确显示 SINGLE/DOUBLES 类型
4. ✅ 8个站点时间正确显示（非 null）
5. ✅ 分段 Top% 和 Δ Avg 正确显示
6. ✅ ROXZONE Tab 已隐藏
7. ✅ AI 诊断区域显示"即将上线"
8. ✅ Bib 号码字段已隐藏
9. ✅ RELAY 卡片样式已移除

### v3.1 流程优化
10. ✅ 移除 RACE_LIST 中间页，选择名称后直接进入 HUB
11. ✅ HUB 页面比赛卡片按赛季降序排序（最新比赛在最上面）
12. ✅ HUB 页面卡片显示 FINISHER 角标
13. ✅ SPLIT_CENTER 总览 Tab 交替显示 R1,S1,R2,S2...
14. ✅ RUN Tab 百分比显示为 "15%" 格式（非 "TOP 15%"）
15. ✅ STATION Tab 百分比显示为 "TOP 15%" 格式
16. ✅ SUMMARY → HUB 返回逻辑正常

---

## 十、相关文档

- [API 文档: v3.0 Analytics API](../api/v3.0-analytics-api.md)
- [本地开发指南](../deployment/v2.0-local-dev-guide.md)

