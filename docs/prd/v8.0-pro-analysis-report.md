# PRD v8.0 - 专业分析报告功能

## 版本信息
- **版本号**: v8.0
- **日期**: 2026-01-27
- **状态**: 已完成

## 背景

用户在查看 Lite 版快速分析后，希望获得更详细、更专业的赛事分析报告。专业报告需要：
1. 多维度深入分析（总体表现、跑步能力、功能站、体能分配、训练建议）
2. 数据可视化图表（柱状图、折线图、雷达图等）
3. 与同组别选手的对比分析
4. 可导出为 PDF 保存

## 功能概述

### 入口
- 在 Lite 分析页面，点击"¥9.9 解锁详细分段报告"按钮
- 本地测试版本使用模拟支付

### 报告生成流程
1. 用户点击解锁按钮
2. 后端创建报告记录，返回 report_id
3. 前端通过 SSE 订阅生成进度
4. 后端 Multi-Agent 系统生成报告内容
5. 完成后前端显示"查看分析报告"按钮

### 报告内容结构
```
┌─────────────────────────────────────┐
│ [Header] 运动员信息 + 比赛信息      │
├─────────────────────────────────────┤
│ [Introduction] 报告摘要             │
├─────────────────────────────────────┤
│ [Section 1] 总体表现概述            │
│   - 发现点 + 数据表格 + 图表        │
├─────────────────────────────────────┤
│ [Section 2] 跑步能力分析            │
├─────────────────────────────────────┤
│ [Section 3] 功能站表现分析          │
├─────────────────────────────────────┤
│ [Section 4] 体能分配策略分析        │
├─────────────────────────────────────┤
│ [Section 5] 训练提升建议            │
├─────────────────────────────────────┤
│ [Conclusion] 总结与建议             │
└─────────────────────────────────────┘
```

## 技术架构

### Multi-Agent 系统

参考 chat2ex 项目设计，简化后的 Agent 架构：

```
┌─────────────────────────────────────────────────────────┐
│                    ReportGenerator                       │
│                    (流程编排)                            │
├─────────────────────────────────────────────────────────┤
│                                                          │
│   ┌─────────────┐    ┌─────────────┐    ┌────────────┐  │
│   │ Researcher  │    │   Chart     │    │  Summary   │  │
│   │   Agent     │───▶│   Agent     │    │   Agent    │  │
│   │ (章节分析)   │    │ (图表生成)   │    │ (摘要生成) │  │
│   └──────┬──────┘    └─────────────┘    └────────────┘  │
│          │                                               │
│          ▼                                               │
│   ┌─────────────┐    ┌─────────────┐                    │
│   │    Data     │    │  Section    │                    │
│   │  Executor   │◀───│  Processor  │                    │
│   │ (数据查询)   │    │ (章节处理)   │                    │
│   └─────────────┘    └─────────────┘                    │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. DataExecutor (数据执行器)
执行数据查询函数，支持 7 种查询类型：

| 函数名 | 用途 | 参数 |
|--------|------|------|
| GetAthleteResult | 运动员单场成绩 | season, location, athlete_name |
| GetDivisionStats | 组别统计数据 | season, location, gender, division |
| GetDivisionRanking | 组别排行榜 | season, location, gender, division, sort_by |
| GetSegmentComparison | 分段对比数据 | season, location, athlete_name, segment_type |
| GetAthleteHistory | 运动员历史记录 | athlete_name, limit |
| GetPacingAnalysis | 配速分析 | season, location, athlete_name |
| GetStationDeepAnalysis | 功能站深度分析 | season, location, athlete_name, station_name |

#### 2. ResearcherAgent (研究 Agent)
- 使用 LLM + Function Calling 生成章节内容
- 工具：Search（调用数据函数）、Section（输出结果）
- 提示词包含：思维链框架、发现类型规范、图表需求规范

#### 3. ChartAgent (图表 Agent)
- 根据数据和分析目的生成 ECharts 配置
- 支持 bar、line、radar、pie 四种图表类型
- 自动应用深色科技风主题

#### 4. SectionProcessor (章节处理器)
- 处理 ResearcherAgent 输出
- 调用 ChartAgent 生成图表配置
- 在 Markdown 内容中插入 `[CHART:chart_id]` 标记

#### 5. SummaryAgent (摘要 Agent)
- 生成报告引言和总结
- 基于所有章节内容汇总

### 数据库模型

```python
class ProReport(Base):
    __tablename__ = "pro_reports"
    
    id = Column(Integer, primary_key=True)
    report_id = Column(String(36), unique=True, index=True)  # UUID
    user_id = Column(Integer, nullable=True)
    season = Column(Integer, nullable=False)
    location = Column(String(50), nullable=False)
    athlete_name = Column(String(100), nullable=False)
    gender = Column(String(10), nullable=True)
    division = Column(String(20), nullable=True)
    
    title = Column(String(200))
    introduction = Column(Text)       # 引言
    sections = Column(Text)           # 章节内容 (JSON)
    charts = Column(Text)             # 图表配置 (JSON)
    conclusion = Column(Text)         # 总结
    
    status = Column(String(20), default="pending")  # pending/generating/completed/error
    progress = Column(Integer, default=0)
    current_step = Column(String(100))
    error_message = Column(Text)
    
    created_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
```

### API 接口

#### 创建报告
```
POST /api/v1/reports/create
Request: { season, location, athlete_name, user_id? }
Response: { report_id, status, message }
```

#### 订阅生成进度 (SSE)
```
GET /api/v1/reports/generate/{report_id}
Events: progress, complete, error
```

#### 获取报告详情
```
GET /api/v1/reports/detail/{report_id}
Response: { report_id, title, introduction, sections, charts, conclusion, ... }
```

### 前端实现

#### 报告页面样式
- 深色科技风设计（类似数据大屏）
- 渐变背景 + 发光边框效果
- 每个章节使用不同主题色

#### ECharts 深色主题
```typescript
const DARK_THEME_COLORS = [
  '#00d4ff', // 青色
  '#7c3aed', // 紫色
  '#10b981', // 绿色
  '#f59e0b', // 橙色
  '#ef4444', // 红色
  '#3b82f6', // 蓝色
];
```

#### PDF 导出
- 使用 html2pdf.js 客户端生成
- 支持 A4 纵向格式

## 文件结构

### 后端新增文件
```
backend/app/services/report/
├── __init__.py
├── data_functions.py      # 数据函数知识库
├── data_executor.py       # 数据执行器
├── section_definitions.py # 章节定义
├── researcher_agent.py    # 研究 Agent
├── chart_agent.py         # 图表 Agent
├── section_processor.py   # 章节处理器
├── summary_agent.py       # 摘要 Agent
└── report_generator.py    # 报告生成器
```

### 前端新增/修改文件
```
frontend/src/
├── components/
│   └── ReportChart.tsx    # ECharts 图表组件
├── screens/
│   └── LiveTab.tsx        # 报告生成 + 渲染逻辑
└── types.ts               # ProReportDetail 类型
```

## LLM 配置

- **服务商**: 阿里云百炼
- **模型**: qwen-max-latest
- **API 兼容**: OpenAI 格式
- **配置文件**: `backend/data/llm_config.json`

```json
{
  "api_key": "sk-xxx",
  "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
  "agents": {
    "default": { "model": "qwen-max-latest", "temperature": 0.7, "max_tokens": 4096 },
    "research": { "model": "qwen-max-latest", "temperature": 0.5, "max_tokens": 8192 },
    "chart": { "model": "qwen-max-latest", "temperature": 0.3, "max_tokens": 2048 },
    "summary": { "model": "qwen-max-latest", "temperature": 0.6, "max_tokens": 4096 }
  }
}
```

## 验收标准

1. [x] 点击"¥9.9 解锁"按钮后显示进度条
2. [x] 进度实时更新（5% → 100%）
3. [x] 报告生成完成后按钮变为"查看分析报告"
4. [x] 报告页面正确渲染 Markdown 内容
5. [x] 数据表格正确显示
6. [x] ECharts 图表正确渲染（深色主题）
7. [x] PDF 导出功能正常
8. [x] 已存在的报告可直接查看

## 已知问题 & 后续优化

1. **图表生成率**: 当前 LLM 不一定每次都输出 chart_requirements，图表覆盖率约 60-70%
2. **生成时间**: 完整报告生成约需 3-5 分钟，可考虑增加缓存或预生成
3. **历史数据**: 部分运动员无历史数据，相关分析会跳过

## 相关文档

- [API 文档](../api/v8.0-report-api.md)
- [部署指南](../deployment/quick-start.md)
