# API v10.0 - æ—¶é—´æŸè€—åˆ†æåŠŸèƒ½æŠ€æœ¯æ–‡æ¡£

## ç‰ˆæœ¬ä¿¡æ¯
- **ç‰ˆæœ¬å·**: v10.0
- **æ—¥æœŸ**: 2026-01-29
- **çŠ¶æ€**: å·²å®Œæˆ
- **å…³è”PRD**: [v10.0-time-loss-analysis-improvement.md](./../prd/v10.0-time-loss-analysis-improvement.md)

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°æ—¶é—´æŸè€—åˆ†æåŠŸèƒ½çš„æŠ€æœ¯å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬æ•°æ®è®¡ç®—é€»è¾‘ä¼˜åŒ–å’Œç€‘å¸ƒå›¾å¯è§†åŒ–æ”¹è¿›ã€‚

## æ¶æ„æ¦‚è§ˆ

æ—¶é—´æŸè€—åˆ†æåŠŸèƒ½åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š

1. **åç«¯æ•°æ®è®¡ç®—** (`data_provider.py`)ï¼šè®¡ç®—æ—¶é—´æŸè€—æ•°æ®
2. **å‰ç«¯å¯è§†åŒ–** (`TimeLossWaterfall.tsx`)ï¼šæ¸²æŸ“ç€‘å¸ƒå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯: æ•°æ®è®¡ç®—å±‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ data_provider.py                  â”‚  â”‚
â”‚  â”‚ _calculate_time_loss_analysis()  â”‚  â”‚
â”‚  â”‚   â”œâ”€ è½¬æ¢åŒºæŸè€—è®¡ç®—               â”‚  â”‚
â”‚  â”‚   â”œâ”€ é…é€ŸæŸè€—è®¡ç®—ï¼ˆæ”¹è¿›ï¼‰         â”‚  â”‚
â”‚  â”‚   â””â”€ åŠŸèƒ½ç«™æŸè€—è®¡ç®—ï¼ˆæ”¹è¿›ï¼‰       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  TimeLossAnalysisData â”‚
         â”‚  - transition_loss    â”‚
         â”‚  - pacing_loss        â”‚
         â”‚  - station_losses[]   â”‚
         â”‚  - total_loss_seconds â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯: å¯è§†åŒ–å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TimeLossWaterfall.tsx             â”‚  â”‚
â”‚  â”‚   â”œâ”€ æ•°æ®å¤„ç†                     â”‚  â”‚
â”‚  â”‚   â”œâ”€ EChartsé…ç½®                  â”‚  â”‚
â”‚  â”‚   â””â”€ å¯è§†åŒ–æ¸²æŸ“ï¼ˆæ”¹è¿›ï¼‰           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åç«¯å®ç°

### æ–‡ä»¶ä½ç½®
`backend/app/services/report/data_provider.py`

### æ ¸å¿ƒæ–¹æ³•

#### `_calculate_time_loss_analysis()`

è®¡ç®—æ—¶é—´æŸè€—åˆ†ææ•°æ®ã€‚

**æ–¹æ³•ç­¾å**ï¼š
```python
def _calculate_time_loss_analysis(
    self,
    athlete_result: AthleteResultData,
    division_stats: Optional[DivisionStatsData],
    segment_comparison: Optional[SegmentComparisonData],
) -> TimeLossAnalysisData
```

**è®¡ç®—é€»è¾‘**ï¼š

##### 1. è½¬æ¢åŒºæŸè€—è®¡ç®—

```python
# 1. è½¬æ¢åŒºæŸè€—
if athlete_result.roxzone_time and division_stats and division_stats.roxzone_time:
    avg_roxzone = division_stats.roxzone_time.avg
    if avg_roxzone:
        loss_seconds = (athlete_result.roxzone_time - avg_roxzone) * 60
        if loss_seconds > 0:  # åªè®¡ç®—æ­£æŸè€—
            analysis.transition_loss = TimeLossItem(...)
            total_loss += loss_seconds
```

**é€»è¾‘è¯´æ˜**ï¼š
- è®¡ç®—è¿åŠ¨å‘˜è½¬æ¢åŒºæ—¶é—´ä¸ç»„åˆ«å¹³å‡å€¼çš„å·®è·
- åªè®¡ç®—æ­£æŸè€—ï¼ˆè¿åŠ¨å‘˜æ—¶é—´ > å¹³å‡å€¼ï¼‰
- è½¬æ¢ä¸ºç§’æ•°ï¼ˆåŸå§‹æ•°æ®ä¸ºåˆ†é’Ÿï¼‰

**å˜æ›´**ï¼šæ— å˜æ›´ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰

##### 2. é…é€ŸæŸè€—è®¡ç®—ï¼ˆå·²æ”¹è¿›ï¼‰

**åŸé€»è¾‘**ï¼š
```python
# åªè®¡ç®—Run8 vs å‰4æ®µå¹³å‡ï¼Œé˜ˆå€¼30ç§’
run8_time = athlete_result.run8_time
if valid_run_times and run8_time:
    avg_first_4 = sum(valid_run_times) / len(valid_run_times)
    pacing_loss_seconds = (run8_time - avg_first_4) * 60
    if pacing_loss_seconds > 30:  # é˜ˆå€¼30ç§’
        analysis.pacing_loss = TimeLossItem(...)
```

**æ–°é€»è¾‘**ï¼š
```python
# è®¡ç®—Run5-Run8 vs å‰4æ®µå¹³å‡ï¼Œé˜ˆå€¼20ç§’
later_runs = [
    (5, athlete_result.run5_time),
    (6, athlete_result.run6_time),
    (7, athlete_result.run7_time),
    (8, athlete_result.run8_time),
]

for run_num, run_time in later_runs:
    if run_time:
        pacing_loss_seconds = (run_time - avg_first_4) * 60
        if pacing_loss_seconds > 20:  # é˜ˆå€¼é™ä½åˆ°20ç§’
            pacing_losses.append({
                'run_num': run_num,
                'loss_seconds': pacing_loss_seconds,
                'run_time': run_time,
            })

# é€‰æ‹©æœ€ä¸¥é‡çš„ä¸€æ®µä½œä¸ºä¸»è¦æŸè€—
if pacing_losses:
    pacing_losses.sort(key=lambda x: x['loss_seconds'], reverse=True)
    main_loss = pacing_losses[0]
    # å¦‚æœæœ‰å¤šä¸ªæŸè€—æ®µï¼Œåœ¨æè¿°ä¸­è¯´æ˜
    if len(pacing_losses) > 1:
        description = f"é…é€Ÿå´©ç›˜æŸè€—ï¼ˆRun{main_loss['run_num']} vs å‰4æ®µå¹³å‡ï¼Œ{', '.join(other_runs)}ä¹Ÿæœ‰æŸè€—ï¼‰"
    else:
        description = f"é…é€Ÿå´©ç›˜æŸè€—ï¼ˆRun{main_loss['run_num']} vs å‰4æ®µå¹³å‡ï¼‰"
```

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… è®¡ç®—Run5-Run8ï¼Œè€Œä¸ä»…ä»…æ˜¯Run8
2. âœ… é˜ˆå€¼ä»30ç§’é™ä½åˆ°20ç§’
3. âœ… å¦‚æœæœ‰å¤šä¸ªæŸè€—æ®µï¼Œåœ¨æè¿°ä¸­è¯´æ˜

##### 3. åŠŸèƒ½ç«™æŸè€—è®¡ç®—ï¼ˆå·²æ”¹è¿›ï¼‰

**åŸé€»è¾‘**ï¼š
```python
# åªä¸TOP25%æ¯”è¾ƒï¼Œé˜ˆå€¼10ç§’
for segment in segment_comparison.station_segments:
    field_stats = getattr(division_stats, segment.segment_field, None)
    if field_stats and field_stats.p25 and segment.athlete_time:
        gap_seconds = (segment.athlete_time - field_stats.p25) * 60
        if gap_seconds > 10:  # é˜ˆå€¼10ç§’
            station_losses.append(TimeLossItem(...))
```

**æ–°é€»è¾‘**ï¼š
```python
# åŒæ—¶ä¸å¹³å‡å€¼å’ŒTOP25%æ¯”è¾ƒï¼Œä¼˜å…ˆä½¿ç”¨å¹³å‡å€¼ï¼Œé˜ˆå€¼5ç§’
for segment in segment_comparison.station_segments:
    field_stats = getattr(division_stats, segment.segment_field, None)
    if field_stats and segment.athlete_time:
        # è®¡ç®—ä¸å¹³å‡å€¼å’ŒTOP25%çš„å·®è·
        gap_vs_avg = (segment.athlete_time - field_stats.avg) * 60 if field_stats.avg else None
        gap_vs_p25 = (segment.athlete_time - field_stats.p25) * 60 if field_stats.p25 else None
        
        # ä¼˜å…ˆä½¿ç”¨å¹³å‡å€¼å·®è·
        gap_seconds = None
        reference_value = None
        reference_label = None
        
        if gap_vs_avg is not None and gap_vs_avg > 0:
            gap_seconds = gap_vs_avg
            reference_value = field_stats.avg
            reference_label = "å¹³å‡å€¼"
        elif gap_vs_p25 is not None and gap_vs_p25 > 0:
            gap_seconds = gap_vs_p25
            reference_value = field_stats.p25
            reference_label = "TOP25%"
        
        if gap_seconds and gap_seconds > 5:  # é˜ˆå€¼é™ä½åˆ°5ç§’
            station_losses.append(TimeLossItem(
                description=f"{segment.segment_name} æŠ€æœ¯æŸè€—ï¼ˆvs {reference_label}ï¼‰",
                ...
            ))
```

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… åŒæ—¶ä¸å¹³å‡å€¼å’ŒTOP25%æ¯”è¾ƒ
2. âœ… ä¼˜å…ˆä½¿ç”¨å¹³å‡å€¼å·®è·ï¼ˆæ›´ç¬¦åˆå®é™…æ”¹è¿›ç©ºé—´ï¼‰
3. âœ… é˜ˆå€¼ä»10ç§’é™ä½åˆ°5ç§’
4. âœ… å³ä½¿è¡¨ç°ä¼˜äºTOP25%ï¼Œå¦‚æœä½äºå¹³å‡å€¼ä¹Ÿä¼šè®¡å…¥æŸè€—

### æ•°æ®ç»“æ„

#### `TimeLossAnalysisData`

```python
@dataclass
class TimeLossAnalysisData:
    transition_loss: Optional[TimeLossItem] = None
    pacing_loss: Optional[TimeLossItem] = None
    station_losses: List[TimeLossItem] = field(default_factory=list)
    total_loss_seconds: float = 0.0
```

#### `TimeLossItem`

```python
@dataclass
class TimeLossItem:
    category: str  # "transition" | "pacing" | "station"
    description: str
    loss_seconds: float
    reference_value: float
    athlete_value: float
```

## å‰ç«¯å®ç°

### æ–‡ä»¶ä½ç½®
`frontend/src/components/charts/TimeLossWaterfall.tsx`

### ç»„ä»¶æ¥å£

```typescript
interface TimeLossWaterfallProps {
  data: TimeLossItem[];
  title?: string;
  targetSaveSeconds?: number;
  style?: React.CSSProperties;
  className?: string;
}

interface TimeLossItem {
  source: string;
  lossSeconds: number;
  difficulty: 'easy' | 'medium' | 'hard';
  suggestion?: string;
}
```

### æ ¸å¿ƒå®ç°

#### 1. æ•°æ®å¤„ç†

```typescript
// è®¡ç®—ç´¯è®¡å€¼
const processedData = useMemo(() => {
  let cumulative = 0;
  return safeData.map(item => {
    cumulative += item.lossSeconds;
    return { ...item, cumulative };
  });
}, [safeData]);

const totalLoss = useMemo(() => {
  return safeData.reduce((sum, item) => sum + item.lossSeconds, 0);
}, [safeData]);
```

#### 2. ç€‘å¸ƒå›¾æ•°æ®æ„å»ºï¼ˆå·²æ”¹è¿›ï¼‰

**åŸé€»è¾‘**ï¼š
```typescript
// æ€»è®¡æŸ±ä»ç´¯è®¡å€¼å¼€å§‹ï¼Œé«˜åº¦ä¸º0
if (showTotal) {
  helperData.push(cumulative);
  positiveData.push({ value: 0, ... }); // é«˜åº¦ä¸º0
}
```

**æ–°é€»è¾‘**ï¼š
```typescript
// æ€»è®¡æŸ±ä»0å¼€å§‹ï¼Œé«˜åº¦ä¸ºæ€»æŸè€—
if (showTotal) {
  helperData.push(0); // ä»0å¼€å§‹
  positiveData.push({
    value: totalLoss, // é«˜åº¦ä¸ºæ€»æŸè€—
    itemStyle: {
      color: {
        type: 'linear',
        colorStops: [
          { offset: 0, color: '#9333ea' }, // ç´«è‰²
          { offset: 0.5, color: '#a855f7' },
          { offset: 1, color: '#c084fc' },
        ],
      },
      borderWidth: 2,
      borderColor: '#9333ea',
    },
  });
}
```

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… æ€»è®¡æŸ±ä»0å¼€å§‹ï¼Œè€Œä¸æ˜¯ä»ç´¯è®¡å€¼å¼€å§‹
2. âœ… é«˜åº¦ä¸ºæ€»æŸè€—ï¼Œè€Œä¸æ˜¯0
3. âœ… ä½¿ç”¨ç´«è‰²æ¸å˜ï¼Œæ¸…æ™°å¯è§
4. âœ… æ·»åŠ è¾¹æ¡†ï¼Œå¢å¼ºè§†è§‰æ•ˆæœ

#### 3. æ ‡ç­¾æ˜¾ç¤ºä¼˜åŒ–ï¼ˆå·²æ”¹è¿›ï¼‰

**åŸé€»è¾‘**ï¼š
```typescript
// "èŠ‚çœ"ç³»åˆ—æ˜¾ç¤ºæ ‡ç­¾
{
  name: 'èŠ‚çœ',
  label: {
    show: true,
    formatter: (params) => {
      if (val === 0) return '';
      return `-${Math.round(val)}s`;
    },
  },
}
```

**æ–°é€»è¾‘**ï¼š
```typescript
// "èŠ‚çœ"ç³»åˆ—éšè—æ ‡ç­¾
{
  name: 'èŠ‚çœ',
  silent: true, // ç¦ç”¨äº¤äº’
  label: {
    show: false, // éšè—æ ‡ç­¾
  },
}

// "è¾…åŠ©"ç³»åˆ—ç¦ç”¨æ ‡ç­¾å’Œäº¤äº’
{
  name: 'è¾…åŠ©',
  silent: true, // ç¦ç”¨äº¤äº’
  label: {
    show: false, // æ˜ç¡®ç¦ç”¨æ ‡ç­¾
  },
}

// "æŸè€—"ç³»åˆ—æ ‡ç­¾ä¼˜åŒ–
{
  name: 'æŸè€—',
  label: {
    show: true,
    formatter: (params) => {
      // æ€»è®¡åˆ—ï¼šæ˜¾ç¤º"æ€»è®¡\nXXs"
      if (showTotal && idx === safeData.length) {
        return `æ€»è®¡\n${Math.round(totalLoss)}s`;
      }
      // å…¶ä»–åˆ—ï¼šåªåœ¨æœ‰å€¼æ—¶æ˜¾ç¤º
      if (val === 0) return '';
      return `${Math.round(val)}s`;
    },
    color: (params) => {
      // æ€»è®¡åˆ—ä½¿ç”¨ç´«è‰²
      if (showTotal && idx === safeData.length) {
        return '#9333ea';
      }
      return CHART_COLORS.textSecondary;
    },
    fontSize: (params) => {
      // æ€»è®¡åˆ—å­—ä½“ç¨å¤§
      if (showTotal && idx === safeData.length) {
        return 11;
      }
      return 10;
    },
  },
}
```

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… éšè—"èŠ‚çœ"ç³»åˆ—æ ‡ç­¾ï¼ˆ`show: false`ï¼‰
2. âœ… ç¦ç”¨"è¾…åŠ©"ç³»åˆ—æ ‡ç­¾å’Œäº¤äº’ï¼ˆ`silent: true`ï¼‰
3. âœ… æ€»è®¡åˆ—æ ‡ç­¾ä½¿ç”¨ç‰¹æ®Šæ ·å¼ï¼ˆç´«è‰²ã€åŠ ç²—ã€11pxï¼‰
4. âœ… åªåœ¨æœ‰å€¼æ—¶æ˜¾ç¤ºæ ‡ç­¾

#### 4. Xè½´æ ‡ç­¾ä¼˜åŒ–ï¼ˆå·²æ”¹è¿›ï¼‰

**åŸé€»è¾‘**ï¼š
```typescript
xAxis: {
  axisLabel: {
    color: CHART_COLORS.textSecondary,
    fontSize: 9,
  },
}
```

**æ–°é€»è¾‘**ï¼š
```typescript
xAxis: {
  axisLabel: {
    color: (value: string, index: number) => {
      // æ€»è®¡åˆ—ä½¿ç”¨ç´«è‰²
      if (showTotal && index === safeData.length) {
        return '#9333ea';
      }
      return CHART_COLORS.textSecondary;
    },
    fontWeight: (value: string, index: number) => {
      // æ€»è®¡åˆ—åŠ ç²—
      if (showTotal && index === safeData.length) {
        return 'bold';
      }
      return 'normal';
    },
  },
}
```

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… æ€»è®¡åˆ—ä½¿ç”¨ç´«è‰²
2. âœ… æ€»è®¡åˆ—åŠ ç²—

#### 5. Tooltipä¼˜åŒ–ï¼ˆå·²æ”¹è¿›ï¼‰

**åŸé€»è¾‘**ï¼š
```typescript
tooltip: {
  formatter: (params: any) => {
    // æ˜¾ç¤ºæ‰€æœ‰ç³»åˆ—çš„ä¿¡æ¯
    const idx = params[0]?.dataIndex;
    // ...
  },
}
```

**æ–°é€»è¾‘**ï¼š
```typescript
tooltip: {
  formatter: (params: any) => {
    // åªæ˜¾ç¤º"æŸè€—"ç³»åˆ—çš„ä¿¡æ¯
    const lossSeries = params.find((p: any) => p.seriesName === 'æŸè€—');
    if (!lossSeries) return '';
    
    const idx = lossSeries.dataIndex;
    
    // æ€»è®¡åˆ—ç‰¹æ®Šæ ·å¼
    if (showTotal && idx === safeData.length) {
      return `
        <div style="font-weight:bold;margin-bottom:8px;color:#9333ea">ğŸ“Š æ€»è®¡</div>
        <div style="color:#9333ea;font-size:16px;font-weight:bold">
          ${formatTime(Math.abs(totalLoss))}
        </div>
        <div style="font-size:11px;color:#9ca3af;margin-top:4px">ç´¯è®¡æ€»æŸè€—</div>
      `;
    }
    
    // å…¶ä»–åˆ—æ­£å¸¸æ˜¾ç¤º
    // ...
  },
}
```

**æ”¹è¿›ç‚¹**ï¼š
1. âœ… åªæ˜¾ç¤º"æŸè€—"ç³»åˆ—çš„ä¿¡æ¯
2. âœ… æ€»è®¡åˆ—tooltipä½¿ç”¨ç´«è‰²ä¸»é¢˜
3. âœ… é¿å…æ˜¾ç¤ºæ— ç”¨çš„0å€¼

## EChartsé…ç½®

### ç³»åˆ—é…ç½®

```typescript
series: [
  {
    name: 'è¾…åŠ©',
    type: 'bar',
    stack: 'total',
    silent: true, // ç¦ç”¨äº¤äº’
    itemStyle: { color: 'transparent' },
    label: { show: false },
    data: helperData, // [0, cumulative1, cumulative2, ...]
  },
  {
    name: 'æŸè€—',
    type: 'bar',
    stack: 'total',
    barWidth: '50%',
    label: { /* ä¼˜åŒ–åçš„æ ‡ç­¾é…ç½® */ },
    data: positiveData, // [loss1, loss2, ..., totalLoss]
  },
  {
    name: 'èŠ‚çœ',
    type: 'bar',
    stack: 'total',
    silent: true, // ç¦ç”¨äº¤äº’
    label: { show: false },
    data: negativeData, // [0, 0, ..., 0]
  },
]
```

### å †å é€»è¾‘

ç€‘å¸ƒå›¾ä½¿ç”¨å †å æŸ±çŠ¶å›¾æ¨¡æ‹Ÿï¼š

```
è¾…åŠ©ç³»åˆ—: [0,      cumulative1, cumulative2, ..., cumulativeN, 0]
æŸè€—ç³»åˆ—: [loss1,  loss2,       loss3,       ..., lossN,       totalLoss]
èŠ‚çœç³»åˆ—: [0,      0,           0,           ..., 0,           0]
         â””â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         æŸ±1      æŸ±2          æŸ±3          æŸ±N    æ€»è®¡æŸ±
```

**æ€»è®¡æŸ±çš„ç‰¹æ®Šå¤„ç†**ï¼š
- è¾…åŠ©ç³»åˆ—ï¼šä»0å¼€å§‹ï¼ˆ`helperData.push(0)`ï¼‰
- æŸè€—ç³»åˆ—ï¼šé«˜åº¦ä¸ºæ€»æŸè€—ï¼ˆ`positiveData.push({ value: totalLoss })`ï¼‰
- èŠ‚çœç³»åˆ—ï¼šé«˜åº¦ä¸º0ï¼ˆ`negativeData.push(0)`ï¼‰

è¿™æ ·æ€»è®¡æŸ±ä»0å¼€å§‹ï¼Œé«˜åº¦ä¸ºæ€»æŸè€—ï¼Œæ¸…æ™°å¯è§ã€‚

## æ•°æ®æµ

```
åç«¯è®¡ç®—
  â†“
TimeLossAnalysisData
  â†“
chart_builder.py: _build_waterfall_chart()
  â†“
ChartConfig {
  chart_type: "time_loss_waterfall",
  config: {
    data: [
      { source: "...", lossSeconds: ..., difficulty: "..." },
      ...
    ]
  }
}
  â†“
å‰ç«¯æ¥æ”¶
  â†“
TimeLossWaterfallç»„ä»¶
  â†“
EChartsæ¸²æŸ“
```

## è°ƒè¯•æ—¥å¿—

### åç«¯æ—¥å¿—

åœ¨ `data_provider.py` ä¸­æ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼š

```python
# è®°å½•è½¬æ¢åŒºæ—¶é—´æ•°æ®
{
  "location": "data_provider.py:_calculate_time_loss_analysis:entry",
  "data": {
    "roxzone_time": athlete_result.roxzone_time,
    "division_roxzone_time": division_stats.roxzone_time.avg,
    "station_segments_count": len(segment_comparison.station_segments),
  }
}

# è®°å½•åŠŸèƒ½ç«™æ•°æ®
{
  "location": "data_provider.py:_calculate_time_loss_analysis:stations",
  "data": {
    "segments_count": len(segment_comparison.station_segments),
    "sample_segments": [
      {
        "name": "...",
        "gap_vs_avg": ...,
        "gap_vs_p25": ...,
      }
    ]
  }
}
```

### å‰ç«¯æ—¥å¿—

åœ¨ `TimeLossWaterfall.tsx` ä¸­æ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼š

```typescript
// è®°å½•æ¥æ”¶åˆ°çš„æ•°æ®
fetch('http://127.0.0.1:7244/ingest/...', {
  body: JSON.stringify({
    location: 'TimeLossWaterfall.tsx:safeData',
    data: {
      isArray: Array.isArray(data),
      dataLength: data.length,
      dataPreview: data.slice(0, 3),
    }
  })
})
```

## æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

1. **æ•°æ®è®¡ç®—æµ‹è¯•**ï¼š
   - æµ‹è¯•åŠŸèƒ½ç«™æŸè€—è®¡ç®—ï¼ˆå¹³å‡å€¼ vs TOP25%ï¼‰
   - æµ‹è¯•é…é€ŸæŸè€—è®¡ç®—ï¼ˆRun5-Run8ï¼‰
   - æµ‹è¯•é˜ˆå€¼è¾¹ç•Œæƒ…å†µ

2. **å¯è§†åŒ–æµ‹è¯•**ï¼š
   - æµ‹è¯•æ€»è®¡æŸ±å­é«˜åº¦
   - æµ‹è¯•æ ‡ç­¾æ˜¾ç¤ºé€»è¾‘
   - æµ‹è¯•tooltipæ˜¾ç¤º

### é›†æˆæµ‹è¯•

1. **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š
   - ç”ŸæˆåŒ…å«å¤šä¸ªæŸè€—é¡¹çš„æŠ¥å‘Š
   - éªŒè¯ç€‘å¸ƒå›¾æ­£ç¡®æ˜¾ç¤º
   - éªŒè¯æ€»è®¡æŸ±å­æ¸…æ™°å¯è§

2. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**ï¼š
   - åªæœ‰ä¸€ä¸ªæŸè€—é¡¹çš„æƒ…å†µ
   - æ²¡æœ‰æŸè€—é¡¹çš„æƒ…å†µ
   - æŸè€—å€¼ä¸º0çš„æƒ…å†µ

## æ€§èƒ½è€ƒè™‘

1. **æ•°æ®è®¡ç®—**ï¼šæ—¶é—´å¤æ‚åº¦ O(n)ï¼Œnä¸ºåŠŸèƒ½ç«™æ•°é‡
2. **å›¾è¡¨æ¸²æŸ“**ï¼šä½¿ç”¨ `useMemo` ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
3. **æ—¥å¿—è®°å½•**ï¼šç”Ÿäº§ç¯å¢ƒåº”ç§»é™¤è°ƒè¯•æ—¥å¿—

## å·²çŸ¥é—®é¢˜

1. **è½¬æ¢åŒºæ—¶é—´æ•°æ®**ï¼šå½“å‰æ•°æ®æºä¸­è½¬æ¢åŒºæ—¶é—´ä¸º0ï¼Œæ— æ³•è®¡ç®—æŸè€—
2. **Burpee Broad Jumpæ•°å€¼å¼‚å¸¸**ï¼šæ—¥å¿—æ˜¾ç¤ºå€¼ä¸º701ç§’ï¼Œå¯èƒ½æ˜¯æ•°æ®é”™è¯¯

## åç»­ä¼˜åŒ–

1. **è½¬æ¢åŒºæ—¶é—´æ•°æ®æº**ï¼šè°ƒæŸ¥ä¸ºä»€ä¹ˆè½¬æ¢åŒºæ—¶é—´ä¸º0ï¼Œæ˜¯å¦éœ€è¦ä»å…¶ä»–æ•°æ®æºè·å–
2. **æŸè€—é¡¹åˆ†è§£**ï¼šè€ƒè™‘å°†å¤§æŸè€—é¡¹åˆ†è§£ä¸ºå¤šä¸ªå­é¡¹
3. **åŠ¨æ€é˜ˆå€¼**ï¼šæ ¹æ®è¿åŠ¨å‘˜æ°´å¹³åŠ¨æ€è°ƒæ•´é˜ˆå€¼
4. **å¯è§†åŒ–å¢å¼º**ï¼šè€ƒè™‘æ·»åŠ è¿æ¥çº¿ï¼Œæ›´æ¸…æ™°åœ°å±•ç¤ºç€‘å¸ƒæ•ˆæœ

## ç›¸å…³æ–‡æ¡£

- [PRDæ–‡æ¡£](./../prd/v10.0-time-loss-analysis-improvement.md)
- [v8.0 æŠ¥å‘ŠAPIæ–‡æ¡£](./v8.0-report-api.md)
