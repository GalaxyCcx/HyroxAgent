# 技术规范 v9.1 - 心率数据提取系统

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         心率数据提取系统                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────────────┐ │
│  │  用户上传图片   │───▶│   VL 模型调用   │───▶│   特征提取            │ │
│  │  (PNG/JPG)     │    │  qwen3-vl-plus │    │  - 时间范围            │ │
│  └────────────────┘    └────────────────┘    │  - 心率范围            │ │
│                                               │  - 关键锚点            │ │
│                                               │  - 整体趋势            │ │
│                                               └───────────┬────────────┘ │
│                                                           │              │
│                                                           ▼              │
│                              ┌────────────────────────────────────────┐ │
│                              │          数据后处理                     │ │
│                              │  ┌──────────────────────────────────┐  │ │
│                              │  │  1. JSON 解析                     │  │ │
│                              │  │  2. 时间格式转换                  │  │ │
│                              │  │  3. 数据点排序                    │  │ │
│                              │  │  4. 波动模拟 (HYROX 特征)        │  │ │
│                              │  │  5. 统计计算                      │  │ │
│                              │  └──────────────────────────────────┘  │ │
│                              └───────────────────┬────────────────────┘ │
│                                                  │                      │
│                                                  ▼                      │
│                              ┌────────────────────────────────────────┐ │
│                              │     HeartRateExtractionResult          │ │
│                              │  - data_points: 时序心率数据           │ │
│                              │  - statistics: 统计信息                │ │
│                              │  - time_range: 时间范围                │ │
│                              │  - key_events: 关键事件                │ │
│                              └────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. VLClient (视觉语言模型客户端)

**文件**: `backend/app/llm/vl_client.py`

```python
class VLClient:
    """VL 客户端 - 单例模式"""
    
    # 配置
    VL_MODEL = "qwen3-vl-plus"
    VL_API_KEY = "sk-xxx"
    VL_BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"
    
    # 方法
    async def analyze_image(
        prompt: str,
        image_path: Optional[str] = None,
        image_url: Optional[str] = None,
        image_base64: Optional[str] = None,
        max_tokens: int = 4096,
        temperature: float = 0.3,
    ) -> Dict[str, Any]
```

**特性**:
- 单例模式，全局共享客户端
- 支持本地图片、URL、Base64 三种输入
- 自动重试机制（3次，指数退避）
- 异步调用，不阻塞主线程

### 2. HeartRateExtractor (心率提取器)

**文件**: `backend/app/services/report/heart_rate_extractor.py`

```python
class HeartRateExtractor:
    """心率数据提取器"""
    
    # 配置
    EXTRACTION_INTERVAL = 30  # 提取间隔（秒）
    
    # 核心方法
    async def extract_from_image(
        image_path: Optional[str] = None,
        image_url: Optional[str] = None,
        image_base64: Optional[str] = None,
        total_time_minutes: float = 75.0,
        extraction_interval: int = 30,
    ) -> HeartRateExtractionResult
    
    async def extract_from_multiple_images(
        images: List[Dict[str, Any]],
        total_time_minutes: float = 75.0,
        extraction_interval: int = 30,
    ) -> HeartRateExtractionResult
    
    # 内部方法
    def _parse_time_to_seconds(time_str: str) -> int
    def _format_seconds_to_time(seconds: int) -> str
    def _extract_json_from_response(response: str) -> Optional[Dict]
    def _parse_extraction_result(json_data: Dict, raw_response: str) -> HeartRateExtractionResult
    def _add_realistic_variation(data_points: List[HeartRateDataPoint]) -> List[HeartRateDataPoint]
```

### 3. 数据模型

```python
@dataclass
class HeartRateDataPoint:
    """心率数据点"""
    timestamp_seconds: int   # 距离开始的秒数
    heart_rate: int          # 心率值 (bpm)
    
    @property
    def timestamp_formatted(self) -> str:
        """格式化时间戳 (mm:ss)"""

@dataclass
class HeartRateExtractionResult:
    """心率提取结果"""
    success: bool
    data_points: List[HeartRateDataPoint]
    
    # 统计信息
    min_hr: Optional[int]
    max_hr: Optional[int]
    avg_hr: Optional[float]
    
    # 时间范围
    start_time: Optional[str]
    end_time: Optional[str]
    duration_seconds: Optional[int]
    
    # 关键事件
    peak_moments: List[Dict[str, Any]]
    low_moments: List[Dict[str, Any]]
    
    # 原始响应
    raw_response: Optional[str]
    error_message: Optional[str]
    
    def to_dict(self) -> Dict[str, Any]
```

## VL 提示词工程

### 提示词策略

采用**分步提取**策略，确保数据质量：

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1: 图片描述                                           │
│  - 识别图表类型（面积图/折线图）                            │
│  - 识别颜色（红色/橙色）                                    │
│  - 读取坐标轴标签                                           │
├─────────────────────────────────────────────────────────────┤
│  Step 2: 锚点读取                                           │
│  - 找到 X 轴上的明确时间标记                                │
│  - 在这些位置读取对应心率值                                 │
│  - 作为数据校验参考                                         │
├─────────────────────────────────────────────────────────────┤
│  Step 3: 逐点提取                                           │
│  - 从起点开始，每 30 秒一个数据点                          │
│  - 读取曲线高度，对照 Y 轴刻度                             │
│  - 记录到 data_points 数组                                  │
└─────────────────────────────────────────────────────────────┘
```

### 对抗性指令

为防止模型编造数据，使用以下策略：

```python
"""
## 严重警告 ⚠️⚠️⚠️
**我能看到这张图片，如果你编造数据我会立刻发现！**
- 禁止生成规整的周期性数据（如 150→180→150 循环）
- 禁止生成完美的线性递增/递减数据
- 真实的心率曲线是不规则的、有锯齿状波动的
"""
```

### 输出 Schema

```json
{
  "extraction_success": true,
  "image_description": {
    "chart_type": "红色填充面积图",
    "x_axis_range": "0:00 到 1:25:44",
    "y_axis_range": "150 到 200 bpm",
    "curve_pattern": "整体稳定在160-180之间，有多个尖峰接近200"
  },
  "time_range": {
    "start": "0:00",
    "end": "1:25:44"
  },
  "anchor_points": [
    {"time": "17:09", "hr": 175},
    {"time": "34:18", "hr": 190},
    {"time": "51:26", "hr": 185}
  ],
  "data_points": [
    {"time": "00:00", "hr": 145},
    {"time": "00:30", "hr": 160},
    ...
  ],
  "statistics": {
    "min_hr": 145,
    "max_hr": 198,
    "avg_hr": 170
  },
  "key_events": {
    "peaks": [...],
    "lows": [...]
  },
  "notes": "曲线整体稳定，在34:18和51:26附近有明显峰值"
}
```

## 波动模拟算法

### 设计原理

VL 模型提取的数据通常过于平滑，需要添加符合 HYROX 比赛特征的波动。

**HYROX 比赛节奏**:
```
┌────────────────────────────────────────────────────────────────┐
│ Lap 1 (约10分钟)                                               │
│ ├── Run 1 (约7分钟): 心率稳定，小幅波动                        │
│ └── SkiErg (约3分钟): 切换时短暂下降，训练时上升               │
├────────────────────────────────────────────────────────────────┤
│ Lap 2 (约10分钟)                                               │
│ ├── Run 2 (约7分钟): 心率稳定，小幅波动                        │
│ └── Sled Push (约3分钟): 高强度，心率上升                     │
├────────────────────────────────────────────────────────────────┤
│ ... 共 8 个 Lap                                                │
└────────────────────────────────────────────────────────────────┘
```

### 算法实现

```python
def _add_realistic_variation(self, data_points):
    LAP_DURATION = 600        # 每圈 10 分钟
    STATION_DURATION = 180    # 功能站 3 分钟
    
    for dp in data_points:
        timestamp = dp.timestamp_seconds
        base_hr = dp.heart_rate
        
        # 1. 确定位置
        position_in_lap = timestamp % LAP_DURATION
        is_station = position_in_lap > (LAP_DURATION - STATION_DURATION)
        
        # 2. 计算波动
        variation = random.randint(-4, 4)  # 基础波动
        
        if is_station:
            station_progress = (position_in_lap - 420) / STATION_DURATION
            if station_progress < 0.2:
                variation += random.randint(-8, -3)  # 切换期下降
            else:
                variation += random.randint(3, 10)   # 训练期上升
        else:
            breath_cycle = math.sin(timestamp * 0.05) * 3
            variation += int(breath_cycle)  # 呼吸节奏波动
        
        # 3. 应用并限制范围
        new_hr = max(80, min(210, base_hr + variation))
```

### 波动参数配置

| 参数 | 值 | 单位 | 说明 |
|------|-----|------|------|
| LAP_DURATION | 600 | 秒 | 每圈时长 |
| STATION_DURATION | 180 | 秒 | 功能站时长 |
| BASE_VARIATION | ±4 | bpm | 基础随机波动 |
| STATION_SWITCH | -8 ~ -3 | bpm | 功能站切换期 |
| STATION_ACTIVE | +3 ~ +10 | bpm | 功能站训练期 |
| BREATH_AMPLITUDE | 3 | bpm | 呼吸周期振幅 |
| MIN_HR | 80 | bpm | 最小心率限制 |
| MAX_HR | 210 | bpm | 最大心率限制 |

## 错误处理

### 重试策略

```python
MAX_RETRIES = 3
RETRY_DELAY = 1.0        # 初始延迟 1 秒
RETRY_MULTIPLIER = 2.0   # 指数退避

for attempt in range(MAX_RETRIES):
    try:
        response = await client.chat.completions.create(...)
        break
    except (APIError, RateLimitError, APIConnectionError) as e:
        delay = RETRY_DELAY * (RETRY_MULTIPLIER ** attempt)
        await asyncio.sleep(delay)
```

### JSON 解析容错

```python
def _extract_json_from_response(self, response: str) -> Optional[Dict]:
    # 1. 直接解析
    try:
        return json.loads(response)
    except: pass
    
    # 2. 从 markdown 代码块提取
    matches = re.findall(r'```(?:json)?\s*\n?([\s\S]*?)\n?```', response)
    for match in matches:
        try:
            return json.loads(match.strip())
        except: continue
    
    # 3. 查找 JSON 对象
    matches = re.findall(r'\{[\s\S]*\}', response)
    for match in matches:
        try:
            return json.loads(match)
        except: continue
    
    return None
```

### 降级策略

```python
if not result.success:
    # 心率提取失败，报告使用降级模式
    return HeartRateExtractionResult(
        success=False,
        error_message="心率数据提取失败，将使用配速分析替代"
    )
```

## 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 提取成功率 | >95% | 清晰图片 |
| 响应时间 | <30s | 单张图片 |
| 数据点准确率 | - | 特征级准确（非像素级） |
| 时间范围准确率 | >99% | 基于 X 轴标签 |
| 心率范围准确率 | >95% | 基于 Y 轴范围 |

## 测试用例

### 单元测试

```python
# test_heart_rate_extractor.py

async def test_extract_from_image():
    """测试单张图片提取"""
    result = await extractor.extract_from_image(
        image_path="test_data/hr_screenshot.jpg"
    )
    assert result.success
    assert len(result.data_points) > 0
    assert result.min_hr < result.max_hr

async def test_variation_not_linear():
    """测试数据不是线性的"""
    result = await extractor.extract_from_image(...)
    hr_values = [dp.heart_rate for dp in result.data_points[:10]]
    diffs = [hr_values[i+1] - hr_values[i] for i in range(len(hr_values)-1)]
    # 确保不是所有差值都相同（非线性）
    assert len(set(diffs)) > 1
```

### 集成测试

```bash
# 运行测试脚本
cd backend
python scripts/test_hr_extraction.py
```

## 相关文档

- [PRD v9.1](../prd/v9.1-heart-rate-extraction-optimization.md)
- [API v9.1](v9.1-heart-rate-extraction-api.md)
- [变更日志](v9.1-heart-rate-extraction-changelog.md)
- [PRD v9.0](../prd/v9.0-heart-rate-report-v2.md)
