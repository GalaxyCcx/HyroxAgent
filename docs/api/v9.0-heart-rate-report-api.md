# API 文档 v9.0 - 心率数据与报告 V2 接口

## 概述

v9.0 新增心率图片上传接口和报告 V2 生成接口，支持心率数据提取和强制重新生成功能。

**Base URL**: `/api/v1`

## 新增接口

### 1. 上传心率截图

上传用户的运动手表/App 心率截图，用于 AI 提取心率数据。

**请求**
```
POST /api/v1/upload/heart-rate
Content-Type: multipart/form-data
```

**表单字段**
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| report_id | string | 是 | 报告 ID (UUID) |
| files | File[] | 是 | 心率截图文件 (1-3 张) |

**文件限制**
- 格式: PNG, JPG, JPEG
- 单张大小: ≤ 10MB
- 数量: 1-3 张

**响应**
```json
{
  "uploaded": [
    {
      "id": 1,
      "report_id": "1fa38cd0-974b-4586-9b22-8b2014b5da8a",
      "image_path": "data/heart_rate_images/1fa38cd0_1706400000_hr1.png",
      "status": "pending",
      "created_at": "2026-01-28T10:00:00Z"
    }
  ],
  "failed": []
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| uploaded | array | 成功上传的图片列表 |
| uploaded[].id | int | 图片记录 ID |
| uploaded[].report_id | string | 关联的报告 ID |
| uploaded[].image_path | string | 服务器存储路径 |
| uploaded[].status | string | 处理状态: `pending` / `processed` / `error` |
| failed | array | 上传失败的文件名列表 |

**错误响应**
```json
{
  "detail": "report_id 是必填字段"
}
```

---

### 2. V2 创建报告

创建新报告或重新生成已存在的报告。

**请求**
```
POST /api/v1/reports/v2/create
Content-Type: application/json
```

**请求体**
```json
{
  "season": 8,
  "location": "shanghai",
  "athlete_name": "Zhang, Wei",
  "user_id": 123,
  "force_regenerate": true
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| season | int | 是 | 赛季编号 |
| location | string | 是 | 比赛地点（小写） |
| athlete_name | string | 是 | 运动员姓名 |
| user_id | int | 否 | 用户 ID |
| force_regenerate | bool | 否 | 是否强制重新生成（默认 true） |

**响应**
```json
{
  "report_id": "1fa38cd0-974b-4586-9b22-8b2014b5da8a",
  "status": "created",
  "message": "报告创建成功，请订阅生成进度"
}
```

| status 值 | 说明 |
|-----------|------|
| created | 新建报告 |
| reset | 已重置，准备重新生成 |
| exists | 报告已存在且 force_regenerate=false |
| generating | 报告正在生成中 |

---

### 3. V2 订阅生成进度 (SSE)

通过 Server-Sent Events 订阅报告生成进度，支持传入心率图片路径。

**请求**
```
GET /api/v1/reports/v2/generate/{report_id}?heart_rate_image_paths=path1,path2
Accept: text/event-stream
```

**查询参数**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| heart_rate_image_paths | string | 否 | 心率图片路径，逗号分隔，URL 编码 |

**事件类型**

#### progress 事件
```
event: progress
data: {"progress": 25, "step": "正在提取心率数据..."}
```

#### complete 事件
```
event: complete
data: {"report_id": "xxx", "status": "completed"}
```

#### error 事件
```
event: error
data: {"message": "报告生成失败: VL 模型调用超时"}
```

**V2 进度节点**
| 进度 | 步骤 |
|------|------|
| 5% | 初始化 V2 报告生成... |
| 10% | 运动员信息加载完成 |
| 15% | 正在提取心率数据... |
| 20% | 心率数据映射完成 |
| 25% | 数据准备阶段... |
| 30% | 正在构建图表数据... |
| 35% | 正在生成: 成績總覽與定位 |
| 45% | 正在生成: 時間損失熱區分析 |
| 55% | 正在生成: ZONE0 引擎深度復盤 |
| 65% | 正在生成: 成績預測與目標設定 |
| 75% | 正在生成: 對標分析 |
| 85% | 正在生成: 訓練計劃建議 |
| 95% | 保存报告... |
| 100% | 报告生成完成！ |

---

## 数据模型

### HeartRateImage

```typescript
interface HeartRateImage {
  id: number;
  report_id: string;
  image_path: string;
  extracted_data?: HeartRateExtractedData;
  status: 'pending' | 'processed' | 'error';
  created_at: string;
}

interface HeartRateExtractedData {
  avg_heart_rate?: number;     // 平均心率
  max_heart_rate?: number;     // 最大心率
  min_heart_rate?: number;     // 最小心率
  zones?: {                    // 心率区间分布
    zone1?: number;            // 热身区 (50-60% HRmax)
    zone2?: number;            // 燃脂区 (60-70%)
    zone3?: number;            // 有氧区 (70-80%)
    zone4?: number;            // 无氧区 (80-90%)
    zone5?: number;            // 极限区 (90-100%)
  };
  time_series?: Array<{        // 时间序列（如能提取）
    time: number;              // 秒
    hr: number;                // 心率
  }>;
}
```

### ProReportV2 响应结构

```typescript
interface ProReportV2Detail {
  report_id: string;
  title: string;
  season: number;
  location: string;
  athlete_name: string;
  gender: string;
  division: string;
  status: 'pending' | 'generating' | 'completed' | 'error';
  
  // V2 新增字段
  has_heart_rate_data: boolean;
  heart_rate_images?: HeartRateImage[];
  
  // 章节内容
  sections: Array<{
    section_id: string;
    title: string;
    content: string;           // Markdown 内容，含 [CHART:id] 标记
    data?: object;             // 结构化数据（可选）
    is_degraded?: boolean;     // 是否为降级内容
  }>;
  
  // 图表配置
  charts: {
    [chart_id: string]: {
      config: EChartsOption;   // ECharts 配置
      purpose: string;         // 图表用途
      chart_type: string;      // 图表类型
    };
  };
  
  created_at: string;
  completed_at?: string;
}
```

---

## 章节输出 Schema

### 第三章: ZONE0 引擎深度復盤

**完整分析模式** (有心率数据)
```json
{
  "has_heart_rate_data": true,
  "analysis_type": "full",
  "hr_drift_rate": 8.5,
  "decoupling_point": "第5段（Sled Push后）",
  "phases": [
    {
      "phase": "前半程 (R1-R4)",
      "avg_hr": 165,
      "avg_pace": "4:45",
      "efficiency": "high"
    },
    {
      "phase": "后半程 (R5-R8)",
      "avg_hr": 178,
      "avg_pace": "5:10",
      "efficiency": "medium"
    }
  ],
  "efficiency_rating": "good",
  "key_insights": [
    "心率在功能站后恢复较慢，建议加强间歇训练",
    "配速下降主要出现在第6段之后"
  ],
  "recommendation": "建议进行更多心率控制训练，提升乳酸阈值"
}
```

**降级分析模式** (无心率数据)
```json
{
  "has_heart_rate_data": false,
  "analysis_type": "degraded",
  "degraded_analysis": {
    "pace_stability": "significant_decline",
    "estimated_fatigue_point": "第5段",
    "suggestion": "建议下次佩戴心率设备以进行更精确的分析"
  },
  "analysis_conclusion": "由于缺乏心率数据，仅能依配速变化进行降级分析..."
}
```

---

## 前端使用示例

### 完整报告生成流程

```typescript
import { reportApi, uploadHeartRateImages } from './services/api';

async function generateReportWithHeartRate(
  season: number,
  location: string,
  athleteName: string,
  heartRateFiles?: File[]
) {
  // 1. 创建报告
  const createResult = await reportApi.create(season, location, athleteName, true);
  const reportId = createResult.report_id;
  
  // 2. 上传心率图片（可选）
  let heartRateImagePaths: string[] = [];
  if (heartRateFiles && heartRateFiles.length > 0) {
    const uploadResult = await uploadHeartRateImages(reportId, heartRateFiles);
    heartRateImagePaths = uploadResult.uploaded.map(img => img.image_path);
  }
  
  // 3. 订阅生成进度
  return new Promise((resolve, reject) => {
    const eventSource = reportApi.subscribeGenerate(
      reportId,
      // onProgress
      (progress, step) => {
        console.log(`进度: ${progress}% - ${step}`);
      },
      // onComplete
      (data) => {
        eventSource.close();
        resolve(data);
      },
      // onError
      (error) => {
        eventSource.close();
        reject(error);
      },
      // 传入心率图片路径
      heartRateImagePaths
    );
  });
}
```

### 图片上传组件使用

```tsx
import { ImageUploader } from './components/ImageUploader';

function ReportPage() {
  const [reportId, setReportId] = useState<string | null>(null);
  const [heartRateImages, setHeartRateImages] = useState<HeartRateImage[]>([]);
  
  const handleUploadSuccess = (images: HeartRateImage[]) => {
    setHeartRateImages(images);
  };
  
  return (
    <ImageUploader
      reportId={reportId}
      onUploadSuccess={handleUploadSuccess}
      onError={(msg) => console.error(msg)}
    />
  );
}
```

---

## 错误处理

### HTTP 状态码
| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 404 | 报告不存在 |
| 413 | 文件过大 |
| 415 | 不支持的文件类型 |
| 500 | 服务器内部错误 |

### VL 模型相关错误
| 错误信息 | 说明 | 处理建议 |
|----------|------|----------|
| VL 模型调用超时 | 图片处理超时 | 重试或使用更清晰的截图 |
| 无法识别心率数据 | 截图质量差或格式不支持 | 使用标准心率截图 |
| 心率数据格式异常 | 提取结果不完整 | 报告会使用降级分析 |

---

## 兼容性说明

### 与 V1 接口的关系

| V1 接口 | V2 接口 | 说明 |
|---------|---------|------|
| POST /reports/create | POST /reports/v2/create | V2 新增 force_regenerate |
| GET /reports/generate/{id} | GET /reports/v2/generate/{id} | V2 支持心率图片参数 |
| GET /reports/detail/{id} | 保持不变 | 响应增加心率相关字段 |
| GET /reports/status/{id} | 保持不变 | 无变化 |

### 降级策略

当心率数据不可用时，系统自动切换到降级模式：
1. 第三章使用配速分析替代心率分析
2. 相关图表显示配速数据
3. `is_degraded: true` 标记章节状态

---

## 相关文档

- [PRD v9.0](../prd/v9.0-heart-rate-report-v2.md)
- [API v8.0](v8.0-report-api.md)
- [部署指南](../deployment/quick-start.md)
