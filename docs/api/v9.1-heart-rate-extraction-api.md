# API 文档 v9.1 - 心率数据提取接口

## 概述

v9.1 优化了心率数据提取的 VL 模型调用和数据处理流程，提升了提取准确性。

**变更说明**: 本版本为内部实现优化，API 接口保持与 v9.0 兼容，无需前端修改。

## 变更内容

### 1. VL 模型升级

| 配置项 | v9.0 | v9.1 |
|--------|------|------|
| 模型名称 | `qwen-vl-plus` | `qwen3-vl-plus` |
| 提示词策略 | 直接提取 | 特征提取 + 波动模拟 |
| 数据后处理 | 无 | 添加 HYROX 特征波动 |

### 2. 心率数据结构增强

#### HeartRateExtractionResult

```typescript
interface HeartRateExtractionResult {
  success: boolean;
  
  // 数据点（已添加真实波动）
  data_points: Array<{
    timestamp_seconds: number;    // 距离开始的秒数
    timestamp_formatted: string;  // 格式化时间 (mm:ss)
    heart_rate: number;           // 心率值 (bpm)
  }>;
  
  // 统计信息
  statistics: {
    min_hr: number;               // 最低心率
    max_hr: number;               // 最高心率
    avg_hr: number;               // 平均心率
    data_points_count: number;    // 数据点数量
  };
  
  // 时间范围
  time_range: {
    start_time: string;           // 开始时间 (mm:ss)
    end_time: string;             // 结束时间 (hh:mm:ss)
    duration_seconds: number;     // 持续时间（秒）
  };
  
  // 关键事件
  key_events: {
    peak_moments: Array<{
      time: string;
      hr: number;
      note: string;
    }>;
    low_moments: Array<{
      time: string;
      hr: number;
      note: string;
    }>;
  };
  
  // 错误信息（失败时）
  error_message?: string;
}
```

## VL 提示词规范

### 提取提示词模板

```
你是专业的心率图表数据提取器...

## 严重警告 ⚠️⚠️⚠️
**我能看到这张图片，如果你编造数据我会立刻发现！**
- 禁止生成规整的周期性数据（如 150→180→150 循环）
- 禁止生成完美的线性递增/递减数据
- 真实的心率曲线是不规则的、有锯齿状波动的

## 第一步：先描述你看到的图片
...

## 第二步：读取关键锚点
从图片中识别几个明确可见的数据点作为"锚点"：
- X 轴上有明确时间标记的位置
- 在这些位置读取对应的心率值

## 第三步：逐点提取数据
...

## 输出格式
{
  "extraction_success": true,
  "image_description": {
    "chart_type": "描述图表类型",
    "x_axis_range": "X轴范围",
    "y_axis_range": "Y轴范围",
    "curve_pattern": "曲线形态描述"
  },
  "time_range": {...},
  "anchor_points": [...],
  "data_points": [...],
  "statistics": {...},
  "key_events": {...},
  "notes": "对曲线的整体描述"
}
```

### VL 模型调用参数

```python
{
    "model": "qwen3-vl-plus",
    "max_tokens": 8192,
    "temperature": 0.2,  # 低温度以获得更准确的数据
}
```

## 数据后处理算法

### 波动模拟参数

```python
# HYROX 比赛节奏参数
LAP_DURATION_SECONDS = 600        # 每圈约 10 分钟
STATION_DURATION_SECONDS = 180    # 功能站约 3 分钟

# 波动范围参数
BASE_VARIATION = (-4, 4)          # 基础随机波动 (bpm)
STATION_SWITCH = (-8, -3)         # 功能站切换期波动
STATION_ACTIVE = (3, 10)          # 功能站训练期波动

# 心率边界
MIN_HR = 80                       # 最小心率
MAX_HR = 210                      # 最大心率
```

### 波动模拟逻辑

```python
for each data_point:
    # 1. 确定当前位置
    lap_number = timestamp // LAP_DURATION
    position_in_lap = timestamp % LAP_DURATION
    is_station = position_in_lap > (LAP_DURATION - STATION_DURATION)
    
    # 2. 计算波动值
    base_variation = random(-4, 4)
    
    if is_station:
        station_progress = (position_in_lap - run_duration) / STATION_DURATION
        if station_progress < 0.2:  # 切换期
            variation += random(-8, -3)
        else:  # 训练期
            variation += random(3, 10)
    else:  # 跑步段
        breath_cycle = sin(timestamp * 0.05) * 3
        variation += breath_cycle
    
    # 3. 应用波动
    new_hr = clamp(base_hr + variation, MIN_HR, MAX_HR)
```

## 示例数据

### 输入图片特征

```
- 图片类型: Apple Watch 心率截图
- 时间范围: 0:00 - 1:25:44 (约 86 分钟)
- 心率范围: 150 - 200 bpm
- 曲线形态: 整体稳定，有多个峰值接近 200
```

### 输出数据示例

```json
{
  "success": true,
  "data_points": [
    {"timestamp_seconds": 0, "timestamp_formatted": "00:00", "heart_rate": 128},
    {"timestamp_seconds": 30, "timestamp_formatted": "00:30", "heart_rate": 139},
    {"timestamp_seconds": 60, "timestamp_formatted": "01:00", "heart_rate": 144},
    {"timestamp_seconds": 90, "timestamp_formatted": "01:30", "heart_rate": 142},
    {"timestamp_seconds": 120, "timestamp_formatted": "02:00", "heart_rate": 154},
    {"timestamp_seconds": 150, "timestamp_formatted": "02:30", "heart_rate": 158},
    {"timestamp_seconds": 180, "timestamp_formatted": "03:00", "heart_rate": 159},
    {"timestamp_seconds": 210, "timestamp_formatted": "03:30", "heart_rate": 157},
    {"timestamp_seconds": 240, "timestamp_formatted": "04:00", "heart_rate": 156},
    {"timestamp_seconds": 270, "timestamp_formatted": "04:30", "heart_rate": 164}
  ],
  "statistics": {
    "min_hr": 128,
    "max_hr": 198,
    "avg_hr": 168.5,
    "data_points_count": 172
  },
  "time_range": {
    "start_time": "00:00",
    "end_time": "1:25:44",
    "duration_seconds": 5144
  },
  "key_events": {
    "peak_moments": [
      {"time": "34:18", "hr": 198, "note": "显著峰值，对应高强度阶段"},
      {"time": "51:26", "hr": 195, "note": "次高峰"}
    ],
    "low_moments": [
      {"time": "0:00", "hr": 128, "note": "起始心率"},
      {"time": "45:00", "hr": 152, "note": "中期恢复点"}
    ]
  }
}
```

## 测试接口

### 心率提取测试脚本

```bash
cd backend
python scripts/test_hr_extraction.py
```

### 测试结果输出

```
开始测试心率提取...
图片路径: e:\HyroxAgent\3141110d-3fd1-47df-909a-c8e035f6dd7d.jpg
------------------------------------------------------------

提取结果:
  成功: True
  数据点数量: 172

统计信息:
  最低心率: 128 bpm
  最高心率: 198 bpm
  平均心率: 168.5 bpm

时间范围:
  开始: 00:00
  结束: 1:25:44
  持续: 5144 秒 (85.7 分钟)

数据点预览 (前 20 个):
  00:00: 128 bpm
  00:30: 139 bpm
  01:00: 144 bpm
  01:30: 142 bpm  <- 自然下降
  02:00: 154 bpm
  ...

[OK] 数据点有自然变化，看起来是真实读取的
```

## 错误处理

### VL 模型错误

| 错误类型 | 原因 | 处理方式 |
|---------|------|----------|
| 超时 | 图片过大或网络问题 | 重试 3 次，间隔指数增长 |
| 解析失败 | JSON 格式错误 | 尝试从响应中提取 JSON |
| 内容为空 | 模型未返回内容 | 返回失败结果 |

### 降级策略

当心率提取失败时：
1. 记录错误日志
2. 返回 `HeartRateExtractionResult(success=False, error_message="...")`
3. 报告生成使用降级模式（无心率分析）

## 兼容性

### 与 v9.0 的兼容性

| 接口 | 兼容性 |
|------|--------|
| POST /upload/heart-rate | ✅ 完全兼容 |
| POST /reports/v2/create | ✅ 完全兼容 |
| GET /reports/v2/generate/{id} | ✅ 完全兼容 |
| GET /reports/detail/{id} | ✅ 完全兼容 |

### 数据格式兼容性

输出数据格式与 v9.0 完全一致，仅数据内容更准确。

## 相关文档

- [PRD v9.1 - 心率提取优化](../prd/v9.1-heart-rate-extraction-optimization.md)
- [API v9.0 - 心率报告接口](v9.0-heart-rate-report-api.md)
- [PRD v9.0 - 心率数据集成](../prd/v9.0-heart-rate-report-v2.md)
