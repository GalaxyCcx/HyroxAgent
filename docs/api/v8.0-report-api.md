# API 文档 v8.0 - 专业分析报告接口

## 概述

专业分析报告 API 提供报告的创建、生成进度订阅、状态查询和详情获取功能。

**Base URL**: `/api/v1/reports`

## 接口列表

### 1. 创建报告

创建一个新的专业分析报告，或返回已存在的报告。

**请求**
```
POST /api/v1/reports/create
Content-Type: application/json
```

**请求体**
```json
{
  "season": 8,
  "location": "valencia",
  "athlete_name": "Ferrer, Yoel",
  "user_id": 123  // 可选
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| season | int | 是 | 赛季编号 |
| location | string | 是 | 比赛地点（小写） |
| athlete_name | string | 是 | 运动员姓名 |
| user_id | int | 否 | 用户 ID |

**响应**
```json
{
  "report_id": "1fa38cd0-974b-4586-9b22-8b2014b5da8a",
  "status": "created",
  "message": "报告创建成功，请订阅生成进度"
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| report_id | string | 报告唯一标识 (UUID) |
| status | string | 状态：`created`（新建）/ `exists`（已存在）/ `generating`（生成中） |
| message | string | 提示信息 |

---

### 2. 订阅生成进度 (SSE)

通过 Server-Sent Events 订阅报告生成进度。

**请求**
```
GET /api/v1/reports/generate/{report_id}
Accept: text/event-stream
```

**事件类型**

#### progress 事件
```
event: progress
data: {"progress": 15, "step": "正在分析: 总体表现概述"}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| progress | int | 进度百分比 (0-100) |
| step | string | 当前步骤描述 |

#### complete 事件
```
event: complete
data: {"report_id": "xxx", "status": "completed"}
```

#### error 事件
```
event: error
data: {"message": "报告生成失败: xxx"}
```

**进度节点**
| 进度 | 步骤 |
|------|------|
| 5% | 初始化报告生成... |
| 10% | 运动员信息加载完成 |
| 15% | 正在分析: 总体表现概述 |
| 27% | 正在分析: 跑步能力分析 |
| 39% | 正在分析: 功能站表现分析 |
| 51% | 正在分析: 体能分配策略分析 |
| 63% | 正在分析: 训练提升建议 |
| 75% | 章节分析完成，生成摘要... |
| 85% | 摘要生成完成，保存报告... |
| 100% | 报告生成完成！ |

---

### 3. 获取报告状态

查询报告当前状态和进度。

**请求**
```
GET /api/v1/reports/status/{report_id}
```

**响应**
```json
{
  "report_id": "1fa38cd0-974b-4586-9b22-8b2014b5da8a",
  "status": "generating",
  "progress": 45,
  "current_step": "正在分析: 功能站表现分析",
  "title": "Ferrer, Yoel - HYROX valencia S8 专业分析报告"
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| report_id | string | 报告 ID |
| status | string | 状态：`pending` / `generating` / `completed` / `error` |
| progress | int | 进度百分比 |
| current_step | string | 当前步骤 |
| title | string | 报告标题 |

---

### 4. 获取报告详情

获取完整的报告内容。

**请求**
```
GET /api/v1/reports/detail/{report_id}
```

**响应**
```json
{
  "report_id": "1fa38cd0-974b-4586-9b22-8b2014b5da8a",
  "title": "Ferrer, Yoel - HYROX valencia S8 专业分析报告",
  "season": 8,
  "location": "valencia",
  "athlete_name": "Ferrer, Yoel",
  "gender": "male",
  "division": "open",
  "status": "completed",
  "introduction": "在第 8 赛季 HYROX Valencia 站的比赛中...",
  "sections": [
    {
      "section_id": "overview",
      "title": "总体表现概述",
      "content": "### 【现状】完赛时间...\n\n| 指标 | 运动员 | 组别平均 |...\n\n[CHART:chart_overview_1]",
      "discoveries": [...],
      "conclusion": "整体表现..."
    }
  ],
  "charts": {
    "chart_overview_1": {
      "config": { /* ECharts 配置 */ },
      "purpose": "各站点耗时对比",
      "chart_type": "bar"
    }
  },
  "conclusion": "## 总结与建议\n\n...",
  "created_at": "2026-01-27T00:15:00Z",
  "completed_at": "2026-01-27T00:18:30Z"
}
```

**sections 数组元素**
| 字段 | 类型 | 说明 |
|------|------|------|
| section_id | string | 章节 ID |
| title | string | 章节标题 |
| content | string | Markdown 内容（含 [CHART:id] 标记） |
| discoveries | array | 发现点列表 |
| conclusion | string | 章节结论 |

**charts 对象**
| 字段 | 类型 | 说明 |
|------|------|------|
| config | object | ECharts option 配置 |
| purpose | string | 图表用途说明 |
| chart_type | string | 图表类型 |

---

### 5. 获取用户报告列表

获取用户的所有报告。

**请求**
```
GET /api/v1/reports/list?user_id=123&athlete_name=Ferrer,%20Yoel
```

**查询参数**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | int | 否 | 用户 ID |
| athlete_name | string | 否 | 运动员姓名 |

**响应**
```json
{
  "reports": [
    {
      "report_id": "xxx",
      "title": "Ferrer, Yoel - HYROX valencia S8",
      "status": "completed",
      "created_at": "2026-01-27T00:15:00Z"
    }
  ],
  "total": 1
}
```

---

## 错误处理

**HTTP 状态码**
| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 404 | 报告不存在 |
| 500 | 服务器内部错误 |

**错误响应格式**
```json
{
  "detail": "报告不存在"
}
```

---

## 前端使用示例

### 创建并订阅报告生成

```typescript
// 1. 创建报告
const createResult = await reportApi.create(season, location, athleteName);

if (createResult.status === 'exists') {
  // 报告已存在，直接跳转查看
  navigateToReport(createResult.report_id);
  return;
}

// 2. 订阅 SSE 进度
const eventSource = new EventSource(
  `${API_BASE_URL}/reports/generate/${createResult.report_id}`
);

eventSource.addEventListener('progress', (event) => {
  const data = JSON.parse(event.data);
  setProgress(data.progress);
  setStep(data.step);
});

eventSource.addEventListener('complete', (event) => {
  eventSource.close();
  setReportCompleted(true);
});

eventSource.addEventListener('error', (event) => {
  eventSource.close();
  showError('报告生成失败');
});
```

### 渲染报告内容

```typescript
// 解析图表标记
function parseChartMarkers(content: string, charts: Record<string, ChartConfig>) {
  const pattern = /\[CHART:([^\]]+)\]/g;
  // ... 返回 text 和 chart 混合数组
}

// 渲染
{contentParts.map((part) => 
  part.type === 'chart' 
    ? <ReportChart config={part.config} /> 
    : <ReactMarkdown>{part.content}</ReactMarkdown>
)}
```
