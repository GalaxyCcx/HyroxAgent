# API 文档: v3.0 分段统计接口

## 概述

本文档描述 v3.0 版本新增的分段统计接口，用于获取运动员在单场比赛中各分段的排名和与平均值的对比数据。

---

## 接口详情

### GET /api/v1/results/{season}/{location}/{name}/analytics

获取运动员单场比赛的分段统计数据。

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| season | int | 是 | 赛季 (1-10) |
| location | string | 是 | 比赛地点 (如 hong-kong, amsterdam) |
| name | string | 是 | 运动员姓名 (URL 编码) |

#### 请求示例

```
GET /api/v1/results/7/hong-kong/Cheng%2C%20Michelle/analytics
```

#### 响应结构

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "athlete_name": "Cheng, Michelle",
    "race_location": "hong-kong",
    "season": 7,
    "splits_analytics": [
      {
        "name": "Run 1",
        "type": "run",
        "time": "04:12",
        "time_minutes": 4.2,
        "rank": 42,
        "total": 412,
        "top_percent": 10.2,
        "avg_time_minutes": 4.55,
        "diff_seconds": -21,
        "diff_display": "-21s"
      },
      {
        "name": "SkiErg",
        "type": "workout",
        "time": "05:23",
        "time_minutes": 5.38,
        "rank": 85,
        "total": 412,
        "top_percent": 20.6,
        "avg_time_minutes": 5.12,
        "diff_seconds": 16,
        "diff_display": "+16s"
      }
    ]
  }
}
```

#### 响应字段说明

##### SplitAnalyticsData

| 字段 | 类型 | 说明 |
|------|------|------|
| athlete_name | string | 运动员姓名 |
| race_location | string | 比赛地点 |
| season | int | 赛季 |
| splits_analytics | SplitAnalyticsItem[] | 分段统计数组 (16项: 8 Run + 8 Station) |

##### SplitAnalyticsItem

| 字段 | 类型 | 说明 |
|------|------|------|
| name | string | 分段名称 (如 "Run 1", "SkiErg") |
| type | string | 分段类型: "run" 或 "workout" |
| time | string | 时间 (格式化, 如 "04:12") |
| time_minutes | float | 时间 (分钟) |
| rank | int | 该分段在全场的排名 |
| total | int | 全场有效数据总数 |
| top_percent | float | 百分位 (0-100) |
| avg_time_minutes | float | 全场该分段平均时间 (分钟) |
| diff_seconds | int | 与平均的差距 (秒), 负数表示快于平均 |
| diff_display | string | 差距展示文案 (如 "-21s", "+16s") |

#### 错误响应

| code | message | 说明 |
|------|---------|------|
| 404 | Race not found | 比赛不存在 |
| 404 | Athlete not found | 运动员不存在 |
| 500 | Internal server error | 服务器内部错误 |

---

## 计算逻辑

### Top% 计算

```python
# 1. 过滤掉该分段为空的记录
valid_data = race_data[race_data[split_key].notna()]

# 2. 获取该运动员的分段时间
athlete_time = valid_data[valid_data['name'] == athlete_name][split_key].iloc[0]

# 3. 计算排名（时间越短排名越前）
rank = (valid_data[split_key] < athlete_time).sum() + 1
total = len(valid_data)

# 4. 计算百分位
top_percent = (rank / total) * 100
```

### Δ Avg 计算

```python
# 1. 计算全场平均（分钟）
avg_time = valid_data[split_key].mean()

# 2. 计算差距（秒）
diff_minutes = athlete_time - avg_time
diff_seconds = round(diff_minutes * 60)

# 3. 格式化展示
if diff_seconds < 0:
    diff_display = f"{diff_seconds}s"  # 如 "-26s"
else:
    diff_display = f"+{diff_seconds}s"  # 如 "+12s"
```

---

## 使用场景

1. **SPLIT_CENTER 总览 Tab**: 显示所有 16 个分段的 Top% 和 Δ Avg
2. **RUN Tab**: 显示 8 段跑步的统计数据
3. **STATION Tab**: 显示 8 个站点的统计数据
4. **STATION_DETAIL**: 展示单个站点的详细排名信息

---

## 相关接口

- `GET /api/v1/athletes/suggest` - 名称建议
- `GET /api/v1/athletes/search` - 运动员搜索
- `GET /api/v1/results/{season}/{location}/{name}` - 成绩详情

