# v10.0 章节结构重构 - 技术变更日志

## 版本信息
- **版本号**: v10.0
- **日期**: 2026-01-28
- **类型**: 重构 (Refactoring)
- **影响范围**: 报告生成系统

## 变更概述

本次重构优化了报告章节结构，从 6 章精简为 5 章，解决了章节重复渲染和命名不一致的问题。

## 章节 ID 映射

| 旧 ID | 新 ID | 状态 |
|-------|-------|------|
| `summary` | `summary` | 标题更新 |
| `time_loss` | `time_loss` | 无变更 |
| `heart_rate` | `deep_dive` | **重命名** |
| `prediction` | `prediction` | 无变更 |
| `comparison` | - | **已删除** |
| `training` | `training` | 无变更 |

## 详细变更

### 1. section_definitions_v2.py

#### 变更 1.1: 更新 summary 标题

```python
# 行号: 17-19
# 变更前
"summary": {
    "section_id": "summary",
    "title": "成績總覽與定位",
    "description": "运动员整体成绩定位和能力评估",

# 变更后
"summary": {
    "section_id": "summary",
    "title": "核心摘要：ZONEØ 战力值",
    "description": "运动员整体成绩定位和能力评估，包含 ROXSCAN 综合评分和三维能力值",
```

#### 变更 1.2: 重命名 heart_rate → deep_dive

```python
# 行号: 234-237
# 变更前
"heart_rate": {
    "section_id": "heart_rate",
    "title": "ZONEØ 引擎深度復盤",

# 变更后
"deep_dive": {
    "section_id": "deep_dive",
    "title": "ZONEØ 引擎深度復盤",
```

#### 变更 1.3: 删除 comparison 章节

```python
# 行号: 503-591
# 删除整个 comparison 章节定义（约 88 行）
# "comparison": { ... }
```

#### 变更 1.4: 更新 get_all_section_ids()

```python
# 行号: 739-751
# 变更前
def get_all_section_ids() -> List[str]:
    """获取所有章节ID（按顺序）
    
    章节结构：
    - summary: 成绩总览与定位（第1章）
    - time_loss: 消失的五分钟（第2章）
    - heart_rate: ZONE0 引擎深度复盘（第3章）
    - prediction: 成绩预测（第4章）
    - comparison: 对标分析（第5章）
    - training: 训练计划（第6章）
    """
    return ["summary", "time_loss", "heart_rate", "prediction", "comparison", "training"]

# 变更后
def get_all_section_ids() -> List[str]:
    """获取所有章节ID（按顺序）
    
    章节结构（5章）：
    - summary: 核心摘要：ZONEØ 战力值（第1章）
    - time_loss: 消失的五分钟（第2章）
    - deep_dive: ZONEØ 引擎深度复盘（第3章）
    - prediction: 下一站预测与提升路径（第4章）
    - training: 定制化训练建议（第5章）
    """
    return ["summary", "time_loss", "deep_dive", "prediction", "training"]
```

---

### 2. section_agent.py

#### 变更 2.1: 重命名 prompt key

```python
# 行号: 119-120
# 变更前
# ==================== Heart Rate 章节提示词 ====================
"heart_rate": """你是一位专业的 HYROX 运动生理学分析师...

# 变更后
# ==================== Deep Dive 章节提示词 ====================
"deep_dive": """你是一位专业的 HYROX 运动生理学分析师...
```

#### 变更 2.2: 删除 comparison prompt

```python
# 行号: 222-260
# 删除整个 comparison 提示词（约 38 行）
# "comparison": """..."""
```

#### 变更 2.3: 更新条件判断

```python
# 行号: 531
# 变更前
elif section_id == "heart_rate" and section_data.get("heart_rate_data"):

# 变更后
elif section_id == "deep_dive" and section_data.get("heart_rate_data"):
```

---

### 3. report_generator.py

#### 变更 3.1: 更新 content 转换分支

```python
# 行号: 568
# 变更前
elif section_id == "heart_rate":
    # 心率分析章节 - 匹配 section_definitions_v2 的 output_schema

# 变更后
elif section_id == "deep_dive":
    # 深度复盘章节（心率分析）- 匹配 section_definitions_v2 的 output_schema
```

#### 变更 3.2: 删除 comparison 分支

```python
# 行号: 781-857
# 删除整个 comparison 分支的内容转换逻辑（约 77 行）
# elif section_id == "comparison": ...
```

---

### 4. LiveTab.tsx (前端)

#### 变更 4.1: 过滤 summary 章节

```tsx
// 行号: 1823-1854
// 变更前
{proReportDetail.sections && proReportDetail.sections.map((section: any, index: number) => {
  // ...
  <span>{index + 1}</span>  // 序号从 1 开始

// 变更后
{proReportDetail.sections && proReportDetail.sections
  .filter((section: any) => section.section_id !== "summary")  // 过滤 summary
  .map((section: any, index: number) => {
    // ...
    <span>{index + 2}</span>  // 序号从 2 开始
```

#### 变更 4.2: 调整章节颜色数量

```tsx
// 变更前
const sectionColors = [
  { from: 'from-cyan-500', ... },    // 5 种颜色
  { from: 'from-blue-500', ... },
  { from: 'from-purple-500', ... },
  { from: 'from-green-500', ... },
  { from: 'from-orange-500', ... },
];

// 变更后
const sectionColors = [
  { from: 'from-cyan-500', ... },    // 4 种颜色（对应 4 个章节）
  { from: 'from-purple-500', ... },
  { from: 'from-green-500', ... },
  { from: 'from-orange-500', ... },
];
```

## 数据结构变更

### 报告 sections 数组

```json
// 变更前（6 个章节）
{
  "sections": [
    {"section_id": "summary", "title": "成績總覽與定位", ...},
    {"section_id": "time_loss", ...},
    {"section_id": "heart_rate", ...},
    {"section_id": "prediction", ...},
    {"section_id": "comparison", ...},
    {"section_id": "training", ...}
  ]
}

// 变更后（5 个章节）
{
  "sections": [
    {"section_id": "summary", "title": "核心摘要：ZONEØ 战力值", ...},
    {"section_id": "time_loss", ...},
    {"section_id": "deep_dive", ...},
    {"section_id": "prediction", ...},
    {"section_id": "training", ...}
  ]
}
```

## API 兼容性

本次重构 **不影响 API 接口**，仅修改内部生成逻辑：

| 接口 | 兼容性 | 说明 |
|------|--------|------|
| `POST /api/v1/reports/create` | ✅ 兼容 | 无变更 |
| `GET /api/v1/reports/generate/{id}` | ✅ 兼容 | 返回的 sections 数量从 6 变为 5 |
| `GET /api/v1/reports/detail/{id}` | ✅ 兼容 | 返回的 sections 数量从 6 变为 5 |

## 回滚方案

如需回滚，恢复以下文件到变更前状态：

1. `backend/app/services/report/section_definitions_v2.py`
2. `backend/app/services/report/section_agent.py`
3. `backend/app/services/report/report_generator.py`
4. `frontend/src/screens/LiveTab.tsx`

## 测试验证

```bash
# 1. 验证章节 ID 列表
python -c "from app.services.report.section_definitions_v2 import get_all_section_ids; print(get_all_section_ids())"
# 预期输出: ['summary', 'time_loss', 'deep_dive', 'prediction', 'training']

# 2. 验证无 comparison 引用
grep -r "comparison" backend/app/services/report/*.py
# 预期输出: 无匹配（除了 segment_comparison 数据字段）

# 3. 验证前端过滤逻辑
grep "section_id !== \"summary\"" frontend/src/screens/LiveTab.tsx
# 预期输出: 找到匹配行
```

## 相关文档

- [PRD v10.0](../prd/v10.0-section-structure-refactor.md)
- [PRD v9.0](../prd/v9.0-heart-rate-report-v2.md)
