# 技术文档 v10.0 - 图表数据格式规范

## 版本信息
- **版本号**: v10.0
- **日期**: 2026-01-29
- **状态**: 已完成

## 概述

本文档定义了报告系统中图表数据的前后端数据格式规范，确保后端生成的图表数据能被前端正确渲染。

## 图表类型分类

报告系统支持两类图表：

### 1. 通用 ECharts 图表
使用标准 ECharts 配置格式，由前端 `ReactECharts` 组件直接渲染。

**适用类型**：`bar`, `line`, `pie`, `scatter`, `heatmap`

### 2. 专用组件图表
使用自定义数据格式，由专用 React 组件渲染。

**适用类型**：`radar`, `waterfall`, `hr_pace`, `prediction_tiers`, `prediction_density`, `pacing_consistency`, `cohort_comparison`, `training_week_view`, `priority_matrix`, `horizontal_bar`, `splits_breakdown`, `distribution_histogram`

## 专用组件数据格式规范

### RadarChart (雷达图)

**前端组件**：`frontend/src/components/charts/RadarChart.tsx`

**数据格式**：
```typescript
interface RadarChartConfig {
  dimensions: RadarDimension[];
  dataSets: RadarDataSet[];
  title?: string;
  subtitle?: string;
  showLegend?: boolean;
}

interface RadarDimension {
  name: string;        // 维度名称，如 "力量"
  max: number;         // 最大值，通常为 100
  description?: string; // 维度描述
}

interface RadarDataSet {
  name: string;        // 数据集名称，如 "运动员"
  values: number[];    // 各维度的值，顺序与 dimensions 对应
}
```

**后端生成示例** (`chart_builder.py`):
```python
config = {
    "dimensions": [
        {"name": "力量", "max": 100, "description": "功能站表现"},
        {"name": "有氧底座", "max": 100, "description": "跑步耐力"},
        {"name": "转换效率", "max": 100, "description": "Roxzone时间"},
    ],
    "dataSets": [
        {
            "name": "运动员",
            "values": [72, 68, 81]  # 对应三个维度
        }
    ],
    "title": "ZONEØ 三维能力评估",
    "subtitle": "综合评分: 74分",
    "showLegend": True,
}
```

### HorizontalBar (水平柱状图)

**前端组件**：`frontend/src/components/charts/HorizontalBar.tsx`

**数据格式**：
```typescript
interface HorizontalBarConfig {
  items: BarItem[];
  title?: string;
  subtitle?: string;
  maxValue?: number;
}

interface BarItem {
  name: string;       // 项目名称
  value: number;      // 数值
  color?: string;     // 可选颜色
  label?: string;     // 可选标签
}
```

### PredictionTiers (五档预测)

**前端组件**：`frontend/src/components/charts/PredictionTiers.tsx`

**数据格式**：
```typescript
interface PredictionTiersConfig {
  tiers: {
    excellent: TierData;
    great: TierData;
    expected: TierData;
    subpar: TierData;
    poor: TierData;
  };
  currentTime: number;  // 当前成绩（秒）
  title?: string;
}

interface TierData {
  percentile: number;
  time_seconds: number;
  delta: number;        // 相对当前的差值
}
```

### DistributionHistogram (分布直方图)

**前端组件**：`frontend/src/components/charts/DistributionHistogram.tsx`

**数据格式**：
```typescript
interface DistributionHistogramConfig {
  bins: BinData[];
  userPosition: {
    value: number;
    percentile: number;
  };
  title?: string;
  xAxisLabel?: string;
  yAxisLabel?: string;
}

interface BinData {
  range: [number, number];  // 区间范围
  count: number;            // 该区间人数
  isUserBin?: boolean;      // 用户所在区间
}
```

### PriorityMatrix (优先级矩阵)

**前端组件**：`frontend/src/components/charts/PriorityMatrix.tsx`

**数据格式**：
```typescript
interface PriorityMatrixConfig {
  items: MatrixItem[];
  xAxisLabel?: string;  // 默认 "改进难度"
  yAxisLabel?: string;  // 默认 "影响程度"
  title?: string;
}

interface MatrixItem {
  name: string;
  impact: number;      // Y轴：影响程度 (0-100)
  difficulty: number;  // X轴：改进难度 (0-100)
  category?: string;   // 分类标签
}
```

## 图表渲染流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      ReportChart.tsx                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 接收 props: { chartId, config, chartType, purpose }         │
│                                                                  │
│  2. 检查 chartType 是否为专用类型                                │
│     SPECIALIZED_CHART_TYPES = [                                 │
│       'radar', 'waterfall', 'hr_pace', 'prediction_tiers',      │
│       'prediction_density', 'pacing_consistency', ...           │
│     ]                                                            │
│                                                                  │
│  3a. 专用类型 → SpecializedChartRenderer                        │
│      └─> 根据 chartType 选择对应组件                             │
│          case 'radar': return <RadarChart {...config} />        │
│                                                                  │
│  3b. 通用类型 → GenericChartRenderer                            │
│      └─> 验证并渲染 ECharts 配置                                 │
│          return <ReactECharts option={config} />                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 后端图表构建指南

### 添加新的专用图表类型

1. **创建前端组件**
   ```
   frontend/src/components/charts/NewChart.tsx
   ```

2. **定义 TypeScript 接口**
   ```typescript
   // frontend/src/types/charts.ts
   export interface NewChartConfig {
     // 定义数据结构
   }
   ```

3. **注册到 SpecializedChartRenderer**
   ```typescript
   // ReportChart.tsx
   case 'new_chart':
     return <NewChart {...config} />;
   ```

4. **后端实现构建方法**
   ```python
   # chart_builder.py
   def _build_new_chart(self, data: SomeData) -> ChartConfig:
       config = {
           # 按前端组件期望的格式构建数据
       }
       return ChartConfig(
           chart_id="new_chart",
           chart_type="new_chart",
           title="新图表",
           config=config
       )
   ```

5. **添加到章节定义**
   ```python
   # section_definitions_v2.py
   "charts": [
       {
           "chart_id": "chart_xxx_new",
           "chart_type": "new_chart",
           "data_source": "some_data",
       }
   ]
   ```

## 调试技巧

### 检查图表数据流

1. **后端日志**：在 `chart_builder.py` 添加日志查看生成的配置
2. **API 响应**：检查 `/api/v1/report/{id}` 返回的 `charts` 字段
3. **前端控制台**：在 `ReportChart.tsx` 添加 `console.log(config)` 查看接收的数据

### 常见问题排查

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 图表不显示 | chartType 未注册 | 在 SPECIALIZED_CHART_TYPES 中添加类型 |
| 数据格式错误 | 前后端格式不匹配 | 检查后端输出是否符合前端接口定义 |
| 图表为空 | config 为空或字段缺失 | 检查数据源是否正确传递 |

## 版本变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v10.0 | 2026-01-29 | 新增雷达图专用格式规范；修复 RadarChart 数据格式不匹配问题 |
| v8.0 | 2026-01-27 | 初始图表系统设计 |
