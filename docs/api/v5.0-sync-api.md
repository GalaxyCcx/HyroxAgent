# 数据同步 API 文档

## 概述

本文档描述 HyroxAgent 数据同步 API，用于从 HYROX 官方 API 同步数据到本地 SQLite 数据库。

- **基础路径**: `/api/v1/sync`
- **认证**: 无 (建议生产环境添加)

---

## API 端点

### 1. 同步指定赛季

```
POST /api/v1/sync/season/{season}
```

同步指定赛季的全部比赛数据。

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| season | int | 是 | 赛季编号 (1-8) |

#### 请求示例

```bash
curl -X POST http://localhost:8000/api/v1/sync/season/8
```

#### 响应示例

```json
{
  "success": true,
  "season": 8,
  "races_count": 50,
  "records_count": 150000,
  "duration_seconds": 45.2,
  "error_message": null
}
```

#### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| success | bool | 是否成功 |
| season | int | 赛季编号 |
| races_count | int | 同步的比赛数量 |
| records_count | int | 同步的成绩记录数 |
| duration_seconds | float | 耗时（秒）|
| error_message | string | 错误信息（失败时）|

---

### 2. 同步单场比赛

```
POST /api/v1/sync/race
```

同步指定单场比赛数据。

#### 请求体

```json
{
  "season": 8,
  "location": "shanghai"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| season | int | 是 | 赛季编号 (1-8) |
| location | string | 是 | 比赛地点 (小写英文) |

#### 请求示例

```bash
curl -X POST http://localhost:8000/api/v1/sync/race \
  -H "Content-Type: application/json" \
  -d '{"season": 8, "location": "shanghai"}'
```

#### 响应示例

```json
{
  "success": true,
  "season": 8,
  "location": "shanghai",
  "records_count": 3032,
  "duration_seconds": 2.5,
  "error_message": null
}
```

#### 常见 location 值

| 地点 | 说明 |
|------|------|
| shanghai | 上海 |
| beijing | 北京 |
| shenzhen | 深圳 |
| hong-kong | 香港 |
| taipei | 台北 |
| amsterdam | 阿姆斯特丹 |
| berlin | 柏林 |
| london | 伦敦 |

---

### 3. 同步所有数据

```
POST /api/v1/sync/all
```

同步所有赛季（Season 1-8）的全部数据。

**警告**: 此操作可能需要较长时间（约 5-10 分钟）。

#### 请求示例

```bash
curl -X POST http://localhost:8000/api/v1/sync/all
```

#### 响应示例

```json
{
  "success": true,
  "seasons_synced": 8,
  "total_races": 238,
  "total_records": 700000,
  "duration_seconds": 360.5
}
```

#### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| success | bool | 是否成功 |
| seasons_synced | int | 同步的赛季数 |
| total_races | int | 总比赛数 |
| total_records | int | 总记录数 |
| duration_seconds | float | 总耗时（秒）|

---

### 4. 获取同步状态

```
GET /api/v1/sync/status
```

获取同步状态和数据库统计信息。

#### 请求示例

```bash
curl http://localhost:8000/api/v1/sync/status
```

#### 响应示例

```json
{
  "database_path": "D:\\HyroxAgent\\data\\hyrox.db",
  "database_size_mb": 85.5,
  "total_races": 238,
  "total_results": 700000,
  "last_sync": "2026-01-22T10:30:00",
  "seasons": [
    {
      "season": 8,
      "races": 50,
      "results": 150000,
      "last_sync": "2026-01-22T10:30:00"
    },
    {
      "season": 7,
      "races": 62,
      "results": 180000,
      "last_sync": "2026-01-22T10:25:00"
    }
  ]
}
```

#### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| database_path | string | 数据库文件路径 |
| database_size_mb | float | 数据库文件大小 (MB) |
| total_races | int | 总比赛数 |
| total_results | int | 总成绩记录数 |
| last_sync | string | 最后同步时间 (ISO 8601) |
| seasons | array | 各赛季统计详情 |

---

## 错误处理

### HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 500 | 服务器内部错误 |

### 错误响应示例

```json
{
  "detail": "Season must be between 1 and 8"
}
```

---

## 使用建议

### 首次部署

```bash
# 1. 启动服务
cd backend
python -m uvicorn app.main:app --reload

# 2. 同步所有数据（首次需要较长时间）
curl -X POST http://localhost:8000/api/v1/sync/all
```

### 日常更新

```bash
# 更新最新赛季
curl -X POST http://localhost:8000/api/v1/sync/season/8

# 更新单场比赛
curl -X POST http://localhost:8000/api/v1/sync/race \
  -H "Content-Type: application/json" \
  -d '{"season": 8, "location": "shanghai"}'
```

### 查看状态

```bash
# 查看数据库统计
curl http://localhost:8000/api/v1/sync/status
```

---

## 数据库表结构

### races 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| season | INTEGER | 赛季 |
| location | TEXT | 比赛地点 |
| file_last_modified | TEXT | 数据更新时间 |
| created_at | TIMESTAMP | 入库时间 |

### results 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| season | INTEGER | 赛季 |
| location | TEXT | 比赛地点 |
| name | TEXT | 选手姓名 |
| nationality | TEXT | 国籍 |
| gender | TEXT | 性别 |
| division | TEXT | 组别 |
| age_group | TEXT | 年龄组 |
| total_time | REAL | 总成绩 (分钟) |
| ... | | 其他分段时间字段 |

### sync_log 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| season | INTEGER | 同步赛季 |
| location | TEXT | 同步比赛 |
| status | TEXT | success/failed |
| records_count | INTEGER | 记录数 |
| error_message | TEXT | 错误信息 |
| synced_at | TIMESTAMP | 同步时间 |

---

## 相关文档

- [PRD v5.0: 本地存储方案](../prd/v5.0-local-storage.md)
- [数据字典](./Data_Dictionary.md)
- [数据库开发规范](../../.cursor/rules/database.mdc)



