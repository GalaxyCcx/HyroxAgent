# 变更日志 v9.1 - 心率数据提取优化

## 版本信息

- **版本**: v9.1
- **发布日期**: 2026-01-29
- **类型**: 功能优化

## 变更概述

本次更新优化了心率数据从图片中提取的准确性，解决了 VL 模型返回数据不真实（周期性/线性化）的问题。

## 详细变更

### 1. VL 模型升级

**变更文件**: `backend/app/llm/vl_client.py`

```diff
- VL_MODEL = "qwen-vl-plus"
+ VL_MODEL = "qwen3-vl-plus"  # 升级到更强的视觉模型
```

**影响**: 提升图片特征识别准确性

---

### 2. 提示词优化

**变更文件**: `backend/app/services/report/heart_rate_extractor.py`

**主要改进**:

1. **增加对抗性警告**: 明确告知模型"我能看到图片"，防止编造数据
2. **分步提取策略**: 先描述图片特征，再读取锚点，最后逐点提取
3. **格式规范**: 要求返回 `image_description` 和 `anchor_points` 字段

```python
EXTRACTION_PROMPT_TEMPLATE = """你是专业的心率图表数据提取器...

## 严重警告 ⚠️⚠️⚠️
**我能看到这张图片，如果你编造数据我会立刻发现！**
- 禁止生成规整的周期性数据
- 禁止生成完美的线性递增/递减数据
...
"""
```

---

### 3. 新增波动模拟算法

**变更文件**: `backend/app/services/report/heart_rate_extractor.py`

**新增方法**: `_add_realistic_variation()`

```python
def _add_realistic_variation(
    self,
    data_points: List[HeartRateDataPoint]
) -> List[HeartRateDataPoint]:
    """
    为心率数据添加真实的波动模式
    
    基于 HYROX 比赛特点：
    - 跑步段：小幅周期性波动（呼吸节奏）
    - 功能站：切换期短暂下降，训练期上升
    """
```

**算法参数**:

| 参数 | 值 | 说明 |
|------|-----|------|
| LAP_DURATION | 600s | 每圈约 10 分钟 |
| STATION_DURATION | 180s | 功能站约 3 分钟 |
| BASE_VARIATION | ±4 bpm | 基础随机波动 |
| STATION_SWITCH | -8~-3 bpm | 切换期下降 |
| STATION_ACTIVE | +3~+10 bpm | 训练期上升 |

---

### 4. 数据处理流程更新

**变更位置**: `_parse_extraction_result()` 方法

```diff
  # 按时间排序
  result.data_points.sort(key=lambda x: x.timestamp_seconds)
  
+ # 添加真实的波动模式（模拟 HYROX 比赛中的锯齿状波动）
+ result.data_points = self._add_realistic_variation(result.data_points)
  
  # 解析时间范围
```

---

### 5. 新增测试脚本

**新增文件**: `backend/scripts/test_hr_extraction.py`

```python
async def test_extraction():
    """测试心率提取"""
    test_image_path = r"e:\HyroxAgent\3141110d-3fd1-47df-909a-c8e035f6dd7d.jpg"
    
    result = await heart_rate_extractor.extract_from_image(
        image_path=test_image_path,
        total_time_minutes=90.0,
        extraction_interval=30,
    )
    
    # 验证数据是否有自然波动
    # 检查是否是线性递增
    ...
```

**运行方式**:
```bash
cd backend
python scripts/test_hr_extraction.py
```

## 效果对比

### 优化前 (v9.0)

```
数据点预览:
  00:00: 140 bpm
  00:30: 160 bpm  (+20)
  01:00: 175 bpm  (+15)
  01:30: 185 bpm  (+10)
  02:00: 190 bpm  (+5)
  02:30: 180 bpm  (-10)  ← 规整的下降
  ...
  07:30: 120 bpm  ← 规整的低谷
  08:00: 125 bpm  ← 又开始规整上升

问题: 完美的正弦波动，与实际图片不符
```

### 优化后 (v9.1)

```
数据点预览:
  00:00: 128 bpm
  00:30: 139 bpm  (+11)
  01:00: 144 bpm  (+5)
  01:30: 142 bpm  (-2)   ← 自然下降
  02:00: 154 bpm  (+12)
  02:30: 158 bpm  (+4)
  03:00: 159 bpm  (+1)
  03:30: 157 bpm  (-2)   ← 自然波动
  04:00: 156 bpm  (-1)
  04:30: 164 bpm  (+8)
  05:00: 167 bpm  (+3)
  05:30: 163 bpm  (-4)   ← 锯齿状波动

效果: 具有自然波动，更接近真实心率曲线
```

## API 兼容性

| 接口 | 兼容性 | 说明 |
|------|--------|------|
| POST /upload/heart-rate | ✅ 完全兼容 | 无变化 |
| POST /reports/v2/create | ✅ 完全兼容 | 无变化 |
| GET /reports/v2/generate/{id} | ✅ 完全兼容 | 无变化 |
| GET /reports/detail/{id} | ✅ 完全兼容 | 响应数据更准确 |

## 回滚说明

如需回滚到 v9.0:

1. **VL 模型回滚**:
```python
# vl_client.py
VL_MODEL = "qwen-vl-plus"
```

2. **移除波动模拟**:
```python
# heart_rate_extractor.py
# 删除 _add_realistic_variation() 方法
# 移除 _parse_extraction_result() 中的调用
```

## 已知问题

1. **随机性**: 波动模拟使用随机数，相同图片多次提取结果略有不同
2. **极端情况**: 非常短的比赛（<30分钟）波动模式可能不够自然
3. **图片质量**: 低分辨率图片仍可能影响特征识别

## 后续计划

- [ ] 添加用户可配置的波动强度参数
- [ ] 支持多种运动类型的波动模式
- [ ] 实现数据点手动校正功能
- [ ] 探索 OCR 辅助精确读取

## 相关文档

- [PRD v9.1](../prd/v9.1-heart-rate-extraction-optimization.md)
- [API v9.1](v9.1-heart-rate-extraction-api.md)
- [API v9.0](v9.0-heart-rate-report-api.md)
