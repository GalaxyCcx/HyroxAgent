<!--个人资料页-->
<view class="page-container">
  <view class="content">
    <!-- 未登录状态 -->
    <block wx:if="{{!isLoggedIn}}">
      <view class="login-section">
        <view class="login-icon">👤</view>
        <text class="login-title">登录 HYROX Agent</text>
        <text class="login-desc">登录后可保存比赛数据、查看历史记录</text>
        
        <button 
          class="login-btn {{isLoading ? 'loading' : ''}}"
          bindtap="onLogin"
          disabled="{{isLoading}}"
        >
          <text class="btn-icon" wx:if="{{!isLoading}}">🔐</text>
          <view class="loading-spinner" wx:if="{{isLoading}}"></view>
          <text class="btn-text">{{isLoading ? '登录中...' : '微信一键登录'}}</text>
        </button>
        
        <text class="login-tip">登录即表示同意服务条款和隐私政策</text>
      </view>

      <!-- 搜索入口 -->
      <view class="guest-search" bindtap="onGoSearch">
        <text class="search-icon">🔍</text>
        <text class="search-text">不登录也可以搜索运动员</text>
        <text class="search-arrow">→</text>
      </view>
    </block>

    <!-- 已登录状态 -->
    <block wx:else>
      <!-- 头像区域 -->
      <view class="profile-header">
        <view class="avatar-wrapper" bindtap="onEditProfile">
          <image 
            class="avatar-img" 
            src="{{user.avatar_url}}" 
            mode="aspectFill"
            wx:if="{{user.avatar_url}}"
          />
          <view class="avatar-placeholder" wx:else>
            <text class="avatar-text">{{user.nickname ? user.nickname[0] : '?'}}</text>
          </view>
        </view>
        
        <view class="user-info" bindtap="onEditProfile">
          <text class="user-name">{{user.nickname || '点击设置昵称'}}</text>
          <view class="user-tags">
            <text class="tag id-tag">ID: {{user.id}}</text>
          </view>
        </view>
        
        <view class="settings-btn" bindtap="onSettings">
          <text class="settings-icon">⚙️</text>
        </view>
      </view>

      <!-- 统计数据 -->
      <view class="stats-grid">
        <view class="stat-card">
          <text class="stat-label">已认领比赛</text>
          <text class="stat-value">{{stats.completed}}</text>
        </view>
        <view class="stat-card highlight">
          <text class="stat-label primary">个人最佳 (PB)</text>
          <text class="stat-value">{{stats.pb}}</text>
        </view>
      </view>

      <!-- Tab 栏 -->
      <view class="tabs">
        <view 
          class="tab {{activeTab === 'races' ? 'active' : ''}}"
          data-tab="races"
          bindtap="onTabChange"
        >我的比赛</view>
        <view 
          class="tab {{activeTab === 'training' ? 'active' : ''}}"
          data-tab="training"
          bindtap="onTabChange"
        >训练数据</view>
      </view>

      <!-- 比赛 Tab 内容 -->
      <block wx:if="{{activeTab === 'races'}}">
        <!-- 搜索入口 -->
        <view class="search-entry" bindtap="onGoSearch">
          <text class="search-icon">🔍</text>
          <text class="search-text">搜索并认领更多比赛...</text>
          <text class="search-arrow">→</text>
        </view>

        <!-- 加载中 -->
        <view class="loading-state" wx:if="{{claimedLoading}}">
          <view class="loading-spinner"></view>
          <text class="loading-text">加载中...</text>
        </view>

        <!-- 已认领比赛列表 - Demo 风格 -->
        <view class="claimed-list" wx:if="{{!claimedLoading && claimedRaces.length > 0}}">
          <view 
            class="race-card"
            wx:for="{{claimedRaces}}"
            wx:key="id"
          >
            <!-- 卡片头部：标题 + 徽章 + 菜单 -->
            <view class="race-card-header">
              <view class="race-title-row">
                <text class="race-title">{{item.event_name}}</text>
                <view class="verified-badge">
                  <text class="verified-icon">✓</text>
                  <text class="verified-text">已认领</text>
                </view>
              </view>
              <view 
                class="more-menu-btn" 
                catchtap="onShowCardMenu" 
                data-item="{{item}}"
                data-index="{{index}}"
              >
                <text class="more-icon">⋮</text>
              </view>
            </view>
            
            <!-- 副标题 -->
            <view class="race-subtitle">
              <text>{{item.athlete_name}} • S{{item.season}}</text>
            </view>
            
            <!-- 大号总时间 -->
            <view class="race-time-display">
              <text class="race-total-time">{{item.total_time}}</text>
              <text class="race-time-label">总时间</text>
            </view>
            
            <!-- 底部按钮 -->
            <view 
              class="race-action-btn"
              data-item="{{item}}"
              bindtap="onViewSplits"
            >
              <text>查看分段</text>
              <text class="action-arrow">→</text>
            </view>
            
            <!-- 卡片内菜单（隐藏状态） -->
            <view class="card-menu {{activeMenuIndex === index ? 'show' : ''}}" wx:if="{{activeMenuIndex === index}}">
              <view class="menu-mask" catchtap="onHideCardMenu"></view>
              <view class="menu-content">
                <view 
                  class="menu-item danger" 
                  catchtap="onUnclaimFromList" 
                  data-item="{{item}}"
                >
                  <text class="menu-icon">🔗</text>
                  <text>解除绑定</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 空状态 -->
        <view class="empty-state" wx:if="{{!claimedLoading && claimedRaces.length === 0}}">
          <view class="empty-icon">🏃</view>
          <text class="empty-title">暂无认领的比赛</text>
          <text class="empty-desc">搜索运动员并认领您的比赛成绩</text>
          <view class="empty-btn" bindtap="onGoSearch">
            <text>去搜索</text>
          </view>
        </view>
      </block>

      <!-- 训练数据 Tab 内容 -->
      <block wx:if="{{activeTab === 'training'}}">
        <view class="empty-state">
          <view class="empty-icon">📊</view>
          <text class="empty-title">训练数据功能开发中</text>
          <text class="empty-desc">敬请期待</text>
        </view>
      </block>
    </block>
  </view>
</view>
