<!--快速分析 (Lite) 页面-->
<view class="page-container">
  <!-- 头部 -->
  <view class="header" style="padding-top: {{statusBarHeight}}px;">
    <view class="header-row" style="height: {{navBarHeight}}px; padding-right: {{menuRight + 10}}px;">
      <view class="back-btn" bindtap="onBack">
        <text class="back-icon">‹</text>
      </view>
      <text class="header-title">赛后分析 (Lite)</text>
      <view class="header-placeholder"></view>
    </view>
    
    <!-- 信息栏 -->
    <view class="info-bar" style="padding-right: {{menuRight + 10}}px;" wx:if="{{!loading && !error}}">
      <text class="info-item">{{raceName}}</text>
      <text class="info-divider">|</text>
      <text class="info-item">{{division}}</text>
      <text class="info-divider">|</text>
      <text class="info-item">{{athleteName}}</text>
      <text class="info-divider">|</text>
      <text class="info-item">{{totalTime}}</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">AI 分析生成中...</text>
    <text class="loading-sub">首次分析需要约 10 秒</text>
  </view>

  <!-- 错误状态 -->
  <view class="error-state" wx:if="{{!loading && error}}">
    <text class="error-icon">⚠️</text>
    <text class="error-text">{{error}}</text>
    <view class="retry-btn" bindtap="loadAnalysis">重试</view>
  </view>

  <!-- 内容区域 -->
  <scroll-view scroll-y class="content" wx:if="{{!loading && !error}}">
    <!-- Hero 卡片 - 2x2 网格布局 -->
    <view class="hero-card">
      <view class="hero-top">
        <view class="hero-badge">
          <text class="badge-icon">📍</text>
          <text class="badge-text">{{raceName || location}}</text>
        </view>
      </view>
      
      <view class="hero-grid">
        <!-- 完赛时间 -->
        <view class="hero-stat-box">
          <text class="stat-value-xl">{{totalTime}}</text>
          <text class="stat-label">完赛时间</text>
        </view>
        <!-- 总排名 -->
        <view class="hero-stat-box">
          <text class="stat-value-xl">{{overallRank}}<text class="stat-sub">/{{overallTotal}}</text></text>
          <text class="stat-label">总排名</text>
        </view>
        <!-- 组别 -->
        <view class="hero-stat-box">
          <text class="stat-value-xl highlight">{{division}}</text>
          <text class="stat-label">组别</text>
        </view>
        <!-- 年龄组排名 -->
        <view class="hero-stat-box" wx:if="{{ageGroupRank > 0 && ageGroupTotal > 0}}">
          <text class="stat-value-xl">{{ageGroupRank}}<text class="stat-sub">/{{ageGroupTotal}}</text></text>
          <text class="stat-label">年龄组排名</text>
        </view>
        <view class="hero-stat-box" wx:else>
          <text class="stat-value-xl">-</text>
          <text class="stat-label">年龄组排名</text>
        </view>
      </view>
    </view>

    <!-- 一句话结论 -->
    <view class="conclusion-card">
      <view class="card-header">
        <text class="card-icon">🧠</text>
        <text class="card-title">一句话结论</text>
      </view>
      <view class="analysis-scope conclusion-scope" wx:if="{{analysisScope}}">
        <text>分析口径：{{analysisScope}}</text>
      </view>
      <rich-text class="conclusion-text" nodes="{{summaryHtml}}"></rich-text>
      <view class="conclusion-hint">
        <text>想了解逐段与顶尖水平的对比、省时拆解与训练建议？解锁详细报告获取完整分析。</text>
      </view>
      <view class="card-glow"></view>
    </view>

    <!-- 优势/短板网格 -->
    <view class="grid-row">
      <!-- 优势卡片 -->
      <view class="grid-card strength">
        <view class="grid-header">
          <text class="grid-icon good">✓</text>
          <text class="grid-title">优势</text>
        </view>
        <view class="analysis-scope" wx:if="{{analysisScope}}">
          <text>分析口径：{{analysisScope}}</text>
        </view>
        <view class="grid-list">
          <view class="grid-item" wx:for="{{strengths}}" wx:key="index">
            <text class="item-dot good"></text>
            <view class="item-content">
              <text class="item-text">{{item.text}}</text>
              <view class="percentile-tag good" wx:if="{{item.percentile != null}}">
                <text>top {{item.percentile}}%</text>
              </view>
            </view>
          </view>
          <view class="grid-item empty" wx:if="{{strengths.length === 0}}">
            <text class="item-text muted">暂无数据</text>
          </view>
        </view>
      </view>
      
      <!-- 短板卡片 -->
      <view class="grid-card weakness">
        <view class="grid-header">
          <text class="grid-icon warn">⚠</text>
          <text class="grid-title">短板</text>
        </view>
        <view class="analysis-scope" wx:if="{{analysisScope}}">
          <text>分析口径：{{analysisScope}}</text>
        </view>
        <view class="grid-list">
          <view class="grid-item" wx:for="{{weaknesses}}" wx:key="index">
            <text class="item-dot warn"></text>
            <view class="item-content">
              <text class="item-text">{{item.text}}</text>
              <view class="percentile-tag {{item.percentile <= 25 ? 'good' : 'warn'}}" wx:if="{{item.percentile != null}}">
                <text>top {{item.percentile}}%</text>
              </view>
            </view>
          </view>
          <view class="grid-item empty" wx:if="{{weaknesses.length === 0}}">
            <text class="item-text muted">暂无数据</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 提示文案 -->
    <text class="hint-text">想看逐段对比与省时拆解？</text>

    <!-- 解锁按钮 -->
    <view class="unlock-btn" bindtap="onUnlockPro">
      <text class="unlock-icon">🔒</text>
      <text class="unlock-text">¥9.9 解锁详细分段报告 (PDF)</text>
    </view>

    <!-- 底部操作 -->
    <view class="action-row">
      <button class="action-btn" open-type="share">
        <text class="action-icon">↗</text>
        <text class="action-text">分享战报</text>
      </button>
      <view class="action-btn" bindtap="onBackToSummary">
        <text class="action-text">回到比赛总结</text>
      </view>
    </view>

    <!-- 锁定的预览内容 -->
    <view class="locked-card">
      <view class="locked-header">
        <view class="locked-num">3</view>
        <text class="locked-title">心率分配控制</text>
      </view>
      <text class="locked-desc">跑步段落严格控制在阈值区间，为力量站点储备体能...</text>
      <view class="locked-overlay">
        <text class="locked-icon">🔒</text>
      </view>
    </view>

    <!-- 缓存提示 -->
    <view class="cache-hint" wx:if="{{cached}}">
      <text class="cache-text">💾 已缓存的分析结果</text>
    </view>
  </scroll-view>

  <!-- 心率图片上传弹窗 -->
  <view class="modal-overlay" wx:if="{{showUploadModal}}" bind:tap="onCloseModal">
    <view class="modal-container" catch:tap>
      <view class="modal-header">
        <text class="modal-title">上传心率截图</text>
        <view class="modal-close" bind:tap="onCloseModal">×</view>
      </view>
      
      <view class="modal-body">
        <view class="modal-hint">
          <text>上传运动手表的心率截图（可选），AI 将为您生成更精准的心率分析报告</text>
        </view>
        
        <image-uploader
          title="心率截图"
          hint="支持 PNG/JPG 格式，最多3张"
          max-count="{{3}}"
          images="{{heartRateImages}}"
          bind:change="onHeartRateImagesChange"
        />
      </view>
      
      <view class="modal-footer">
        <view class="modal-btn secondary" bind:tap="onSkipUpload">
          <text>跳过，直接生成</text>
        </view>
        <view class="modal-btn primary" bind:tap="onConfirmUpload">
          <text>{{heartRateImages.length > 0 ? '开始生成报告' : '跳过并生成'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 生成进度弹窗 -->
  <view class="modal-overlay" wx:if="{{showProgressModal}}">
    <view class="modal-container progress-modal">
      <view class="progress-icon">
        <view class="pulse-ring"></view>
        <text class="icon-text">AI</text>
      </view>
      <text class="progress-title">正在生成专业报告</text>
      <progress-bar
        percent="{{generateProgress}}"
        step-text="{{generateStep}}"
        animated="{{true}}"
      />
      <text class="progress-hint">AI 正在分析您的比赛数据，预计需要 30-60 秒...</text>
    </view>
  </view>
</view>
